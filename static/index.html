<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ç°ä»£æ·±è‰²ä¸»é¢˜æ ·å¼ - ä»¿ç…§å‚è€ƒå›¾ç•Œé¢ */
        :root {
            --bg-primary: #1a1d23;
            --bg-secondary: #252932;
            --bg-tertiary: #2d3748;
            --bg-card: #323a46;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --accent-blue: #4299e1;
            --accent-purple: #805ad5;
            --border-color: #4a5568;
            --border-light: #3a4553;
        }
        
        /* æµ…è‰²ä¸»é¢˜æ ·å¼ */
        html:not(.dark) {
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-tertiary: #e2e8f0;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --accent-blue: #3182ce;
            --accent-purple: #6b46c1;
            --border-color: #cbd5e0;
            --border-light: #e2e8f0;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        /* å½“æœ‰å£çº¸æ—¶ï¼Œbodyã€htmlã€ä¾§è¾¹æ å’Œä¸»å†…å®¹åŒºèƒŒæ™¯åº”è¯¥é€æ˜ä»¥æ˜¾ç¤ºå£çº¸ */
        html.has-wallpaper,
        body.has-wallpaper {
            background: transparent !important;
            background-image: none !important;
        }
        
        /* æœ‰å£çº¸æ—¶ï¼Œä¾§è¾¹æ æ¢å¤åŸæ¥çš„æ ·å¼ï¼Œç¡®ä¿å†…å®¹æ¸…æ™°å¯è§ */
        body.has-wallpaper .sidebar {
            background: rgba(37, 41, 50, 0.90) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        html:not(.dark) body.has-wallpaper .sidebar {
            background: rgba(237, 242, 247, 0.95) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        /* ä¸»å†…å®¹åŒº - é€‚åº¦é€æ˜ï¼Œä¿æŒå£çº¸å¯è§ä½†ç¡®ä¿æ–‡å­—å¯è¯» */
        body.has-wallpaper .main-content {
            background: rgba(26, 29, 35, 0.75) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        html:not(.dark) body.has-wallpaper .main-content {
            background: rgba(247, 250, 252, 0.85) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        /* æœ‰å£çº¸æ—¶ï¼Œè¾“å…¥åŒºåŸŸæ›´ä¸é€æ˜ä»¥ç¡®ä¿è¾“å…¥æ¡†æ¸…æ™°å¯è§ */
        body.has-wallpaper .input-area {
            background: rgba(37, 41, 50, 0.90) !important;
            backdrop-filter: blur(2px) !important;
            border-top: 1px solid rgba(74, 85, 104, 0.4) !important;
        }
        
        body.has-wallpaper .input-container {
            background: rgba(50, 58, 70, 0.92) !important;
            backdrop-filter: blur(2px) !important;
            border: 1px solid rgba(58, 69, 83, 0.5) !important;
        }
        
        html:not(.dark) body.has-wallpaper .input-area {
            background: rgba(237, 242, 247, 0.95) !important;
            backdrop-filter: blur(2px) !important;
            border-top: 1px solid rgba(203, 213, 224, 0.4) !important;
        }
        
        html:not(.dark) body.has-wallpaper .input-container {
            background: rgba(255, 255, 255, 0.96) !important;
            border: 1px solid rgba(226, 232, 240, 0.5) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        /* æœ‰å£çº¸æ—¶ï¼ŒèŠå¤©æ¶ˆæ¯å¢åŠ èƒŒæ™¯ä¸é€æ˜åº¦ï¼Œç¡®ä¿æ–‡å­—æ¸…æ™°å¯è¯» */
        body.has-wallpaper .chat-message {
            background: rgba(50, 58, 70, 0.80) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        body.has-wallpaper .chat-message.user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.88), rgba(147, 51, 234, 0.80)) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
        }
        
        body.has-wallpaper .chat-message.assistant {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.85), rgba(59, 130, 246, 0.80)) !important;
            border: 1px solid rgba(147, 51, 234, 0.25) !important;
        }
        
        html:not(.dark) body.has-wallpaper .chat-message {
            background: rgba(255, 255, 255, 0.88) !important;
            backdrop-filter: blur(2px) !important;
        }
        
        html:not(.dark) body.has-wallpaper .chat-message.user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.75)) !important;
        }
        
        html:not(.dark) body.has-wallpaper .chat-message.assistant {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.80), rgba(59, 130, 246, 0.75)) !important;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            filter: none;
            z-index: -2;
            pointer-events: none;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: high-quality;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            pointer-events: none;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { 
            background: var(--text-muted); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow-y: auto;
            transition: width 0.3s ease, min-width 0.3s ease;
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden;
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-toggle:hover {
            background: var(--accent-blue);
            color: white;
            transform: scale(1.05);
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            background: var(--bg-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .tab-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            flex: 1;
        }
        
        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }
        
        .tab-btn:hover:not(.active) {
            background: rgba(66, 153, 225, 0.1);
            color: var(--text-primary);
        }
        
        /* å¡ç‰‡é¢æ¿æ ·å¼ */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        
        .btn-success {
            background: #38a169;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        /* æœåŠ¡å•†é¡¹ç›®æ ·å¼ */
        .provider-item {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .provider-item:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .evaluation-process {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.03), rgba(147, 51, 234, 0.02));
            border: 1px solid rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            backdrop-filter: blur(10px);
        }

        /* ç®€è¦æ¨¡å¼ï¼šåªæ˜¾ç¤ºç®€æ´çš„è¡Œ */
        .evaluation-process.simple {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .evaluation-process.simple .process-line {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
            padding: 4px 0;
        }

        .evaluation-process.simple .process-block {
            display: none !important; /* ç®€è¦æ¨¡å¼ä¸‹éšè—è¯¦ç»†å— */
        }

        /* è¯¦ç»†æ¨¡å¼ï¼šæ˜¾ç¤ºå®Œæ•´çš„å—çŠ¶å†…å®¹ */
        .evaluation-process.detailed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .evaluation-process.detailed .process-line {
            display: none !important; /* è¯¦ç»†æ¨¡å¼ä¸‹éšè—ç®€æ´è¡Œ */
        }

        .evaluation-process .process-block {
            background: rgba(50, 58, 70, 0.55);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
        }

        .evaluation-process .process-block h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #c4c9d4;
        }

        .evaluation-process .process-text {
            white-space: pre-wrap;
            font-size: 13px;
            color: #e2e8f0;
            line-height: 1.5;
        }

.evaluation-process .process-line strong {
    color: #cbd5f5;
}

.process-toggle:hover {
    background: rgba(66, 153, 225, 0.1);
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

.process-wrapper {
    margin-top: 8px;
}

.final-answer {
    border-left: 3px solid var(--accent-purple);
    padding-left: 12px;
    margin-bottom: 8px;
}

.evaluation-status {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.evaluation-status.completed {
    animation: none;
    opacity: 1;
}        /* æœåŠ¡å•†é¡¹ç›®æ ·å¼ */
        .provider-item {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .provider-item:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }
        
        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-message {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent-purple);
            animation: slideInUp 0.4s ease-out;
            max-width: 80%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .chat-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 16px;
            pointer-events: none;
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));
            border-left-color: var(--accent-blue);
            margin-left: auto;
            margin-right: 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .chat-message.user::after {
            content: 'ğŸ‘¤';
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 14px;
            opacity: 0.6;
        }
        
        .chat-message.assistant {
            margin-right: auto;
            margin-left: 0;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.08), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(147, 51, 234, 0.15);
        }
        
        .chat-message.assistant::after {
            content: 'ğŸ¤–';
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 14px;
            opacity: 0.6;
        }
        
        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* AIå›ç­”æ“ä½œæŒ‰é’®æ ·å¼ */
        .answer-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 8px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.3s forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: rgba(55, 65, 81, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.6);
            border-radius: 6px;
            color: #d1d5db;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .action-btn:hover {
            background: rgba(75, 85, 99, 0.9);
            border-color: rgba(156, 163, 175, 0.8);
            color: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .action-btn.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            color: #93c5fd;
        }
        
        .action-btn.primary:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.6);
            color: #dbeafe;
        }
        
        .action-btn.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.6);
            color: #fecaca;
        }
        
        .action-btn-icon {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
        }
        
        .action-btn-text {
            white-space: nowrap;
        }
        
        .action-divider {
            width: 1px;
            height: 16px;
            background: rgba(75, 85, 99, 0.6);
            margin: 0 2px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .answer-actions {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .action-btn {
                padding: 4px 6px;
                font-size: 10px;
            }
            
            .action-btn-text {
                display: none;
            }
            
            .action-btn-icon {
                width: 14px;
                height: 14px;
            }
            
            .action-divider {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .answer-actions {
                justify-content: center;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        .app-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .version-info {
            color: var(--text-muted);
            font-size: 12px;
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1000;
        }
        
        .theme-toggle:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
        }
        
        .input-container {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px 8px 8px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* å¿«é€Ÿæ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .quick-mode-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
        }
        
        .quick-mode-toggle:hover {
            background: rgba(147, 51, 234, 0.15);
            border-color: rgba(147, 51, 234, 0.4);
            transform: translateY(-1px);
        }
        
        .mode-icon {
            font-size: 12px;
        }
        
        .mode-text {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        
        .mode-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6b7280;
            transition: all 0.3s ease;
        }
        
        .mode-indicator.active {
            background: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        
        .quick-mode-toggle.disabled {
            background: rgba(107, 114, 128, 0.1);
            border-color: rgba(107, 114, 128, 0.3);
        }
        
        .quick-mode-toggle.disabled .mode-indicator {
            background: #6b7280;
            box-shadow: none;
        }

        .toolbar-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toolbar-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .toolbar-btn.active {
            color: var(--accent-blue);
            background: rgba(66, 153, 225, 0.1);
        }
        
        .toolbar-btn.active:hover {
            color: var(--accent-blue);
            background: rgba(66, 153, 225, 0.2);
        }
        
        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            resize: none;
            outline: none;
            min-height: 40px;
            max-height: 200px;
            padding: 8px;
            font-size: 1rem;
        }
        
        .message-input::placeholder {
            color: var(--text-muted);
        }
        
        .submit-btn-wrapper {
            display: flex;
            justify-content: flex-end;
            padding-top: 8px;
        }

        #submit-btn, #stop-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        #submit-btn:hover {
            background: #3182ce;
        }
        #submit-btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
        }
        #stop-btn {
            background: #ef4444;
            margin-left: 8px;
        }
        #stop-btn:hover {
            background: #dc2626;
        }
        #stop-btn.hidden {
            display: none;
        }

        /* éšè—å†…å®¹ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* é€‰æ‹©æ¡†æ ·å¼ */
        select.form-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 32px;
        }
        
        /* å¤é€‰æ¡†æ ·å¼ */
        .model-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .model-checkbox::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .model-checkbox:hover {
            background: var(--bg-card);
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        
        .model-checkbox:hover::before {
            left: 100%;
        }
        
        .model-checkbox input[type="checkbox"] {
            margin-right: 12px;
            accent-color: var(--accent-blue);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .model-checkbox input[type="checkbox"]:checked + span {
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .model-checkbox span {
            font-size: 13px;
            transition: all 0.2s ease;
            z-index: 1;
            position: relative;
        }
        
        /* è®¾ç½®åŒºåŸŸä¸­çš„æœåŠ¡å•†å¡ç‰‡ */
        .provider-item-settings {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
        }
        
        .provider-item-settings:hover {
            border-color: var(--accent-blue);
            background: rgba(66, 153, 225, 0.05);
        }
        
        /* ç´§å‡‘æ¨¡å¼ */
        body.compact .panel { padding: 12px; }
        body.compact .settings-item { padding: 10px 0; }
        body.compact .chat-message { padding: 12px; margin-bottom: 12px; }
        body.compact .settings-group { margin-bottom: 20px; }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-message {
                max-width: 90%;
            }
            
            .sidebar-toggle {
                left: 10px !important;
            }
        }
        
        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .settings-btn:hover {
            background: var(--accent-blue);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }
        
        .settings-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .settings-dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            height: 80%;
            max-height: 600px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .settings-sidebar {
            width: 240px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .settings-nav-item {
            padding: 10px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-nav-item:hover {
            background: rgba(66, 153, 225, 0.1);
            color: var(--text-primary);
        }
        
        .settings-nav-item.active {
            background: rgba(66, 153, 225, 0.15);
            color: var(--accent-blue);
            border-left-color: var(--accent-blue);
        }
        
        .settings-section {
            display: none;
        }
        
        .settings-section.active {
            display: block;
        }
        
        .settings-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .settings-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .settings-group {
            margin-bottom: 30px;
        }
        
        .settings-group-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-item-info {
            flex: 1;
        }
        
        .settings-item-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .settings-item-desc {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .settings-toggle {
            width: 44px;
            height: 24px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-toggle.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .settings-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .settings-toggle.active::after {
            transform: translateX(20px);
        }
        
        /* äº’è¯„æ¨¡å¼ä¸“ç”¨æ ·å¼ */
        .peer-review-setting {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
        }
        
        .peer-review-setting::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #9333ea);
            opacity: 0.6;
        }
        
        .mode-icon {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .mode-badge {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            transition: all 0.3s ease;
        }
        
        .mode-desc {
            font-size: 13px;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        /* äº’è¯„æ¨¡å¼å…³é—­æ—¶çš„æ ·å¼ */
        .peer-review-setting.disabled .mode-badge {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        
        .peer-review-setting.disabled::before {
            background: linear-gradient(90deg, #6b7280, #4b5563);
        }
        
        .settings-select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            min-width: 150px;
            cursor: pointer;
        }
        
        .settings-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .settings-close:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        /* ä¾§è¾¹æ æ‰‹é£ç´ */
        .settings-accordion .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .settings-accordion .accordion-header:hover {
            background: var(--bg-card);
        }
        .settings-accordion .accordion-header .chevron {
            transition: transform 0.2s;
        }
        .settings-accordion .accordion-header.active .chevron {
            transform: rotate(180deg);
        }
        .settings-accordion .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: var(--bg-primary);
            border-radius: 0 0 6px 6px;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sidebar-item:hover {
            background: var(--bg-secondary);
        }
        .sidebar-item.active {
            background: var(--accent-blue);
            color: white;
        }
        .sidebar-item .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>
    <div id="debug-status" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-900 text-white text-xs px-4 py-2 rounded shadow z-50">
        JavaScript æ­£åœ¨åˆå§‹åŒ–...
    </div>
    <div class="flex h-screen">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar w-80 flex-shrink-0" id="sidebar">
            <div class="p-6 h-full flex flex-col">
                <!-- æ ‡é¢˜å’Œå†å²è®°å½•æŒ‰é’® -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="app-title">AIå·¥å‚</h1>
                        <p class="version-info">v15.0 - Linus Edition</p>
                    </div>
                    <div class="relative">
                        <button id="history-btn" class="p-2 rounded-md hover:bg-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                        <div id="history-popup" class="hidden absolute top-full right-0 mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-lg z-20">
                            <div class="p-3 border-b border-gray-700 font-semibold">å†å²è®°å½•</div>
                            <div id="chat-history" class="p-2 max-h-80 overflow-y-auto">
                                <div class="text-sm text-gray-400 text-center py-4">æš‚æ— å†å²è®°å½•</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯æŠ˜å çš„è®¾ç½®åŒºåŸŸ -->
                <div class="flex-1 overflow-y-auto -mr-6 pr-4">
                    <div class="space-y-4">
                        <div class="settings-accordion">
                            <button class="accordion-header">
                                <span>ğŸ¤– æ¨¡å‹é…ç½®</span>
                                <svg class="w-4 h-4 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="accordion-content">
                                <div id="model-list-sidebar" class="space-y-2 p-2"></div>
                                <button id="manage-providers-btn" class="btn-secondary text-xs w-full mt-2">ç®¡ç†æœåŠ¡å•†</button>
                            </div>
                        </div>
                        <div class="settings-accordion">
                            <button class="accordion-header">
                                <span>ğŸ’¬ æç¤ºè¯ç®¡ç†</span>
                                <svg class="w-4 h-4 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="accordion-content">
                                <div id="prompt-list-sidebar" class="space-y-2 p-2"></div>
                                <button id="manage-prompts-btn" class="btn-secondary text-xs w-full mt-2">ç®¡ç†æç¤ºè¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®¾ç½®æŒ‰é’® -->
            <button class="settings-btn" id="settings-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span data-i18n="settings">è®¾ç½®</span>
            </button>
        </aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content flex-1">
            <!-- ä¾§è¾¹æ æ”¶èµ·æŒ‰é’® -->
            <button class="sidebar-toggle" id="sidebar-toggle">
                <svg id="sidebar-toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            
            <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
            <button id="theme-toggle" class="theme-toggle">
                ğŸŒ™ æš—è‰²
            </button>
            
            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="chat-area" id="chat-log">
                <!-- ç¤ºä¾‹å¯¹è¯ -->
                <div class="chat-message user">
                    <div class="font-medium mb-1">ç”¨æˆ·</div>
                    <div>é˜¿é‡Œäº‘ä¸åä¸ºäº‘å“ªä¸ªå¯¹ç”¨æˆ·å‹å¥½ï¼Ÿ</div>
                </div>
                
                <div class="chat-message assistant">
                    <div class="font-medium mb-1 text-purple-400">AIåŠ©æ‰‹</div>
                    <div class="mb-3">
                        è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯å¾ˆå¤šæ–°ç”¨æˆ·åœ¨é€‰å‹æ—¶é¦–å…ˆè€ƒè™‘çš„ã€‚è¦å›ç­”"é˜¿é‡Œäº‘å’Œåä¸ºäº‘å“ªä¸ªå¯¹ç”¨æˆ·æ›´å‹å¥½"ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸åŒç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå› ä¸º"å‹å¥½"çš„å®šä¹‰å› äººè€Œå¼‚ã€‚
                    </div>
                    <div class="mb-3">
                        <strong>æ€»çš„æ¥è¯´ï¼šä¸¤è€…éƒ½éå¸¸å‡ºè‰²ï¼Œä½†ä¾§é‡ç‚¹ä¸åŒã€‚é˜¿é‡Œäº‘å¯¹å¼€å‘è€…ã€åˆåˆ›ä¼ä¸šå’Œäº’è”ç½‘ä¸šåŠ¡æ›´å‹å¥½ï¼›åä¸ºäº‘å¯¹ä¼ ç»Ÿä¼ä¸šã€æ”¿ä¼å®¢æˆ·å’Œæœ‰å¼ºçƒˆå›½äº§åŒ–éœ€æ±‚çš„ä¼ä¸šæ›´å‹å¥½ã€‚</strong>
                    </div>
                    <div class="mb-3">ä¸‹é¢æˆ‘ä»å‡ ä¸ªæ ¸å¿ƒç»´åº¦è¿›è¡Œè¯¦ç»†å¯¹æ¯”ï¼š</div>
                    
                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">### 1. äº§å“æ˜“ç”¨æ€§ä¸æ§åˆ¶å°</h4>
                        <div class="ml-4 space-y-2">
                            <div><strong>â€¢ é˜¿é‡Œäº‘ï¼š</strong></div>
                            <div><strong>â€¢ ä¼˜ç‚¹ï¼š</strong> èµ·æ­¥æ—©ã€æ§åˆ¶å°ç»è¿‡å¤šæ¬¡ä¼˜åŒ–ï¼Œç•Œé¢ç›¸å¯¹æ›´ç°ä»£åŒ–ã€æ›´ç®€æ´ã€‚åŠŸèƒ½é€»è¾‘ç›¸å¯¹è´´è¿‘å¼€å‘è€…çš„æ€ç»´ä¹ æƒ¯ï¼Œæ–‡æ¡£å’Œå¼•å¯¼éå¸¸å®Œå–„ã€‚</div>
                            <div><strong>â€¢ å…·ä½“ä½“éªŒï¼š</strong> ä»¥åˆ›å»ºäº‘æœåŠ¡å™¨ï¼ˆECSï¼‰ä¸ºä¾‹ï¼Œé˜¿é‡Œäº‘æä¾›ä¸€é”®è´­ä¹°å’Œå‘å¯¼å¼é…ç½®ï¼Œæµç¨‹ç›´è§‚ï¼Œé€‚åˆå¿«é€Ÿéƒ¨ç½²ã€‚ä¾‹å¦‚ï¼Œåœ¨é…ç½®ç½‘ç»œæ—¶ï¼Œé»˜è®¤é€‰é¡¹ä¼˜åŒ–äº†å¸¸è§åœºæ™¯ï¼Œå‡å°‘äº†æ–°æ‰‹å›°æƒ‘ã€‚</div>
                            <div><strong>â€¢ ç¼ºç‚¹ï¼š</strong> äº§å“çº¿æå…¶åºå¤§ï¼Œæ–°æ‰‹å¯èƒ½ä¼šåœ¨ä¼—å¤šäº§å“ä¸­æ„Ÿåˆ°å›°æƒ‘ã€‚éƒ¨åˆ†è€ç‰ˆæ§åˆ¶å°å’Œæ–°ç‰ˆæ§åˆ¶å°ä½“éªŒä¸ç»Ÿä¸€ã€‚</div>
                        </div>
                        
                        <div class="ml-4 mt-4 space-y-2">
                            <div><strong>â€¢ åä¸ºäº‘ï¼š</strong></div>
                            <div><strong>â€¢ ä¼˜ç‚¹ï¼š</strong> æ§åˆ¶å°è¿‘å¹´æ¥è¿›æ­¥å·¨å¤§ï¼Œç•Œé¢æ¸…æ™°ï¼Œå¸ƒå±€è§„æ•´ã€‚åœ¨æ“ä½œæµç¨‹ä¸Šï¼Œæ›´åå‘äºä¼ä¸šçº§çš„ä¸¥è°¨å’Œæ­¥éª¤åŒ–ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn" id="new-chat-btn" title="æ–°å¯¹è¯">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button class="toolbar-btn" id="select-image-btn" title="ä¸Šä¼ å›¾ç‰‡">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                            <button type="button" class="toolbar-btn" id="toggle-search-btn" title="ç½‘ç»œæœç´¢ (å…³é—­)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                            <input type="file" id="image-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="toolbar-group">
                            <div class="quick-mode-toggle" id="quick-mode-toggle">
                                <span class="mode-icon">ğŸ¤–</span>
                                <span class="mode-text" id="quick-mode-text">äº’è¯„</span>
                                <div class="mode-indicator active" id="mode-indicator"></div>
                            </div>
                            <span class="text-xs text-gray-500" id="token-counter">0/2000</span>
                        </div>
                    </div>
                    <textarea 
                        class="message-input" 
                        placeholder="åœ¨è¿™é‡Œè¾“å…¥æ¶ˆæ¯, æŒ‰ Enter å‘é€"
                        rows="1"
                        id="question-input"
                    ></textarea>
                    <div class="submit-btn-wrapper">
                        <button id="submit-btn" disabled>
                            <span id="submit-icon">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                            </span>
                            <svg id="loading-spinner" class="hidden w-5 h-5 animate-spin text-blue-400" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                        </button>
                        <button id="stop-btn" class="hidden" title="åœæ­¢ç”Ÿæˆ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- æ‰‹åŠ¨ç½‘ç»œæœç´¢é¢æ¿å·²å–æ¶ˆï¼Œæ”¹ç”± AI è‡ªåŠ¨æ ¹æ®éœ€è¦è§¦å‘å®æ—¶æ£€ç´¢ -->
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-dialog">
            <button class="settings-close" id="settings-close">&times;</button>
            
            <!-- å·¦ä¾§å¯¼èˆª -->
            <div class="settings-sidebar">
                <div class="settings-nav-item active" data-section="general">
                    <span>âš™ï¸</span>
                    <span data-i18n="preference">åå¥½</span>
                </div>
                <div class="settings-nav-item" data-section="appearance">
                    <span>ğŸ¨</span>
                    <span data-i18n="appearance">å¤–è§‚</span>
                </div>
                <div class="settings-nav-item" data-section="models">
                    <span>ğŸ¤–</span>
                    <span data-i18n="models">æ¨¡å‹</span>
                </div>
                <div class="settings-nav-item" data-section="prompts">
                    <span>ğŸ’¬</span>
                    <span data-i18n="prompts">æç¤ºè¯</span>
                </div>
                <div class="settings-nav-item" data-section="advanced">
                    <span>ğŸ”§</span>
                    <span data-i18n="advanced">é«˜çº§</span>
                </div>
            </div>
            
            <!-- å³ä¾§å†…å®¹ -->
            <div class="settings-content">
                <!-- åå¥½è®¾ç½® -->
                <div class="settings-section active" id="general-section">
                    <h2 class="settings-title" data-i18n="preference">åå¥½</h2>
                    <p class="settings-subtitle" data-i18n="basicSettings">åŸºç¡€è®¾ç½®ï¼Œä¿æŒç®€å•ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="interface">ç•Œé¢</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="theme">ä¸»é¢˜</div>
                            </div>
                            <select class="settings-select" id="theme-mode-select">
                                <option value="dark">æ·±è‰²</option>
                                <option value="light">æµ…è‰²</option>
                            </select>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="language">è¯­è¨€</div>
                            </div>
                            <select class="settings-select" id="language-select">
                                <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="behavior">è¡Œä¸º</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="autoSave">è‡ªåŠ¨ä¿å­˜å¯¹è¯</div>
                            </div>
                            <div class="settings-toggle active" data-setting="auto-save"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="showTimestamps">æ˜¾ç¤ºæ—¶é—´æˆ³</div>
                            </div>
                            <div class="settings-toggle active" data-setting="timestamps"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="soundNotification">å£°éŸ³æç¤º</div>
                            </div>
                            <div class="settings-toggle" data-setting="sound"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å¤–è§‚è®¾ç½® -->
                <div class="settings-section" id="appearance-section">
                    <h2 class="settings-title" data-i18n="appearance">å¤–è§‚</h2>
                    <p class="settings-subtitle" data-i18n="lessIsMore">å°‘å³æ˜¯å¤šã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="display">æ˜¾ç¤º</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="fontSize">å­—ä½“å¤§å°</div>
                            </div>
                            <select class="settings-select" id="font-size-select">
                                <option value="14">å° (14px)</option>
                                <option value="16" selected>ä¸­ (16px)</option>
                                <option value="18">å¤§ (18px)</option>
                            </select>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="compactMode">ç´§å‡‘æ¨¡å¼</div>
                            </div>
                            <div class="settings-toggle" data-setting="compact"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="defaultSidebarOpen">é»˜è®¤å±•å¼€ä¾§è¾¹æ </div>
                            </div>
                            <div class="settings-toggle active" data-setting="sidebar-open"></div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="wallpaperSettings">å£çº¸è®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <input type="file" id="wallpaper-upload" accept="image/*" style="display:none">
                                <button id="wallpaper-upload-btn" class="btn-primary text-sm">ä¸Šä¼ å£çº¸</button>
                                <button id="reset-wallpaper-btn" class="btn-danger text-sm ml-2">æ¢å¤é»˜è®¤</button>
                                <div id="wallpaper-status" class="text-xs mt-2 text-gray-400"></div>
                            </div>
                            
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title" data-i18n="opacity">é€æ˜åº¦</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="10" max="100" value="100" step="1" id="wallpaper-opacity" class="flex-1">
                                    <span id="wallpaper-opacity-label" class="text-sm w-12 text-right">100%</span>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title" data-i18n="brightness">äº®åº¦</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="20" max="200" value="100" step="1" id="wallpaper-brightness" class="flex-1">
                                    <span id="wallpaper-brightness-label" class="text-sm w-12 text-right">100%</span>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title" data-i18n="blur">æ¨¡ç³Šç¨‹åº¦</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="0" max="20" value="0" step="1" id="wallpaper-blur" class="flex-1">
                                    <span id="wallpaper-blur-label" class="text-sm w-12 text-right">0px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¯­è¨€ä¸æ—¶é—´è®¾ç½® -->
                <div class="settings-section" id="language-section">
                    <h2 class="settings-title">è¯­è¨€</h2>
                    <p class="settings-subtitle">è¿™éƒ¨åˆ†å·²ç»åˆå¹¶åˆ°"åå¥½"ä¸­äº†ã€‚</p>
                </div>
                
                <!-- AIæ¨¡å‹é…ç½® -->
                <div class="settings-section" id="models-section">
                    <h2 class="settings-title" data-i18n="modelConfig">æ¨¡å‹é…ç½®</h2>
                    <p class="settings-subtitle" data-i18n="manageAIServices">ç®¡ç†AIæœåŠ¡å•†åŠæ¨¡å‹ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="serviceProviderList">æœåŠ¡å•†åˆ—è¡¨</h3>
                        <div id="provider-list-settings" class="space-y-3 mb-6"></div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="addNewProvider">æ·»åŠ æ–°æœåŠ¡å•†</h3>
                        <form id="add-provider-form" class="space-y-3 mb-6">
                            <input name="name" required class="form-input" placeholder="æœåŠ¡å•†åç§°" style="width: 100%;">
                            <select name="type" required class="form-input" style="width: 100%;">
                                <option value="" disabled selected>ç±»å‹</option>
                                <option value="OpenAI">OpenAI</option>
                                <option value="Gemini">Gemini</option>
                            </select>
                            <input name="api_key" type="password" required class="form-input" placeholder="API Key" style="width: 100%;">
                            <input name="api_base" class="form-input" placeholder="Base URL (OpenAIå¿…å¡«)" style="width: 100%;">
                            <input name="models" required class="form-input" placeholder="æ¨¡å‹åˆ—è¡¨ (é€—å·åˆ†éš”)" style="width: 100%;">
                            <button type="submit" class="btn-success" style="width: 100%;">æ·»åŠ </button>
                        </form>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="modelSelection">æ¨¡å‹é€‰æ‹©</h3>
                        <div id="model-list-settings" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>

                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="translationSettings">ç¿»è¯‘è®¾ç½®</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="translationTargetLanguage">ç¿»è¯‘ç›®æ ‡è¯­è¨€</div>
                                <div class="settings-item-desc" data-i18n="translationTargetDesc">ç¿»è¯‘æŒ‰é’®é»˜è®¤è¾“å‡ºçš„è¯­è¨€ã€‚</div>
                            </div>
                            <select class="settings-select" id="translation-target-select"></select>
                        </div>
                    </div>
                </div>
                
                <!-- æç¤ºè¯ç®¡ç† -->
                <div class="settings-section" id="prompts-section">
                    <h2 class="settings-title" data-i18n="prompts">æç¤ºè¯</h2>
                    <p class="settings-subtitle" data-i18n="managePromptTemplates">ç®¡ç†å¯¹è¯æç¤ºè¯æ¨¡æ¿ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="promptList">æç¤ºè¯åˆ—è¡¨</h3>
                        <div id="prompt-list-settings" class="space-y-3 mb-6"></div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="addNewPrompt">æ·»åŠ æ–°æç¤ºè¯</h3>
                        <form id="add-prompt-form" class="space-y-3">
                            <input name="name_zh" required class="form-input" placeholder="ä¸­æ–‡åç§°" style="width: 100%;">
                            <input name="name_en" required class="form-input" placeholder="English Name" style="width: 100%;">
                            <textarea name="critique_zh" required class="form-input h-16" placeholder="è¯„å®¡æç¤ºè¯ï¼ˆä¸­æ–‡ï¼‰" style="width: 100%;"></textarea>
                            <textarea name="critique_en" required class="form-input h-16" placeholder="Critique Prompt (English)" style="width: 100%;"></textarea>
                            <textarea name="revision_zh" required class="form-input h-16" placeholder="ä¿®è®¢æç¤ºè¯ï¼ˆä¸­æ–‡ï¼‰" style="width: 100%;"></textarea>
                            <textarea name="revision_en" required class="form-input h-16" placeholder="Revision Prompt (English)" style="width: 100%;"></textarea>
                            <button type="submit" class="btn-success" style="width: 100%;">æ·»åŠ </button>
                        </form>
                    </div>
                </div>
                
                <!-- é«˜çº§è®¾ç½® -->
                <div class="settings-section" id="advanced-section">
                    <h2 class="settings-title" data-i18n="advanced">é«˜çº§</h2>
                    <p class="settings-subtitle" data-i18n="advancedSettings">ä»…åœ¨ä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆæ—¶ä½¿ç”¨ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title">ğŸ” ç½‘ç»œæœç´¢ (SearXNG)</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title">å¯ç”¨ç½‘ç»œæœç´¢</div>
                                <div class="settings-item-desc">å¯ç”¨åå¯ä»¥ä½¿ç”¨ç½‘ç»œæœç´¢åŠŸèƒ½</div>
                            </div>
                            <div class="settings-toggle active" data-setting="searxng-enabled">
                                <div class="toggle-slider">
                                    <span class="toggle-text">ON</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title">SearXNG æ¥å£åœ°å€</div>
                                <div class="settings-item-desc">SearXNG æœåŠ¡å™¨åœ°å€ï¼Œä¾‹å¦‚: https://searx.be</div>
                            </div>
                            <input type="text" id="searxng-url-input" class="form-input" placeholder="https://searx.be" style="width: 100%; max-width: 400px;">
                        </div>
                        <button id="save-searxng-config-btn" class="btn-primary text-sm mt-2">ä¿å­˜é…ç½®</button>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="debug">è°ƒè¯•</h3>
                        <div class="settings-item peer-review-setting">
                            <div class="settings-item-info">
                                <div class="settings-item-title">
                                    <span class="mode-icon">ğŸ¤–</span>
                                    AIäº’è¯„æ¨¡å¼
                                    <span class="mode-badge" id="peer-review-badge">å¤šæ¨¡å‹äº’è¯„</span>
                                </div>
                                <div class="settings-item-desc">
                                    <span class="mode-desc" id="peer-review-desc">
                                        å¯ç”¨ï¼šå¤šä¸ªæ¨¡å‹äº’ç›¸è¯„å®¡ï¼Œäº§ç”Ÿæ›´ä¼˜è´¨çš„ç­”æ¡ˆ
                                    </span>
                                </div>
                            </div>
                            <div class="settings-toggle active" data-setting="peer-review-mode">
                                <div class="toggle-slider">
                                    <span class="toggle-text">ON</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="debugMode">è°ƒè¯•æ¨¡å¼</div>
                            </div>
                            <div class="settings-toggle" data-setting="debug"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="apiLog">APIæ—¥å¿—</div>
                            </div>
                            <div class="settings-toggle" data-setting="api-log"></div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="evaluationDisplayGroup">äº’è¯„å±•ç¤º</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="evaluationDisplay">äº’è¯„è¿‡ç¨‹å±•ç¤ºç¨‹åº¦</div>
                                <div class="settings-item-desc" data-i18n="evaluationDisplayDesc">é€‰æ‹©å‘ç”¨æˆ·å±•ç¤ºçš„æ¨¡å‹äº’è¯„ç»†èŠ‚å±‚çº§ã€‚</div>
                            </div>
                            <select class="settings-select" id="evaluation-display-select">
                                <option value="simple">ç®€è¦æ­¥éª¤ï¼ˆé»˜è®¤ï¼‰</option>
                                <option value="detailed">å®Œæ•´è¿‡ç¨‹</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="performance">æ€§èƒ½</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="requestTimeout">è¯·æ±‚è¶…æ—¶ (ç§’)</div>
                            </div>
                            <input type="number" class="settings-select" id="timeout-input" value="30" min="5" max="120" style="width: 80px;">
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="maxRetry">æœ€å¤§é‡è¯•</div>
                            </div>
                            <input type="number" class="settings-select" id="retry-input" value="2" min="0" max="5" style="width: 80px;">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="data">æ•°æ®</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="historyRetention">å†å²ä¿ç•™ (å¤©)</div>
                            </div>
                            <select class="settings-select" id="retention-select">
                                <option value="7">7</option>
                                <option value="30" selected>30</option>
                                <option value="90">90</option>
                                <option value="-1">æ°¸ä¹…</option>
                            </select>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title">æ“ä½œ</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-primary text-xs" id="export-btn">å¯¼å‡º</button>
                                <button class="btn-danger text-xs" id="clear-btn">æ¸…é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº’è¯„è¿‡ç¨‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="details-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center">
        <div class="relative w-11/12 max-w-4xl max-h-[80vh] overflow-y-auto bg-gray-900 border border-gray-700 rounded-xl shadow-2xl p-6">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-gray-100">äº’è¯„è¯¦æƒ…</h3>
            <div id="process-details-container" class="space-y-4 text-sm text-gray-200"></div>
        </div>
    </div>
    
    <script>
        // å…¨å±€æ‡’åŠ è½½å ä½ä¸å»¶è¿ŸåŠ è½½å™¨
        (function(){
            const placeholder = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><rect width="100%" height="100%" fill="#2d3748"/></svg>');

            function deferDispatch(el, name='lazyload'){
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(()=> el.dispatchEvent(new Event(name)));
                } else {
                    setTimeout(()=> el.dispatchEvent(new Event(name)), 50);
                }
            }

            function loadImage(img){
                if (img.dataset.src) img.src = img.dataset.src;
                if (img.dataset.srcset) img.srcset = img.dataset.srcset;
                img.removeAttribute('data-src');
                img.removeAttribute('data-srcset');
                img.addEventListener('load', ()=> deferDispatch(img), { once: true });
            }

            function loadBg(el){
                const url = el.dataset.bg;
                if (!url) return;
                el.style.backgroundImage = url;
                delete el.dataset.bg;
                deferDispatch(el);
            }

            function prepare(){
                // å¤„ç† <img>ï¼šä¿ç•™çœŸå®åœ°å€åˆ° data-srcï¼Œä½¿ç”¨å ä½ç¬¦ï¼Œå¹¶ç¡®ä¿ loading=lazy
                document.querySelectorAll('img').forEach(img=>{
                    try {
                        if (img.getAttribute('loading') !== 'lazy') img.setAttribute('loading','lazy');
                        if (!img.dataset.src) {
                            const src = img.getAttribute('src');
                            const srcset = img.getAttribute('srcset');
                            if (src) {
                                img.dataset.src = src;
                                img.src = placeholder;
                            }
                            if (srcset) {
                                img.dataset.srcset = srcset;
                                img.removeAttribute('srcset');
                            }
                        }
                    } catch(e){/* defensive */}
                });

                // å¤„ç†å†…è” background-image æˆ–è€…å·²æœ‰ data-bg
                document.querySelectorAll('[data-bg], [style*="background-image"]').forEach(el=>{
                    try {
                        if (!el.dataset.bg) {
                            const style = el.getAttribute('style') || '';
                            const m = style.match(/background-image\s*:\s*url\(([^)]+)\)/i);
                            if (m) {
                                const url = m[1].trim().replace(/^['"]|['"]$/g,'');
                                el.dataset.bg = `url('${url}')`;
                                el.style.backgroundImage = `url('${placeholder}')`;
                            }
                        } else {
                            // å·²æœ‰ data-bgï¼Œå…ˆæ˜¾ç¤ºå ä½
                            el.style.backgroundImage = `url('${placeholder}')`;
                        }
                    } catch(e){/* defensive */}
                });

                // è§‚å¯Ÿå¹¶åŠ è½½
                const io = new IntersectionObserver((entries, obs)=>{
                    entries.forEach(entry=>{
                        if (!entry.isIntersecting) return;
                        const t = entry.target;
                        if (t.tagName === 'IMG') {
                            loadImage(t);
                        } else {
                            loadBg(t);
                        }
                        obs.unobserve(t);
                    });
                }, { rootMargin: '200px' });

                document.querySelectorAll('img[data-src], [data-bg]').forEach(el=> io.observe(el));
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', prepare);
            else prepare();
        })();
    </script>
    <script src="/static/script.js?v=20251103030300"></script>
    <script>
        // è®¾ç½®ç³»ç»Ÿ - ä¿è¯åœ¨ä»»ä½•è°ƒç”¨ S ä¹‹å‰å®šä¹‰
        const S = {
            get: (k, d) => localStorage.getItem(k) || d,
            set: (k, v) => localStorage.setItem(k, v),
            apply: (k, fn) => fn(S.get(k))
        };

        // ç®€å•çš„æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // è®¾ç½®å½“å‰æ´»åŠ¨çŠ¶æ€
                btn.classList.add('active');
                const tabId = btn.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ - å®æ—¶åé¦ˆ
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            S.set('theme', isDark ? 'dark' : 'light');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) {
                themeBtn.textContent = isDark ? 'ğŸŒ™ æš—è‰²' : 'â˜€ï¸ äº®è‰²';
            }
            
            // æ›´æ–°ä¸»é¢˜æ¨¡å¼é€‰æ‹©å™¨
            const themeModeSelect = document.getElementById('theme-mode-select');
            if (themeModeSelect) {
                themeModeSelect.value = isDark ? 'dark' : 'light';
            }
            
            // é‡æ–°åº”ç”¨å£çº¸ï¼ˆå› ä¸ºä¸»é¢˜åˆ‡æ¢å¯èƒ½å½±å“èƒŒæ™¯ï¼‰
            applyBgImage();
        }
        
        // åˆå§‹åŒ–ä¸»é¢˜
        const savedTheme = S.get('theme', 'dark');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) themeBtn.textContent = 'ğŸŒ™ æš—è‰²';
        } else {
            document.documentElement.classList.remove('dark');
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) themeBtn.textContent = 'â˜€ï¸ äº®è‰²';
        }
        
        // ç¡®ä¿ä¸»é¢˜é€‰æ‹©å™¨åŒæ­¥
        const themeModeSelect = document.getElementById('theme-mode-select');
        if (themeModeSelect) {
            themeModeSelect.value = savedTheme;
        }
        
        // ç»‘å®šä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        const themeToggleBtn = document.getElementById('theme-toggle');
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', toggleTheme);
        }
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        const messageInput = document.getElementById('question-input');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        // è®¾ç½®æ¨¡æ€æ¡†åŠŸèƒ½
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsClose = document.getElementById('settings-close');
        
        // æ‰“å¼€è®¾ç½®
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });
        
        // å…³é—­è®¾ç½®
        settingsClose.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        });
        
        // è®¾ç½®å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.settings-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.settings-nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.settings-section').forEach(section => section.classList.remove('active'));
                
                // è®¾ç½®å½“å‰æ´»åŠ¨çŠ¶æ€
                item.classList.add('active');
                const sectionId = item.getAttribute('data-section') + '-section';
                document.getElementById(sectionId).classList.add('active');
            });
        });
        
        // SearXNG é…ç½®ç®¡ç†
        const searxngUrlInput = document.getElementById('searxng-url-input');
        const searxngEnabledToggle = document.querySelector('[data-setting="searxng-enabled"]');
        const saveSearxngConfigBtn = document.getElementById('save-searxng-config-btn');
        
        // åŠ è½½ SearXNG é…ç½®
        async function loadSearxngConfig() {
            try {
                const response = await fetch('/api/config/searxng');
                if (response.ok) {
                    const config = await response.json();
                    if (searxngUrlInput) searxngUrlInput.value = config.url || 'https://searx.be';
                    if (searxngEnabledToggle) {
                        if (config.enabled) {
                            searxngEnabledToggle.classList.add('active');
                        } else {
                            searxngEnabledToggle.classList.remove('active');
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ SearXNG é…ç½®å¤±è´¥:', error);
            }
        }
        
        // ä¿å­˜ SearXNG é…ç½®
        async function saveSearxngConfig() {
            const url = searxngUrlInput ? searxngUrlInput.value.trim() : 'https://searx.be';
            const enabled = searxngEnabledToggle ? searxngEnabledToggle.classList.contains('active') : true;
            
            if (!url) {
                alert('è¯·è¾“å…¥ SearXNG æ¥å£åœ°å€');
                return;
            }
            
            try {
                const response = await fetch('/api/config/searxng', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        enabled: enabled
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('é…ç½®å·²ä¿å­˜');
                    // é‡æ–°åŠ è½½é…ç½®
                    await loadSearxngConfig();
                } else {
                    const error = await response.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜ SearXNG é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ç»‘å®šäº‹ä»¶
        if (saveSearxngConfigBtn) {
            saveSearxngConfigBtn.addEventListener('click', saveSearxngConfig);
        }
        
        if (searxngEnabledToggle) {
            searxngEnabledToggle.addEventListener('click', () => {
                searxngEnabledToggle.classList.toggle('active');
            });
        }
        
        // æ‰“å¼€è®¾ç½®æ—¶åŠ è½½é…ç½®
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                loadSearxngConfig();
            });
        }
        
        // ä¾§è¾¹æ æ”¶èµ·åŠŸèƒ½
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebar', sidebar.classList.contains('collapsed') ? '0' : '1');
        });
        
        // æ¢å¤çŠ¶æ€
        if (localStorage.getItem('sidebar') === '0') sidebar.classList.add('collapsed');
        
        // ä¸»é¢˜
        const theme = document.getElementById('theme-mode-select');
        theme.value = S.get('theme', 'dark');
        theme.onchange = e => {
            const val = e.target.value;
            S.set('theme', val);
            if (val === 'dark') {
                document.documentElement.classList.add('dark');
                const themeBtn = document.getElementById('theme-toggle');
                if (themeBtn) themeBtn.textContent = 'ğŸŒ™ æš—è‰²';
            } else {
                document.documentElement.classList.remove('dark');
                const themeBtn = document.getElementById('theme-toggle');
                if (themeBtn) themeBtn.textContent = 'â˜€ï¸ äº®è‰²';
            }
        };
        // åˆå§‹åŒ–ä¸»é¢˜ï¼ˆå·²åœ¨ä¸Šé¢å¤„ç†ï¼‰
        
        // äº’è¯„å±•ç¤ºå±‚çº§
        const evaluationDisplaySelect = document.getElementById('evaluation-display-select');
        if (evaluationDisplaySelect) {
            evaluationDisplaySelect.value = S.get('evaluation_display', 'simple');
            evaluationDisplaySelect.onchange = (e) => {
                S.set('evaluation_display', e.target.value);
            };
        }

        // è¯­è¨€
        const lang = document.getElementById('language-select');
        lang.value = S.get('lang', 'zh');
        lang.onchange = e => {
            S.set('lang', e.target.value);
            applyLanguage(e.target.value);
        };
        
        // è¯­è¨€ç¿»è¯‘å­—å…¸
        const i18n = {
            zh: {
                newChat: 'æ–°å¯¹è¯',
                selectImage: 'é€‰æ‹©å›¾ç‰‡',
                placeholder: 'åœ¨è¿™é‡Œè¾“å…¥æ¶ˆæ¯, æŒ‰ Enter å‘é€',
                chatHistory: 'å†å²è®°å½•',
                noHistory: 'æš‚æ— å†å²è®°å½•',
                settings: 'è®¾ç½®',
                user: 'ç”¨æˆ·',
                aiAssistant: 'AIåŠ©æ‰‹',
                newChatStarted: 'æ–°å¯¹è¯å·²å¼€å§‹',
                selectModelFirst: 'è¯·å…ˆåœ¨ä¾§è¾¹æ é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¨¡å‹',
                imageUploaded: 'å·²ä¸Šä¼ å›¾ç‰‡ï¼š',
                aiFactory: 'AIå·¥å‚',
                preference: 'åå¥½',
                appearance: 'å¤–è§‚',
                models: 'æ¨¡å‹',
                prompts: 'æç¤ºè¯',
                advanced: 'é«˜çº§',
                theme: 'ä¸»é¢˜',
                language: 'è¯­è¨€',
                dark: 'æ·±è‰²',
                light: 'æµ…è‰²',
                simplifiedChinese: 'ç®€ä½“ä¸­æ–‡',
                english: 'English',
                autoSave: 'è‡ªåŠ¨ä¿å­˜å¯¹è¯',
                showTimestamps: 'æ˜¾ç¤ºæ—¶é—´æˆ³',
                soundNotification: 'å£°éŸ³æç¤º',
                fontSize: 'å­—ä½“å¤§å°',
                compactMode: 'ç´§å‡‘æ¨¡å¼',
                defaultSidebarOpen: 'é»˜è®¤å±•å¼€ä¾§è¾¹æ ',
                wallpaperSettings: 'å£çº¸è®¾ç½®',
                opacity: 'é€æ˜åº¦',
                brightness: 'äº®åº¦',
                blur: 'æ¨¡ç³Šç¨‹åº¦',
                uploadWallpaper: 'ä¸Šä¼ å£çº¸',
                resetWallpaper: 'æ¢å¤é»˜è®¤',
                evaluationDisplay: 'äº’è¯„è¿‡ç¨‹å±•ç¤ºç¨‹åº¦',
                simpleSteps: 'ç®€è¦æ­¥éª¤ï¼ˆé»˜è®¤ï¼‰',
                fullProcess: 'å®Œæ•´è¿‡ç¨‹',
                debugMode: 'è°ƒè¯•æ¨¡å¼',
                apiLog: 'APIæ—¥å¿—',
                requestTimeout: 'è¯·æ±‚è¶…æ—¶ (ç§’)',
                maxRetry: 'æœ€å¤§é‡è¯•',
                historyRetention: 'å†å²ä¿ç•™ (å¤©)',
                permanent: 'æ°¸ä¹…',
                export: 'å¯¼å‡º',
                clear: 'æ¸…é™¤',
                confirmClearAll: 'ç¡®å®šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ',
                evaluationStarted: 'äº’è¯„æµç¨‹å·²å¯åŠ¨ï¼Œæ­£åœ¨ç­‰å¾…ç»“æœ...',
                initialAnswerComplete: 'å·²å®Œæˆåˆå§‹ç­”æ¡ˆ',
                initialAnswer: 'åˆå§‹ç­”æ¡ˆ',
                critiqueComplete: 'å·²å®Œæˆå¯¹ {target} çš„è¯„åˆ†ï¼Œå¾—åˆ† {score}',
                critiqueFor: 'å¯¹ {target} çš„è¯„å®¡',
                totalScore: 'æ€»åˆ†',
                accuracy: 'å‡†ç¡®æ€§',
                completeness: 'å®Œæ•´æ€§',
                clarity: 'æ¸…æ™°æ€§',
                usefulness: 'å®ç”¨æ€§',
                revisionComplete: 'å·²æäº¤æ”¹è¿›ç­”æ¡ˆ',
                revisedAnswer: 'æ”¹è¿›ç­”æ¡ˆ',
                evaluationComplete: 'âœ“ äº’è¯„å®Œæˆï¼Œç­”æ¡ˆå·²ç”Ÿæˆ',
                answerGenerated: 'âœ“ ç­”æ¡ˆå·²ç”Ÿæˆ',
                finalAnswerGenerated: 'æœ€ç»ˆç­”æ¡ˆå·²ç”Ÿæˆã€‚',
                processingFailed: 'âŒ å¤„ç†å¤±è´¥',
                evaluationTerminated: 'äº’è¯„æµç¨‹å·²ç»ˆæ­¢ã€‚',
                requestFailed: 'è¯·æ±‚å¤±è´¥',
                showProcess: 'â–¼ æŸ¥çœ‹äº’è¯„è¿‡ç¨‹',
                hideProcess: 'â–² æ”¶èµ·äº’è¯„è¿‡ç¨‹',
                noContent: '(æ— å†…å®¹)',
                uploadingWallpaper: 'æ­£åœ¨å¤„ç†å£çº¸...',
                wallpaperUpdated: 'å£çº¸å·²æ›´æ–°ã€‚',
                wallpaperReset: 'å·²æ¢å¤é»˜è®¤å£çº¸ã€‚',
                wallpaperSaved: 'å½“å‰å·²ä½¿ç”¨è‡ªå®šä¹‰å£çº¸ã€‚',
                wallpaperDefault: 'ä½¿ç”¨é»˜è®¤å£çº¸ã€‚',
                wallpaperError: 'ä¿å­˜å¤±è´¥ï¼šæµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚',
                wallpaperFileError: 'æ–‡ä»¶è¯»å–å¤±è´¥ã€‚',
                wallpaperSizeError: 'å›¾ç‰‡å¤§äº 4MBï¼Œè¯·å‹ç¼©åå†è¯•ã€‚',
                confirmResetWallpaper: 'ç¡®å®šæ¢å¤é»˜è®¤å£çº¸ï¼Ÿ',
                noAnswerAvailable: 'æš‚æ— å¯ç”¨ç­”æ¡ˆ',
                evaluationDisplayGroup: 'äº’è¯„å±•ç¤º',
                evaluationDisplayDesc: 'é€‰æ‹©å‘ç”¨æˆ·å±•ç¤ºçš„æ¨¡å‹äº’è¯„ç»†èŠ‚å±‚çº§ã€‚',
                behavior: 'è¡Œä¸º',
                modelConfig: 'æ¨¡å‹é…ç½®',
                translationSettings: 'ç¿»è¯‘è®¾ç½®',
                translationTargetLanguage: 'ç¿»è¯‘ç›®æ ‡è¯­è¨€',
                translationTargetDesc: 'ç¿»è¯‘æŒ‰é’®é»˜è®¤è¾“å‡ºçš„è¯­è¨€ã€‚',
                translationOptionAuto: 'è‡ªåŠ¨ï¼ˆè·Ÿéšç•Œé¢è¯­è¨€ï¼‰',
                translationOptionZh: 'ç®€ä½“ä¸­æ–‡',
                translationOptionEn: 'English',
                translationOptionJa: 'æ—¥è¯­',
                translationOptionKo: 'éŸ©è¯­',
                translationOptionFr: 'æ³•è¯­',
                translationOptionDe: 'å¾·è¯­',
                promptManagement: 'æç¤ºè¯ç®¡ç†',
                manageProviders: 'ç®¡ç†æœåŠ¡å•†',
                managePrompts: 'ç®¡ç†æç¤ºè¯',
                basicSettings: 'åŸºç¡€è®¾ç½®ï¼Œä¿æŒç®€å•ã€‚',
                manageAIServices: 'ç®¡ç†AIæœåŠ¡å•†åŠæ¨¡å‹ã€‚',
                managePromptTemplates: 'ç®¡ç†å¯¹è¯æç¤ºè¯æ¨¡æ¿ã€‚',
                advancedSettings: 'ä»…åœ¨ä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆæ—¶ä½¿ç”¨ã€‚',
                interface: 'ç•Œé¢',
                display: 'æ˜¾ç¤º',
                performance: 'æ€§èƒ½',
                data: 'æ•°æ®',
                debug: 'è°ƒè¯•',
                serviceProviderList: 'æœåŠ¡å•†åˆ—è¡¨',
                addNewProvider: 'æ·»åŠ æ–°æœåŠ¡å•†',
                modelSelection: 'æ¨¡å‹é€‰æ‹©',
                promptList: 'æç¤ºè¯åˆ—è¡¨',
                addNewPrompt: 'æ·»åŠ æ–°æç¤ºè¯',
                lessIsMore: 'å°‘å³æ˜¯å¤šã€‚',
                requestTimeoutSeconds: 'è¯·æ±‚è¶…æ—¶ (ç§’)',
                historyRetentionDays: 'å†å²ä¿ç•™ (å¤©)',
                evaluationProcessDisplayLevel: 'äº’è¯„è¿‡ç¨‹å±•ç¤ºç¨‹åº¦'
            },
            en: {
                newChat: 'New Chat',
                selectImage: 'Select Image',
                placeholder: 'Enter your message here, press Enter to send',
                chatHistory: 'History',
                noHistory: 'No history yet',
                settings: 'Settings',
                user: 'User',
                aiAssistant: 'AI Assistant',
                newChatStarted: 'New chat started',
                selectModelFirst: 'Please select at least one model in the sidebar first',
                imageUploaded: 'Image uploaded:',
                aiFactory: 'AI Factory',
                preference: 'Preference',
                appearance: 'Appearance',
                models: 'Models',
                prompts: 'Prompts',
                advanced: 'Advanced',
                theme: 'Theme',
                language: 'Language',
                dark: 'Dark',
                light: 'Light',
                simplifiedChinese: 'Simplified Chinese',
                english: 'English',
                autoSave: 'Auto-save conversations',
                showTimestamps: 'Show timestamps',
                soundNotification: 'Sound notifications',
                fontSize: 'Font Size',
                compactMode: 'Compact Mode',
                defaultSidebarOpen: 'Default sidebar open',
                wallpaperSettings: 'Wallpaper Settings',
                opacity: 'Opacity',
                brightness: 'Brightness',
                blur: 'Blur',
                uploadWallpaper: 'Upload Wallpaper',
                resetWallpaper: 'Reset Default',
                evaluationDisplay: 'Evaluation Display Level',
                simpleSteps: 'Simple Steps (Default)',
                fullProcess: 'Full Process',
                debugMode: 'Debug Mode',
                apiLog: 'API Log',
                requestTimeout: 'Request Timeout (seconds)',
                maxRetry: 'Max Retry',
                historyRetention: 'History Retention (days)',
                permanent: 'Permanent',
                export: 'Export',
                clear: 'Clear',
                confirmClearAll: 'Are you sure to clear all data?',
                evaluationStarted: 'Evaluation process started, waiting for results...',
                initialAnswerComplete: 'completed initial answer',
                initialAnswer: 'Initial Answer',
                critiqueComplete: 'completed evaluation of {target}, score {score}',
                critiqueFor: 'Evaluation of {target}',
                totalScore: 'Total Score',
                accuracy: 'Accuracy',
                completeness: 'Completeness',
                clarity: 'Clarity',
                usefulness: 'Usefulness',
                revisionComplete: 'submitted improved answer',
                revisedAnswer: 'Revised Answer',
                evaluationComplete: 'âœ“ Evaluation complete, answer generated',
                answerGenerated: 'âœ“ Answer generated',
                finalAnswerGenerated: 'Final answer generated.',
                processingFailed: 'âŒ Processing failed',
                evaluationTerminated: 'Evaluation process terminated.',
                requestFailed: 'Request failed',
                showProcess: 'â–¼ Show evaluation process',
                hideProcess: 'â–² Hide evaluation process',
                noContent: '(No content)',
                uploadingWallpaper: 'Processing wallpaper...',
                wallpaperUpdated: 'Wallpaper updated.',
                wallpaperReset: 'Wallpaper reset to default.',
                wallpaperSaved: 'Currently using custom wallpaper.',
                wallpaperDefault: 'Using default wallpaper.',
                wallpaperError: 'Save failed: Insufficient browser storage space.',
                wallpaperFileError: 'File read failed.',
                wallpaperSizeError: 'Image is larger than 4MB, please compress it first.',
                confirmResetWallpaper: 'Are you sure to reset to default wallpaper?',
                noAnswerAvailable: 'No answer available',
                evaluationDisplayGroup: 'Evaluation Display',
                evaluationDisplayDesc: 'Select the level of model evaluation details to display to users.',
                behavior: 'Behavior',
                modelConfig: 'Model Configuration',
                translationSettings: 'Translation Settings',
                translationTargetLanguage: 'Target Language',
                translationTargetDesc: 'Default language used by the translate action.',
                translationOptionAuto: 'Auto (follow UI language)',
                translationOptionZh: 'Chinese',
                translationOptionEn: 'English',
                translationOptionJa: 'Japanese',
                translationOptionKo: 'Korean',
                translationOptionFr: 'French',
                translationOptionDe: 'German',
                promptManagement: 'Prompt Management',
                manageProviders: 'Manage Providers',
                managePrompts: 'Manage Prompts',
                basicSettings: 'Basic settings, keep it simple.',
                manageAIServices: 'Manage AI service providers and models.',
                managePromptTemplates: 'Manage conversation prompt templates.',
                advancedSettings: 'Only use when you know what you\'re doing.',
                interface: 'Interface',
                display: 'Display',
                performance: 'Performance',
                data: 'Data',
                debug: 'Debug',
                serviceProviderList: 'Service Provider List',
                addNewProvider: 'Add New Provider',
                modelSelection: 'Model Selection',
                promptList: 'Prompt List',
                addNewPrompt: 'Add New Prompt',
                lessIsMore: 'Less is more.',
                requestTimeout: 'Request Timeout (seconds)',
                maxRetry: 'Max Retry',
                historyRetention: 'History Retention (days)'
            }
        };

        const translationLanguageOrder = [
            { value: 'auto', labelKey: 'translationOptionAuto' },
            { value: 'zh', labelKey: 'translationOptionZh' },
            { value: 'en', labelKey: 'translationOptionEn' },
            { value: 'ja', labelKey: 'translationOptionJa' },
            { value: 'ko', labelKey: 'translationOptionKo' },
            { value: 'fr', labelKey: 'translationOptionFr' },
            { value: 'de', labelKey: 'translationOptionDe' }
        ];

        const translationPromptNameMap = {
            zh: 'ä¸­æ–‡',
            en: 'English',
            ja: 'æ—¥è¯­',
            ko: 'éŸ©è¯­',
            fr: 'æ³•è¯­',
            de: 'å¾·è¯­'
        };

        function getConfiguredTranslationTarget(uiLang) {
            const saved = S.get('translation_target', 'auto') || 'auto';
            if (saved === 'auto') {
                return uiLang === 'zh' ? 'en' : 'zh';
            }
            return saved;
        }

        function renderTranslationSelect(uiLang) {
            const select = document.getElementById('translation-target-select');
            if (!select) return;
            const t = i18n[uiLang] || i18n.zh;
            const saved = S.get('translation_target', 'auto') || 'auto';
            const allowedValues = translationLanguageOrder.map(item => item.value);
            const initialValue = allowedValues.includes(saved) ? saved : 'auto';
            select.innerHTML = '';
            translationLanguageOrder.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = t[item.labelKey] || item.value;
                select.appendChild(option);
            });
            select.value = initialValue;
        }
        
        function applyLanguage(l) {
            const t = i18n[l] || i18n.zh;
            
            // æ›´æ–°æŒ‰é’®å’Œè¾“å…¥æ¡†
            const newChatBtn = document.getElementById('new-chat-btn');
            if (newChatBtn) newChatBtn.title = t.newChat;
            const selectImageBtn = document.getElementById('select-image-btn');
            if (selectImageBtn) selectImageBtn.title = t.selectImage;
            const questionInput = document.getElementById('question-input');
            if (questionInput) questionInput.placeholder = t.placeholder;
            
            // æ›´æ–°å†å²è®°å½•å¼¹çª—
            const histTitle = document.querySelector('#history-popup .font-semibold');
            if (histTitle) histTitle.textContent = t.chatHistory;
            const noHistoryMsg = document.querySelector('#chat-history .text-center');
            if (noHistoryMsg && noHistoryMsg.textContent.includes('æš‚æ— å†å²è®°å½•')) {
                noHistoryMsg.textContent = t.noHistory;
            }
            
            // æ›´æ–°è®¾ç½®å¯¼èˆªé¡¹ï¼ˆä½¿ç”¨data-i18nçš„å­å…ƒç´ ï¼‰
            const settingsNavItems = document.querySelectorAll('.settings-nav-item');
            settingsNavItems.forEach(item => {
                const i18nSpan = item.querySelector('[data-i18n]');
                if (i18nSpan) {
                    const key = i18nSpan.getAttribute('data-i18n');
                    if (t[key]) {
                        i18nSpan.textContent = t[key];
                    }
                }
            });
            
            // æ›´æ–°æ‰€æœ‰å¸¦ data-i18n å±æ€§çš„å…ƒç´ ï¼ˆä½†æ’é™¤å¯¼èˆªé¡¹ä¸­çš„spanï¼Œå› ä¸ºå·²ç»åœ¨ä¸Šé¢å•ç‹¬å¤„ç†äº†ï¼‰
            document.querySelectorAll('[data-i18n]').forEach(el => {
                // è·³è¿‡å¯¼èˆªé¡¹ä¸­çš„spanï¼Œå› ä¸ºå·²ç»åœ¨ä¸Šé¢å•ç‹¬å¤„ç†äº†
                if (el.closest('.settings-nav-item')) {
                    return;
                }
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // æ›´æ–°é€‰é¡¹æ–‡æœ¬
            const themeSelect = document.getElementById('theme-mode-select');
            if (themeSelect) {
                themeSelect.options[0].text = t.dark;
                themeSelect.options[1].text = t.light;
            }
            const langSelect = document.getElementById('language-select');
            if (langSelect) {
                langSelect.options[0].text = t.simplifiedChinese;
                langSelect.options[1].text = t.english;
            }
            const evalSelect = document.getElementById('evaluation-display-select');
            if (evalSelect) {
                evalSelect.options[0].text = t.simpleSteps;
                evalSelect.options[1].text = t.fullProcess;
            }
            
            // æ›´æ–°è®¾ç½®é¡¹æ ‡é¢˜
            const titleMap = {
                'theme': t.theme,
                'language': t.language,
                'auto-save': t.autoSave,
                'timestamps': t.showTimestamps,
                'sound': t.soundNotification,
                'font-size': t.fontSize,
                'compact': t.compactMode,
                'sidebar-open': t.defaultSidebarOpen,
                'wallpaper': t.wallpaperSettings,
                'opacity': t.opacity,
                'brightness': t.brightness,
                'blur': t.blur,
                'evaluation-display': t.evaluationDisplay,
                'debug': t.debugMode,
                'api-log': t.apiLog,
                'timeout': t.requestTimeout,
                'retry': t.maxRetry,
                'retention': t.historyRetention,
                'export': t.export,
                'clear': t.clear
            };
            
            document.querySelectorAll('.settings-item-title').forEach(el => {
                const parent = el.closest('.settings-item');
                if (parent) {
                    const setting = parent.querySelector('[data-setting]');
                    if (setting && titleMap[setting.getAttribute('data-setting')]) {
                        el.textContent = titleMap[setting.getAttribute('data-setting')];
                    }
                }
            });
            
            // æ›´æ–°å£çº¸æŒ‰é’®æ–‡æœ¬
            const uploadBtn = document.getElementById('wallpaper-upload-btn');
            if (uploadBtn) uploadBtn.textContent = t.uploadWallpaper;
            const resetBtn = document.getElementById('reset-wallpaper-btn');
            if (resetBtn) resetBtn.textContent = t.resetWallpaper;
            
            // æ›´æ–°è®¾ç½®ç»„æ ‡é¢˜å’Œæè¿°
            document.querySelectorAll('.settings-group-title').forEach(title => {
                if (title.textContent.includes('äº’è¯„å±•ç¤º')) {
                    title.textContent = t.evaluationDisplayGroup;
                } else if (title.textContent.includes('è¡Œä¸º')) {
                    title.textContent = t.behavior;
                } else if (title.textContent.includes('æ¨¡å‹é…ç½®')) {
                    title.textContent = t.modelConfig;
                } else if (title.textContent.includes('æç¤ºè¯ç®¡ç†')) {
                    title.textContent = t.promptManagement;
                }
            });
            
            document.querySelectorAll('.settings-item-desc').forEach(desc => {
                if (desc.textContent.includes('é€‰æ‹©å‘ç”¨æˆ·å±•ç¤º')) {
                    desc.textContent = t.evaluationDisplayDesc;
                }
            });
            
            // æ›´æ–°è®¾ç½®å­æ ‡é¢˜
            document.querySelectorAll('.settings-subtitle').forEach(subtitle => {
                if (subtitle.textContent.includes('åŸºç¡€è®¾ç½®')) {
                    subtitle.textContent = t.basicSettings;
                } else if (subtitle.textContent.includes('ç®¡ç†AIæœåŠ¡å•†')) {
                    subtitle.textContent = t.manageAIServices;
                } else if (subtitle.textContent.includes('ç®¡ç†å¯¹è¯æç¤ºè¯')) {
                    subtitle.textContent = t.managePromptTemplates;
                } else if (subtitle.textContent.includes('ä»…åœ¨ä½ çŸ¥é“')) {
                    subtitle.textContent = t.advancedSettings;
                }
            });
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const manageProvidersBtn = document.getElementById('manage-providers-btn');
            if (manageProvidersBtn) manageProvidersBtn.textContent = t.manageProviders;
            const managePromptsBtn = document.getElementById('manage-prompts-btn');
            if (managePromptsBtn) managePromptsBtn.textContent = t.managePrompts;
            
            // æ›´æ–°ä¾§è¾¹æ æ‰‹é£ç´æ ‡é¢˜
            document.querySelectorAll('.accordion-header span').forEach(span => {
                if (span.textContent.includes('æ¨¡å‹é…ç½®')) {
                    span.textContent = 'ğŸ¤– ' + t.modelConfig;
                } else if (span.textContent.includes('æç¤ºè¯ç®¡ç†')) {
                    span.textContent = 'ğŸ’¬ ' + t.promptManagement;
                }
            });
            
            // æ›´æ–°ç¤ºä¾‹å¯¹è¯ä¸­çš„æ–‡æœ¬ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const exampleUser = document.querySelector('#chat-log .chat-message.user .font-medium');
            if (exampleUser && exampleUser.textContent === 'ç”¨æˆ·') {
                exampleUser.textContent = t.user;
            }
            const exampleAI = document.querySelector('#chat-log .chat-message.assistant .font-medium');
            if (exampleAI && exampleAI.textContent === 'AIåŠ©æ‰‹') {
                exampleAI.textContent = t.aiAssistant;
            }
            
            // ä¿å­˜å½“å‰è¯­è¨€ä»¥ä¾¿åç»­ä½¿ç”¨
            renderTranslationSelect(l);
            window.currentLang = l;
            
            // æ›´æ–°æ‰€æœ‰åŒ…å«"ç®¡ç†æœåŠ¡å•†"å’Œ"ç®¡ç†æç¤ºè¯"çš„æŒ‰é’®
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.includes('ç®¡ç†æœåŠ¡å•†')) {
                    btn.textContent = t.manageProviders;
                } else if (btn.textContent.includes('ç®¡ç†æç¤ºè¯')) {
                    btn.textContent = t.managePrompts;
                } else if (btn.textContent.includes('ä¸Šä¼ å£çº¸')) {
                    btn.textContent = t.uploadWallpaper;
                } else if (btn.textContent.includes('æ¢å¤é»˜è®¤') || btn.textContent.includes('é‡ç½®å£çº¸')) {
                    btn.textContent = t.resetWallpaper;
                }
            });
            
            // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å·²å¼€å¯ï¼Œé‡æ–°åº”ç”¨æ—¶é—´æˆ³ï¼ˆæ›´æ–°è¯­è¨€æ ¼å¼ï¼‰
            if (S.get('sw_timestamps') === '1') {
                setTimeout(() => {
                    applyToggleSetting('timestamps', true);
                }, 100);
            }
        }
        const translationTargetSelect = document.getElementById('translation-target-select');
        if (translationTargetSelect) {
            renderTranslationSelect(lang.value);
            translationTargetSelect.addEventListener('change', (e) => {
                S.set('translation_target', e.target.value);
            });
        }

        applyLanguage(lang.value);
        
        // åˆå§‹åŒ–æ—¶åŠ è½½å†å²è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å¹¶åº”ç”¨æ—¶é—´æˆ³
        window.addEventListener('DOMContentLoaded', () => {
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åŠ è½½
            setTimeout(() => {
                // å¦‚æœé¦–æ¬¡åŠ è½½ä¸”ç”¨æˆ·æœªè®¾ç½®è¿‡æ—¶é—´æˆ³å¼€å…³ï¼Œé»˜è®¤å¯ç”¨
                if (S.get('sw_timestamps') === null || S.get('sw_timestamps') === undefined || S.get('sw_timestamps') === '') {
                    S.set('sw_timestamps', '1');
                }
                // åº”ç”¨æ—¶é—´æˆ³è®¾ç½®
                if (S.get('sw_timestamps') === '1') {
                    applyToggleSetting('timestamps', true);
                }
            }, 500);
        });
        
        // å­—ä½“
        const font = document.getElementById('font-size-select');
        font.value = S.get('font', '16');
        font.onchange = e => {
            S.set('font', e.target.value);
            document.documentElement.style.fontSize = e.target.value + 'px';
        };
        document.documentElement.style.fontSize = font.value + 'px';
        
        // è¶…æ—¶å’Œé‡è¯•
        const timeout = document.getElementById('timeout-input');
        const retry = document.getElementById('retry-input');
        const retention = document.getElementById('retention-select');
        
        timeout.value = S.get('timeout', '30');
        retry.value = S.get('retry', '2');
        retention.value = S.get('retention', '30');
        
        timeout.onchange = e => S.set('timeout', e.target.value);
        retry.onchange = e => S.set('retry', e.target.value);
        retention.onchange = e => S.set('retention', e.target.value);
        
        // å¯¼å‡º/æ¸…é™¤
        document.getElementById('export-btn').onclick = () => {
            const data = { ...localStorage };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ai-factory-' + Date.now() + '.json';
            a.click();
        };
        
        document.getElementById('clear-btn').onclick = () => {
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            if (confirm(t.confirmClearAll)) {
                localStorage.clear();
                location.reload();
            }
        };
        
        // æ‰€æœ‰å¼€å…³ - ä¸€æ¬¡æå®š
        document.querySelectorAll('.settings-toggle[data-setting]').forEach(t => {
            const k = 'sw_' + t.dataset.setting;
            const setting = t.dataset.setting;
            
            // æ¢å¤çŠ¶æ€ - Linus é£æ ¼ï¼šç¡®ä¿ localStorage ä¸ UI åŒæ­¥
            const savedValue = S.get(k);
            if (savedValue === '1') {
                t.classList.add('active');
            } else if (savedValue === '0') {
                t.classList.remove('active');
            } else {
                // é¦–æ¬¡åŠ è½½ï¼Œæ ¹æ® HTML é»˜è®¤çŠ¶æ€ä¿å­˜åˆ° localStorage
                const isActive = t.classList.contains('active');
                S.set(k, isActive ? '1' : '0');
                console.log(`[å¼€å…³åˆå§‹åŒ–] ${setting}: ${isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            applyToggleSetting(setting, t.classList.contains('active'));
            
            // ç‚¹å‡»åˆ‡æ¢
            t.onclick = () => {
                t.classList.toggle('active');
                const active = t.classList.contains('active');
                S.set(k, active ? '1' : '0');
                console.log(`[å¼€å…³åˆ‡æ¢] ${setting}: ${active ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                applyToggleSetting(setting, active);
            };
        });
        
        // åº”ç”¨å¼€å…³è®¾ç½®
        function applyToggleSetting(setting, active) {
            switch(setting) {
                case 'compact':
                    document.body.classList.toggle('compact', active);
                    break;
                case 'timestamps':
                    // æ—¶é—´æˆ³æ˜¾ç¤ºé€»è¾‘ - ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ æˆ–ç§»é™¤æ—¶é—´æˆ³
                    const showTimestamps = active;
                    const chatMessages = document.querySelectorAll('.chat-message');
                    chatMessages.forEach(msg => {
                        const existingTimestamp = msg.querySelector('.message-timestamp');
                        if (showTimestamps) {
                            if (!existingTimestamp) {
                                let timestamp = msg.getAttribute('data-timestamp');
                                // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
                                if (!timestamp) {
                                    timestamp = Date.now().toString();
                                    msg.setAttribute('data-timestamp', timestamp);
                                }
                                
                                const timeEl = document.createElement('div');
                                timeEl.className = 'message-timestamp';
                                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px; opacity: 0.7;';
                                const date = new Date(parseInt(timestamp));
                                const lang = window.currentLang || 'zh';
                                if (lang === 'en') {
                                    timeEl.textContent = date.toLocaleString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                } else {
                                    timeEl.textContent = date.toLocaleString('zh-CN', { 
                                        month: 'numeric', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                }
                                msg.appendChild(timeEl);
                            } else {
                                // æ›´æ–°æ—¶é—´æˆ³æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶ï¼‰
                                const timestamp = msg.getAttribute('data-timestamp');
                                if (timestamp) {
                                    const date = new Date(parseInt(timestamp));
                                    const lang = window.currentLang || 'zh';
                                    if (lang === 'en') {
                                        existingTimestamp.textContent = date.toLocaleString('en-US', { 
                                            month: 'short', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        });
                                    } else {
                                        existingTimestamp.textContent = date.toLocaleString('zh-CN', { 
                                            month: 'numeric', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        });
                                    }
                                }
                            }
                        } else if (!showTimestamps && existingTimestamp) {
                            existingTimestamp.remove();
                        }
                    });
                    break;
                case 'sidebar-open':
                    // ä¾§è¾¹æ é»˜è®¤çŠ¶æ€ï¼ˆå¯åŠ¨æ—¶åº”ç”¨ï¼‰
                    if (active && sidebar.classList.contains('collapsed')) {
                        sidebar.classList.remove('collapsed');
                    }
                    break;
                case 'peer-review-mode':
                    // AIäº’è¯„æ¨¡å¼å¼€å…³
                    console.log('AIäº’è¯„æ¨¡å¼:', active ? 'å·²å¯ç”¨ï¼ˆå¤šæ¨¡å‹äº’è¯„ï¼‰' : 'å·²å…³é—­ï¼ˆå•æ¨¡å‹ç›´ç­”ï¼‰');
                    
                    // æ›´æ–°UIçŠ¶æ€
                    const peerReviewSetting = document.querySelector('.peer-review-setting');
                    const modeBadge = document.getElementById('peer-review-badge');
                    const modeDesc = document.getElementById('peer-review-desc');
                    
                    if (peerReviewSetting && modeBadge && modeDesc) {
                        if (active) {
                            peerReviewSetting.classList.remove('disabled');
                            modeBadge.textContent = 'å¤šæ¨¡å‹äº’è¯„';
                            modeBadge.style.background = 'linear-gradient(135deg, #3b82f6, #9333ea)';
                            modeDesc.innerHTML = 'âœ¨ å¯ç”¨ï¼šå¤šä¸ªæ¨¡å‹äº’ç›¸è¯„å®¡ï¼Œäº§ç”Ÿæ›´ä¼˜è´¨çš„ç­”æ¡ˆ';
                        } else {
                            peerReviewSetting.classList.add('disabled');
                            modeBadge.textContent = 'å•æ¨¡å‹ç›´ç­”';
                            modeBadge.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                            modeDesc.innerHTML = 'âš¡ å…³é—­ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„æ¨¡å‹ç›´æ¥å›ç­”ï¼ˆæ›´å¿«é€Ÿï¼‰';
                        }
                    }
                    
                    // å®æ—¶æç¤ºç”¨æˆ·
                    if (typeof notification !== 'undefined') {
                        if (active) {
                            notification.success('ğŸ¤– å·²å¯ç”¨ AI äº’è¯„æ¨¡å¼ï¼å¤šä¸ªæ¨¡å‹ä¼šäº’ç›¸è¯„å®¡å¹¶ä¼˜åŒ–ç­”æ¡ˆ');
                        } else {
                            notification.info('âš¡ å·²å…³é—­ AI äº’è¯„æ¨¡å¼ï¼å°†ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„æ¨¡å‹ç›´æ¥å›ç­”');
                        }
                    }
                    break;
                case 'auto-save':
                    console.log('è‡ªåŠ¨ä¿å­˜:', active);
                    break;
                case 'sound':
                    console.log('å£°éŸ³æç¤º:', active);
                    break;
                case 'debug':
                    console.log('è°ƒè¯•æ¨¡å¼:', active);
                    break;
                case 'api-log':
                    console.log('APIæ—¥å¿—:', active);
                    break;
            }
        }
        
        // å¼€å§‹æ–°å¯¹è¯
        document.getElementById('new-chat-btn').onclick = () => {
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            document.getElementById('chat-log').innerHTML = `<div class="text-center text-gray-400 py-8">${t.newChatStarted}</div>`;
            document.getElementById('question-input').value = '';
            document.getElementById('question-input').focus();
        };
        
        // å¿«é€Ÿæ¨¡å¼åˆ‡æ¢
        const quickModeToggle = document.getElementById('quick-mode-toggle');
        const quickModeText = document.getElementById('quick-mode-text');
        const modeIndicator = document.getElementById('mode-indicator');
        
        function updateQuickModeDisplay() {
            const peerReviewEnabled = S.get('sw_peer-review-mode', '1') === '1';
            if (peerReviewEnabled) {
                quickModeToggle.classList.remove('disabled');
                modeIndicator.classList.add('active');
                quickModeText.textContent = 'äº’è¯„';
                quickModeToggle.title = 'å½“å‰ï¼šAIäº’è¯„æ¨¡å¼ï¼ˆç‚¹å‡»åˆ‡æ¢åˆ°å•æ¨¡å‹æ¨¡å¼ï¼‰';
            } else {
                quickModeToggle.classList.add('disabled');
                modeIndicator.classList.remove('active');
                quickModeText.textContent = 'å•æ¨¡å‹';
                quickModeToggle.title = 'å½“å‰ï¼šå•æ¨¡å‹æ¨¡å¼ï¼ˆç‚¹å‡»åˆ‡æ¢åˆ°AIäº’è¯„æ¨¡å¼ï¼‰';
            }
        }
        
        quickModeToggle.onclick = () => {
            const currentMode = S.get('sw_peer-review-mode', '1');
            const newMode = currentMode === '1' ? '0' : '1';
            S.set('sw_peer-review-mode', newMode);
            
            // åŒæ­¥æ›´æ–°è®¾ç½®é¡µé¢çš„å¼€å…³
            const settingsToggle = document.querySelector('[data-setting="peer-review-mode"]');
            if (settingsToggle) {
                if (newMode === '1') {
                    settingsToggle.classList.add('active');
                } else {
                    settingsToggle.classList.remove('active');
                }
            }
            
            // åº”ç”¨è®¾ç½®å˜åŒ–
            applyToggleSetting('peer-review-mode', newMode === '1');
            updateQuickModeDisplay();
        };
        
        // åˆå§‹åŒ–å¿«é€Ÿæ¨¡å¼æ˜¾ç¤º
        updateQuickModeDisplay();
        
        // åˆ›å»ºç­”æ¡ˆæ“ä½œæŒ‰é’®
        function createAnswerActions(answerDiv, answerText, originalQuestion) {
            // é¿å…é‡å¤åˆ›å»º
            const existingActions = answerDiv.querySelector('.answer-actions');
            if (existingActions) {
                existingActions.remove();
            }
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'answer-actions';
            
            // å¤åˆ¶æŒ‰é’®
            const copyBtn = createActionButton('ğŸ“‹', 'å¤åˆ¶', 'primary', () => {
                navigator.clipboard.writeText(answerText).then(() => {
                    notification.success('ç­”æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    notification.error('å¤åˆ¶å¤±è´¥');
                });
            });
            
            // é‡æ–°ç”ŸæˆæŒ‰é’®
            const regenBtn = createActionButton('ğŸ”„', 'é‡æ–°ç”Ÿæˆ', '', () => {
                // é‡æ–°å‘é€ç›¸åŒçš„é—®é¢˜
                let questionToUse = originalQuestion;
                
                // å¦‚æœ originalQuestion ä¸ºç©ºï¼Œå°è¯•ä»DOMå…ƒç´ ä¸­è·å–
                if (!questionToUse || !questionToUse.trim()) {
                    // å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯æˆ–AIæ¶ˆæ¯
                    let parent = answerDiv.parentElement;
                    while (parent && parent !== document.body) {
                        if (parent.classList.contains('chat-message')) {
                            questionToUse = parent.getAttribute('data-original-question') || '';
                            if (questionToUse) break;
                        }
                        parent = parent.parentElement;
                    }
                    
                    // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•ä»ç”¨æˆ·æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹ä¸­æå–
                    if (!questionToUse || !questionToUse.trim()) {
                        const userMessages = document.querySelectorAll('.chat-message.user');
                        if (userMessages.length > 0) {
                            const lastUserMsg = userMessages[userMessages.length - 1];
                            const questionDiv = lastUserMsg.querySelector('div > div:last-child');
                            if (questionDiv) {
                                questionToUse = questionDiv.textContent.trim();
                            }
                        }
                    }
                }
                
                if (questionToUse && questionToUse.trim()) {
                    const input = document.getElementById('question-input');
                    const submit = document.getElementById('submit-btn');
                    if (input && submit) {
                        input.value = questionToUse.trim();
                        input.disabled = false;
                        submit.disabled = false;
                        // è§¦å‘è¾“å…¥äº‹ä»¶ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®æ›´æ–°
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        // ç¨ç­‰ç‰‡åˆ»å†ç‚¹å‡»ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
                        setTimeout(() => {
                            submit.click();
                        }, 50);
                    } else {
                        console.error('æ— æ³•æ‰¾åˆ°è¾“å…¥æ¡†æˆ–æäº¤æŒ‰é’®');
                        if (typeof notification !== 'undefined' && notification.error) {
                            notification.error('æ— æ³•é‡æ–°ç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                        } else {
                            alert('æ— æ³•é‡æ–°ç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                        }
                    }
                } else {
                    if (typeof notification !== 'undefined' && notification.error) {
                        notification.error('æ— æ³•æ‰¾åˆ°åŸå§‹é—®é¢˜ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ');
                    } else {
                        alert('æ— æ³•æ‰¾åˆ°åŸå§‹é—®é¢˜ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ');
                    }
                }
            });
            
            // æ’å…¥ä»£ç æŒ‰é’®ï¼ˆå¦‚æœç­”æ¡ˆåŒ…å«ä»£ç ï¼‰
            if (answerText.includes('```') || answerText.includes('`')) {
                const insertBtn = createActionButton('ğŸ“', 'æ’å…¥ä»£ç ', '', () => {
                    // æå–ä»£ç å—
                    const codeBlocks = answerText.match(/```[\s\S]*?```/g) || [];
                    const inlineCode = answerText.match(/`[^`]+`/g) || [];
                    
                    let allCode = '';
                    codeBlocks.forEach(block => {
                        allCode += block.replace(/```\w*\n?/g, '').replace(/```/g, '') + '\n\n';
                    });
                    inlineCode.forEach(code => {
                        allCode += code.replace(/`/g, '') + '\n';
                    });
                    
                    navigator.clipboard.writeText(allCode.trim()).then(() => {
                        notification.success('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    });
                });
                actionsDiv.appendChild(insertBtn);
            }
            
            // ç¿»è¯‘æŒ‰é’®
            const translateBtn = createActionButton('ğŸŒ', 'ç¿»è¯‘', '', async () => {
                try {
                    const uiLang = window.currentLang || 'zh';
                    const targetLang = getConfiguredTranslationTarget(uiLang);
                    const langName = translationPromptNameMap[targetLang] || targetLang;
                    
                    // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹è¿›è¡Œç¿»è¯‘
                    const selectedModels = JSON.parse(S.get('models', '[]'));
                    if (selectedModels.length === 0) {
                        notification.warning('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¨¡å‹');
                        return;
                    }
                    
                    const translatePrompt = `è¯·å°†ä»¥ä¸‹å†…å®¹ç¿»è¯‘æˆ${langName}ï¼Œä¿æŒåŸæœ‰æ ¼å¼å’Œç»“æ„ï¼š\n\n${answerText}`;
                    
                    // åˆ›å»ºæ–°çš„AIæ¶ˆæ¯ç”¨äºæ˜¾ç¤ºç¿»è¯‘ç»“æœ
                    const translateMsg = document.createElement('div');
                    translateMsg.className = 'chat-message assistant';
                    translateMsg.innerHTML = `
                        <div class="font-medium mb-1 text-purple-400">ğŸŒ ç¿»è¯‘ç»“æœ Â· ${langName}</div>
                        <div class="response-content">
                            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">æ­£åœ¨ç¿»è¯‘...</div>
                        </div>
                    `;
                    chatLog.appendChild(translateMsg);
                    chatLog.scrollTop = chatLog.scrollHeight;
                    
                    const resp = await fetch('/api/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: translatePrompt,
                            selected_models: [selectedModels[0]],
                            history: []
                        })
                    });
                    
                    if (resp.ok) {
                        const reader = resp.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        const responseContent = translateMsg.querySelector('.response-content');
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop();
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'final_result') {
                                            const translatedText = data.data?.best_answer || 'ç¿»è¯‘å¤±è´¥';
                                            responseContent.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.6;">${translatedText}</div>`;
                                            createAnswerActions(responseContent, translatedText, '');
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    }
                } catch (error) {
                    notification.error('ç¿»è¯‘å¤±è´¥ï¼š' + error.message);
                }
            });
            
            // ç¼–è¾‘ä¼˜åŒ–æŒ‰é’®
            const optimizeBtn = createActionButton('âœ¨', 'ç¼–è¾‘ä¼˜åŒ–', '', async () => {
                const optimizePrompt = `è¯·å¯¹ä»¥ä¸Šå†…å®¹è¿›è¡Œç¼–è¾‘ä¼˜åŒ–ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€å‡†ç¡®ã€æ˜“æ‡‚ï¼š\n\n${answerText}`;
                questionInput.value = optimizePrompt;
                notification.info('å·²å°†ä¼˜åŒ–æç¤ºå¡«å…¥è¾“å…¥æ¡†ï¼Œç‚¹å‡»å‘é€å¼€å§‹ä¼˜åŒ–');
            });
            
            // åˆ†éš”ç¬¦
            const divider1 = document.createElement('div');
            divider1.className = 'action-divider';
            
            const divider2 = document.createElement('div');
            divider2.className = 'action-divider';
            
            // æ·»åŠ æŒ‰é’®åˆ°å®¹å™¨
            actionsDiv.appendChild(copyBtn);
            actionsDiv.appendChild(regenBtn);
            actionsDiv.appendChild(divider1);
            actionsDiv.appendChild(translateBtn);
            actionsDiv.appendChild(optimizeBtn);
            actionsDiv.appendChild(divider2);
            
            // æ›´å¤šæ“ä½œæŒ‰é’®
            const moreBtn = createActionButton('â‹¯', 'æ›´å¤š', '', () => {
                const menu = document.createElement('div');
                menu.className = 'more-actions-menu';
                menu.style.cssText = `
                    position: absolute;
                    bottom: 100%;
                    right: 0;
                    background: rgba(17, 24, 39, 0.95);
                    border: 1px solid rgba(75, 85, 99, 0.6);
                    border-radius: 8px;
                    padding: 4px;
                    min-width: 120px;
                    backdrop-filter: blur(10px);
                    z-index: 1000;
                    animation: fadeInUp 0.2s ease-out;
                `;
                
                const menuItems = [
                    { icon: 'ğŸ”', text: 'è¯¦ç»†åˆ†æ', action: () => {
                        questionInput.value = `è¯·å¯¹ä»¥ä¸‹å†…å®¹è¿›è¡Œè¯¦ç»†åˆ†æï¼š\n\n${answerText}`;
                        notification.info('å·²å¡«å…¥åˆ†ææç¤º');
                        menu.remove();
                    }},
                    { icon: 'ğŸ“Š', text: 'æ€»ç»“è¦ç‚¹', action: () => {
                        questionInput.value = `è¯·æ€»ç»“ä»¥ä¸‹å†…å®¹çš„è¦ç‚¹ï¼š\n\n${answerText}`;
                        notification.info('å·²å¡«å…¥æ€»ç»“æç¤º');
                        menu.remove();
                    }},
                    { icon: 'â“', text: 'æå‡ºé—®é¢˜', action: () => {
                        questionInput.value = `åŸºäºä»¥ä¸‹å†…å®¹ï¼Œè¯·æå‡º3-5ä¸ªæ·±å…¥çš„é—®é¢˜ï¼š\n\n${answerText}`;
                        notification.info('å·²å¡«å…¥é—®é¢˜æç¤º');
                        menu.remove();
                    }}
                ];
                
                menuItems.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 6px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        color: #d1d5db;
                        transition: background 0.2s ease;
                    `;
                    menuItem.innerHTML = `<span>${item.icon}</span><span>${item.text}</span>`;
                    menuItem.onmouseover = () => menuItem.style.background = 'rgba(75, 85, 99, 0.5)';
                    menuItem.onmouseout = () => menuItem.style.background = 'transparent';
                    menuItem.onclick = item.action;
                    menu.appendChild(menuItem);
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeMenu), 0);
                
                moreBtn.style.position = 'relative';
                moreBtn.appendChild(menu);
            });
            
            actionsDiv.appendChild(moreBtn);
            
            // å°†æ“ä½œæŒ‰é’®æ·»åŠ åˆ°ç­”æ¡ˆä¸‹æ–¹
            answerDiv.appendChild(actionsDiv);
        }
        
        function createActionButton(icon, text, className = '', onClick) {
            const btn = document.createElement('button');
            btn.className = `action-btn ${className}`;
            btn.innerHTML = `
                <span class="action-btn-icon">${icon}</span>
                <span class="action-btn-text">${text}</span>
            `;
            btn.onclick = onClick;
            return btn;
        }
        
        // å‘é€æ¶ˆæ¯
        const submitBtn = document.getElementById('submit-btn');
        const stopBtn = document.getElementById('stop-btn');
        const questionInput = document.getElementById('question-input');
        
        // åœæ­¢æŒ‰é’®äº‹ä»¶ç›‘å¬
        if (stopBtn) {
            stopBtn.onclick = () => {
                if (window.stopGeneration && typeof window.stopGeneration === 'function') {
                    window.stopGeneration();
                } else if (window.currentReader) {
                    try {
                        window.currentReader.cancel('User requested stop');
                    } catch (e) {
                        console.error('Cancel error:', e);
                    }
                    window.currentReader = null;
                }
                
                // æ¢å¤UIçŠ¶æ€
                if (submitBtn) {
                    submitBtn.classList.remove('hidden');
                    submitBtn.disabled = false;
                }
                if (stopBtn) {
                    stopBtn.classList.add('hidden');
                }
                if (questionInput) {
                    questionInput.disabled = false;
                }
                
                // æ˜¾ç¤ºåœæ­¢æ¶ˆæ¯
                const chatLog = document.getElementById('chat-log');
                if (chatLog) {
                    const stopMessage = document.createElement('div');
                    stopMessage.className = 'chat-message assistant';
                    stopMessage.innerHTML = '<div class="font-medium mb-1 text-purple-400">AIåŠ©æ‰‹</div><div class="text-yellow-400 italic">âš ï¸ ç”Ÿæˆå·²è¢«ç”¨æˆ·åœæ­¢</div>';
                    chatLog.appendChild(stopMessage);
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
            };
        }

        questionInput.addEventListener('input', () => {
            if (questionInput.value.trim().length > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        });

        submitBtn.onclick = async () => {
            const question = questionInput.value.trim();
            if (!question) return;
            
            const selectedModels = JSON.parse(S.get('models', '[]'));
            const peerReviewSetting = S.get('sw_peer-review-mode', '1');
            const isPeerReviewEnabled = peerReviewSetting !== '0';
            const modelsToUse = isPeerReviewEnabled
                ? selectedModels
                : (selectedModels.length > 0 ? [selectedModels[0]] : []);

            if (modelsToUse.length === 0) {
                const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                alert(t.selectModelFirst);
                return;
            }

            console.log('[æäº¤è¯·æ±‚] åŸå§‹æ¨¡å‹æ•°:', selectedModels.length, 'äº’è¯„æ¨¡å¼:', isPeerReviewEnabled ? 'å¯ç”¨' : 'ç¦ç”¨', 'å®é™…ä½¿ç”¨:', modelsToUse.length);
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const chatLog = document.getElementById('chat-log');
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.setAttribute('data-timestamp', Date.now().toString());
            userMsgDiv.setAttribute('data-original-question', question); // ä¿å­˜åŸå§‹é—®é¢˜
            userMsgDiv.innerHTML = `<div class="font-medium mb-1">${t.user}</div><div>${question}</div>`;
            
            // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æ—¶é—´æˆ³
            if (S.get('sw_timestamps') === '1') {
                const timeEl = document.createElement('div');
                timeEl.className = 'message-timestamp';
                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                const date = new Date();
                const lang = window.currentLang || 'zh';
                if (lang === 'en') {
                    timeEl.textContent = date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                } else {
                    timeEl.textContent = date.toLocaleString('zh-CN', { 
                        month: 'numeric', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                userMsgDiv.appendChild(timeEl);
            }
            
            chatLog.appendChild(userMsgDiv);
            
            // ä¿å­˜åŸå§‹é—®é¢˜ï¼Œä»¥ä¾¿é‡æ–°ç”Ÿæˆæ—¶ä½¿ç”¨
            const savedQuestion = question;
            
            questionInput.value = '';
            questionInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.classList.add('hidden');
            if (stopBtn) {
                stopBtn.classList.remove('hidden');
            }
        
            // æ·»åŠ AIå“åº”å ä½
            const aiMsg = document.createElement('div');
            aiMsg.className = 'chat-message assistant';
            aiMsg.setAttribute('data-timestamp', Date.now().toString());
            aiMsg.setAttribute('data-original-question', savedQuestion); // åœ¨AIæ¶ˆæ¯ä¸­ä¹Ÿä¿å­˜åŸå§‹é—®é¢˜
            const t2 = i18n[window.currentLang || 'zh'] || i18n.zh;
            aiMsg.innerHTML = `<div class="font-medium mb-1 text-purple-400">${t2.aiAssistant}</div><div class="response-content"></div>`;
            chatLog.appendChild(aiMsg);
            chatLog.scrollTop = chatLog.scrollHeight;

        const responseContent = aiMsg.querySelector('.response-content');
        
        // åˆ›å»ºæ­¥éª¤çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
        const statusDiv = document.createElement('div');
        statusDiv.className = 'evaluation-status';
        statusDiv.style.cssText = `
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(37, 41, 50, 0.6);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        `;
        statusDiv.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
        
        const finalAnswerDiv = document.createElement('div');
        finalAnswerDiv.className = 'final-answer';
        finalAnswerDiv.style.whiteSpace = 'pre-wrap';
        finalAnswerDiv.style.fontSize = '15px';
        finalAnswerDiv.style.lineHeight = '1.6';
        finalAnswerDiv.style.color = '#e2e8f0';
        finalAnswerDiv.style.display = 'none'; // åˆå§‹éšè—ï¼Œç­‰æœ‰ç­”æ¡ˆæ—¶æ˜¾ç¤º

        const evaluationMode = S.get('evaluation_display', 'simple');
        
        // åˆ›å»ºå¯æŠ˜å çš„è¿›åº¦å®¹å™¨
        const processWrapper = document.createElement('div');
        processWrapper.className = 'process-wrapper';
        
        const processToggle = document.createElement('button');
        processToggle.className = 'process-toggle';
        const t_process = i18n[window.currentLang || 'zh'] || i18n.zh;
        processToggle.innerHTML = t_process.showProcess;
        processToggle.style.cssText = `
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 12px;
            transition: all 0.2s;
            display: none;
        `;
        
        const processContainer = document.createElement('div');
        processContainer.className = `evaluation-process ${evaluationMode}`;
        processContainer.style.display = 'none'; // é»˜è®¤æŠ˜å 
        
        processToggle.onclick = () => {
            const isHidden = processContainer.style.display === 'none';
            processContainer.style.display = isHidden ? 'block' : 'none';
            const t_toggle = i18n[window.currentLang || 'zh'] || i18n.zh;
            processToggle.innerHTML = isHidden ? t_toggle.hideProcess : t_toggle.showProcess;
        };

        const appendProcessLine = (text) => {
            if (!text || evaluationMode !== 'simple') return; // åªåœ¨ç®€å•æ¨¡å¼ä¸‹æ·»åŠ 
            const line = document.createElement('div');
            line.className = 'process-line';
            line.textContent = text;
            processContainer.appendChild(line);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

            const appendDetailedBlock = (title, content, meta = '') => {
                if (evaluationMode !== 'detailed') return; // Good Taste: If not detailed, do nothing.
                const block = document.createElement('div');
                block.className = 'process-block';

                if (title) {
                    const heading = document.createElement('h4');
                    heading.textContent = title;
                    block.appendChild(heading);
                }

                if (meta) {
                    const metaDiv = document.createElement('div');
                    metaDiv.style.color = '#9ca3af';
                    metaDiv.style.fontSize = '12px';
                    metaDiv.style.marginBottom = '8px';
                    metaDiv.textContent = meta;
                    block.appendChild(metaDiv);
                }

                const textDiv = document.createElement('div');
                textDiv.className = 'process-text';
                const t_empty = i18n[window.currentLang || 'zh'] || i18n.zh;
                textDiv.textContent = content || t_empty.noContent;
                block.appendChild(textDiv);

                processContainer.appendChild(block);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

        responseContent.appendChild(statusDiv);
        responseContent.appendChild(finalAnswerDiv);
        processWrapper.appendChild(processToggle);
        processWrapper.appendChild(processContainer);
        responseContent.appendChild(processWrapper);

        // Only show process container if there's something to show
        if (modelsToUse.length > 1) {
            const t_start = i18n[window.currentLang || 'zh'] || i18n.zh;
            appendProcessLine(t_start.evaluationStarted);
        }
        if (!isPeerReviewEnabled && selectedModels.length > 1) {
            const statusMsg = document.createElement('div');
            statusMsg.className = 'mode-status-message';
            statusMsg.style.cssText = `
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                color: #1f2937;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                margin: 8px 0;
                display: flex;
                align-items: center;
                gap: 6px;
            `;
            statusMsg.innerHTML = 'âš¡ AIäº’è¯„æ¨¡å¼å·²å…³é—­ï¼šä½¿ç”¨å•æ¨¡å‹å¿«é€Ÿå›ç­”';
            processWrapper.insertBefore(statusMsg, processContainer);
        }
            try {
                const resp = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        selected_models: modelsToUse,
                        history: []
                    })
                });
                
                const t_error = i18n[window.currentLang || 'zh'] || i18n.zh;
                if (!resp.ok) throw new Error(t_error.requestFailed);
                
                // è®¾ç½® currentReader ä»¥ä¾¿åœæ­¢æŒ‰é’®å¯ä»¥å–æ¶ˆè¯·æ±‚
                const reader = resp.body.getReader();
                window.currentReader = reader;
                
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                switch (data.type) {
                                    case 'status': {
                                        // æ›´æ–°ä¸»è¦çŠ¶æ€æ˜¾ç¤º
                                        statusDiv.textContent = data.data;
                                        appendProcessLine(data.data);
                                        break;
                                    }
                                    case 'initial_answer_complete': {
                                        const t_init = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        appendProcessLine(`${data.model_name} ${t_init.initialAnswerComplete}`);
                                        appendDetailedBlock(`${data.model_name} ${t_init.initialAnswer}`, data.answer || '');
                                        break;
                                    }
                                    case 'critique_complete': {
                                        const t_crit = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        const critiqueData = data.critique_data || {};
                                        const score = typeof critiqueData.score === 'number' ? critiqueData.score.toFixed(2) : (critiqueData.score || 'N/A');
                                        appendProcessLine(`${data.critic_name} ${t_crit.critiqueComplete.replace('{target}', data.target_model).replace('{score}', score)}`);
                                        if (evaluationMode === 'detailed') {
                                            const metrics = `${t_crit.accuracy} ${critiqueData.accuracy ?? '-'} / ${t_crit.completeness} ${critiqueData.completeness ?? '-'} / ${t_crit.clarity} ${critiqueData.clarity ?? '-'} / ${t_crit.usefulness} ${critiqueData.usefulness ?? '-'}`;
                                            const commentSource = critiqueData.comment || data.critique_text || '';
                                            appendDetailedBlock(`${data.critic_name} ${t_crit.critiqueFor.replace('{target}', data.target_model)}`, commentSource, `${t_crit.totalScore} ${score} | ${metrics}`);
                                        }
                                        break;
                                    }
                                    case 'revision_complete': {
                                        const t_rev = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        appendProcessLine(`${data.model_name} ${t_rev.revisionComplete}`);
                                        appendDetailedBlock(`${data.model_name} ${t_rev.revisedAnswer}`, data.revised_answer || '');
                                        break;
                                    }
                                    case 'final_result': {
                                        const result = data.data || {};
                                        const t_final = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        statusDiv.textContent = t_final.evaluationComplete;
                                        statusDiv.style.borderLeftColor = 'var(--accent-purple)';
                                        statusDiv.classList.add('completed');
                                        appendProcessLine(t_final.finalAnswerGenerated);
                                        
                                        // æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
                                        const t_no_answer = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        finalAnswerDiv.textContent = result.best_answer || t_no_answer.noAnswerAvailable;
                                        finalAnswerDiv.style.display = 'block';
                                        
                                        // åˆ›å»ºç­”æ¡ˆæ“ä½œæŒ‰é’® - ä»AIæ¶ˆæ¯å…ƒç´ ä¸­è·å–åŸå§‹é—®é¢˜
                                        const savedQuestion = aiMsg.getAttribute('data-original-question') || questionInput.value || '';
                                        createAnswerActions(finalAnswerDiv, result.best_answer || '', savedQuestion);
                                        
                                        // æ˜¾ç¤ºè¿›åº¦åˆ‡æ¢æŒ‰é’®
                                        processToggle.style.display = 'inline-block';
                                        
                                        // æ›´æ–°æ¶ˆæ¯æ—¶é—´æˆ³
                                        aiMsg.setAttribute('data-timestamp', Date.now().toString());
                                        
                                        // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æˆ–æ›´æ–°æ—¶é—´æˆ³
                                        if (S.get('sw_timestamps') === '1') {
                                            let timeEl = aiMsg.querySelector('.message-timestamp');
                                            if (!timeEl) {
                                                timeEl = document.createElement('div');
                                                timeEl.className = 'message-timestamp';
                                                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                                                aiMsg.appendChild(timeEl);
                                            }
                                            const date = new Date();
                                            const lang = window.currentLang || 'zh';
                                            if (lang === 'en') {
                                                timeEl.textContent = date.toLocaleString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            } else {
                                                timeEl.textContent = date.toLocaleString('zh-CN', { 
                                                    month: 'numeric', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            }
                                        }
                                        
                                        // ä¿å­˜åˆ°å†å²è®°å½•
                                        if (S.get('sw_auto-save') === '1') {
                                            setTimeout(() => saveChatHistory(), 500);
                                        }
                                        
                                        if (evaluationMode === 'detailed') {
                                            // In detailed mode, the blocks are already appended by other events.
                                            // This section is now redundant.
                                        }
                                        break;
                                    }
                                    case 'final': {
                                        const t_final_single = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        statusDiv.textContent = t_final_single.answerGenerated;
                                        statusDiv.style.borderLeftColor = 'var(--accent-purple)';
                                        statusDiv.classList.add('completed');
                                        appendProcessLine(t_final_single.finalAnswerGenerated);
                                        
                                        // æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
                                        const t_no_answer2 = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        finalAnswerDiv.textContent = data.data || t_no_answer2.noAnswerAvailable;
                                        finalAnswerDiv.style.display = 'block';
                                        
                                        // æ˜¾ç¤ºè¿›åº¦åˆ‡æ¢æŒ‰é’®
                                        processToggle.style.display = 'inline-block';
                                        
                                        // æ›´æ–°æ¶ˆæ¯æ—¶é—´æˆ³
                                        aiMsg.setAttribute('data-timestamp', Date.now().toString());
                                        
                                        // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æˆ–æ›´æ–°æ—¶é—´æˆ³
                                        if (S.get('sw_timestamps') === '1') {
                                            let timeEl = aiMsg.querySelector('.message-timestamp');
                                            if (!timeEl) {
                                                timeEl = document.createElement('div');
                                                timeEl.className = 'message-timestamp';
                                                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                                                aiMsg.appendChild(timeEl);
                                            }
                                            const date = new Date();
                                            const lang = window.currentLang || 'zh';
                                            if (lang === 'en') {
                                                timeEl.textContent = date.toLocaleString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            } else {
                                                timeEl.textContent = date.toLocaleString('zh-CN', { 
                                                    month: 'numeric', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            }
                                        }
                                        
                                        // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆå¦‚æœå¼€å¯è‡ªåŠ¨ä¿å­˜ï¼‰
                                        if (S.get('sw_auto-save') === '1') {
                                            setTimeout(() => {
                                                saveChatHistory();
                                            }, 1000); // å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°å®Œæˆ
                                        }
                                        break;
                                    }
                                    case 'error': {
                                        const t_err = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        statusDiv.textContent = t_err.processingFailed;
                                        statusDiv.style.borderLeftColor = '#f87171';
                                        statusDiv.style.color = '#f87171';
                                        
                                        finalAnswerDiv.textContent = `${t_err.processingFailed}: ${data.data}`;
                                        finalAnswerDiv.style.color = '#f87171';
                                        finalAnswerDiv.style.display = 'block';
                                        appendProcessLine(t_err.evaluationTerminated);
                                        break;
                                    }
                                    default:
                                        break;
                                }
                            } catch (e) {}
                        }
                    }
                }
            } catch (e) {
                const t_catch = i18n[window.currentLang || 'zh'] || i18n.zh;
                statusDiv.textContent = t_catch.requestFailed;
                statusDiv.style.borderLeftColor = '#f87171';
                statusDiv.style.color = '#f87171';
                
                finalAnswerDiv.textContent = `${t_catch.requestFailed}: ${e.message}`;
                finalAnswerDiv.style.color = '#f87171';
                finalAnswerDiv.style.display = 'block';
                appendProcessLine(t_catch.evaluationTerminated);
            } finally {
                // æ¸…ç† currentReader
                window.currentReader = null;
                
                // æ¢å¤UIçŠ¶æ€
                questionInput.disabled = false;
                questionInput.focus();
                submitBtn.disabled = false;
                submitBtn.classList.remove('hidden');
                if (stopBtn) {
                    stopBtn.classList.add('hidden');
                }
            }
        };
        
        // å›è½¦å‘é€
        questionInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitBtn.click();
            }
        };
        
        // é€‰æ‹©å›¾ç‰‡
        document.getElementById('select-image-btn').onclick = () => {
            document.getElementById('image-input').click();
        };
        
        document.getElementById('image-input').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.style.maxWidth = '200px';
                    img.style.borderRadius = '8px';
                    img.style.marginTop = '8px';
                    
                    const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'chat-message user';
                    msgDiv.setAttribute('data-timestamp', Date.now().toString());
                    msgDiv.innerHTML = `<div class="font-medium mb-1">${t.user}</div><div>${t.imageUploaded}</div>`;
                    msgDiv.appendChild(img);
                    
                    // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æ—¶é—´æˆ³
                    if (S.get('sw_timestamps') === '1') {
                        const timeEl = document.createElement('div');
                        timeEl.className = 'message-timestamp';
                        timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                        const date = new Date();
                        const lang = window.currentLang || 'zh';
                        if (lang === 'en') {
                            timeEl.textContent = date.toLocaleString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        } else {
                            timeEl.textContent = date.toLocaleString('zh-CN', { 
                                month: 'numeric', 
                                day: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        }
                        msgDiv.appendChild(timeEl);
                    }
                    
                    document.getElementById('chat-log').appendChild(msgDiv);
                };
                reader.readAsDataURL(file);
            }
        };
        
        // APIè°ƒç”¨å‡½æ•°
        async function api(url, method = 'GET', data = null) {
            const opts = { method, headers: {} };
            if (data) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(data);
            }
            const resp = await fetch('/api' + url, opts);
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({ detail: 'è¯·æ±‚å¤±è´¥' }));
                throw new Error(err.detail || err.message || 'è¯·æ±‚å¤±è´¥');
            }
            return resp.json();
        }
        
        // åŠ è½½æœåŠ¡å•†åˆ—è¡¨
        async function loadProviders() {
            try {
                const providers = await api('/providers');
                const container = document.getElementById('provider-list-settings');
                container.innerHTML = providers.map(p => `
                    <div class="provider-item-settings">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-blue-400">${p.name}</div>
                                <div class="text-sm text-gray-400">(${p.type})</div>
                            </div>
                            <button class="btn-danger text-xs" onclick="deleteProvider('${p.name}')">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
                loadModelsForSidebar(providers);
            } catch (e) {
                console.error('åŠ è½½æœåŠ¡å•†å¤±è´¥:', e);
            }
        }
        
        // åˆ é™¤æœåŠ¡å•†
        window.deleteProvider = async function(name) {
            if (!confirm('ç¡®å®šåˆ é™¤ ' + name + '?')) return;
            try {
                await api('/providers/' + name, 'DELETE');
                loadProviders();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        };
        
        // æ·»åŠ æœåŠ¡å•†
        document.getElementById('add-provider-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value.trim(),
                type: form.type.value,
                api_key: form.api_key.value.trim(),
                api_base: form.api_base.value.trim() || null,
                models: form.models.value.trim()
            };
            try {
                await api('/providers', 'POST', data);
                form.reset();
                loadProviders();
                alert('æ·»åŠ æˆåŠŸ');
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        };
        
        // åŠ è½½æ¨¡å‹åˆ—è¡¨åˆ°ä¾§è¾¹æ 
        function loadModelsForSidebar(providers) {
            const container = document.getElementById('model-list-sidebar');
            const selected = JSON.parse(S.get('models', '[]'));
            let html = '';
            providers.forEach(p => {
                p.models.split(',').forEach(m => {
                    const modelName = m.trim();
                    const key = `${p.name}::${modelName}`;
                    const isActive = selected.includes(key);
                    html += `
                        <div class="sidebar-item ${isActive ? 'active' : ''}" onclick="toggleModel('${key}', this)">
                            <span class="name">${p.name} - ${modelName}</span>
                        </div>
                    `;
                });
            });
            container.innerHTML = html || '<div class="text-xs text-gray-400 p-2">æ— å¯ç”¨æ¨¡å‹</div>';
        }
        
        // åˆ‡æ¢æ¨¡å‹é€‰æ‹©
        window.toggleModel = function(key, element) {
            const selected = JSON.parse(S.get('models', '[]'));
            const index = selected.indexOf(key);
            
            if (index > -1) {
                selected.splice(index, 1);
                element.classList.remove('active');
            } else {
                selected.push(key);
                element.classList.add('active');
            }
            S.set('models', JSON.stringify(selected));
        };
        
        // åŠ è½½æç¤ºè¯åˆ—è¡¨
        async function loadPrompts() {
            try {
                const prompts = await api('/prompts');
                const settingsContainer = document.getElementById('prompt-list-settings');
                const sidebarContainer = document.getElementById('prompt-list-sidebar');
                
                settingsContainer.innerHTML = prompts.map(p => `
                    <div class="provider-item-settings">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium">${p.name_zh} / ${p.name_en}</div>
                                ${p.is_active ? '<div class="text-sm text-green-400">âœ“ å½“å‰ä½¿ç”¨</div>' : '<div class="text-sm text-gray-400">æœªæ¿€æ´»</div>'}
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-secondary text-xs" onclick="togglePromptDetail(${p.id})">
                                    <span id="expand-icon-${p.id}">â–¼</span> æŸ¥çœ‹
                                </button>
                                ${!p.is_active ? `<button class="btn-success text-xs" onclick="activatePrompt(${p.id})">æ¿€æ´»</button>` : ''}
                                <button class="btn-danger text-xs" onclick="deletePrompt(${p.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div id="prompt-detail-${p.id}" class="hidden mt-3 text-sm" style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px;">
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">è¯„å®¡æç¤ºè¯ (ä¸­æ–‡):</div>
                                <textarea id="critique-zh-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.critique_prompt_zh}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">è¯„å®¡æç¤ºè¯ (è‹±æ–‡):</div>
                                <textarea id="critique-en-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.critique_prompt_en}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">ä¿®è®¢æç¤ºè¯ (ä¸­æ–‡):</div>
                                <textarea id="revision-zh-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.revision_prompt_zh}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">ä¿®è®¢æç¤ºè¯ (è‹±æ–‡):</div>
                                <textarea id="revision-en-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.revision_prompt_en}</textarea>
                            </div>
                            <button class="btn-primary text-xs" onclick="updatePrompt(${p.id})">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                `).join('');

                sidebarContainer.innerHTML = prompts.map(p => `
                    <div class="sidebar-item ${p.is_active ? 'active' : ''}" onclick="activatePrompt(${p.id}, true)">
                        <span class="name">${p.name_zh}</span>
                    </div>
                `).join('');

            } catch (e) {
                console.error('åŠ è½½æç¤ºè¯å¤±è´¥:', e);
            }
        }
        
        // å±•å¼€/æ”¶èµ·æç¤ºè¯è¯¦æƒ…
        window.togglePromptDetail = function(id) {
            const detail = document.getElementById(`prompt-detail-${id}`);
            const icon = document.getElementById(`expand-icon-${id}`);
            if (detail.classList.contains('hidden')) {
                detail.classList.remove('hidden');
                icon.textContent = 'â–²';
            } else {
                detail.classList.add('hidden');
                icon.textContent = 'â–¼';
            }
        };
        
        // æ›´æ–°æç¤ºè¯
        window.updatePrompt = async function(id) {
            try {
                const data = {
                    critique_prompt_zh: document.getElementById(`critique-zh-${id}`).value,
                    critique_prompt_en: document.getElementById(`critique-en-${id}`).value,
                    revision_prompt_zh: document.getElementById(`revision-zh-${id}`).value,
                    revision_prompt_en: document.getElementById(`revision-en-${id}`).value
                };
                await api(`/prompts/${id}`, 'PUT', data);
                alert('æ›´æ–°æˆåŠŸ');
                loadPrompts();
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥: ' + e.message);
            }
        };
        
        // æ¿€æ´»æç¤ºè¯
        window.activatePrompt = async function(id, fromSidebar = false) {
            try {
                await api(`/prompts/${id}/activate`, 'POST');
                if (!fromSidebar) {
                    alert('æ¿€æ´»æˆåŠŸ');
                }
                loadPrompts();
            } catch (e) {
                alert('æ¿€æ´»å¤±è´¥: ' + e.message);
            }
        };
        
        // åˆ é™¤æç¤ºè¯
        window.deletePrompt = async function(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æç¤ºè¯?')) return;
            try {
                await api(`/prompts/${id}`, 'DELETE');
                loadPrompts();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        };
        
        // æ·»åŠ æç¤ºè¯
        document.getElementById('add-prompt-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name_zh: form.name_zh.value.trim(),
                name_en: form.name_en.value.trim(),
                critique_prompt_zh: form.critique_zh.value.trim(),
                critique_prompt_en: form.critique_en.value.trim(),
                revision_prompt_zh: form.revision_zh.value.trim(),
                revision_prompt_en: form.revision_en.value.trim()
            };
            try {
                await api('/prompts', 'POST', data);
                form.reset();
                loadPrompts();
                alert('æ·»åŠ æˆåŠŸ');
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        };

        // å†å²è®°å½•åŠŸèƒ½
        function saveChatHistory() {
            try {
                const chatLog = document.getElementById('chat-log');
                if (!chatLog) return;
                
                const messages = [];
                
                chatLog.querySelectorAll('.chat-message').forEach(msg => {
                    const isUser = msg.classList.contains('user');
                    let contentEl = null;
                    
                    if (isUser) {
                        // ç”¨æˆ·æ¶ˆæ¯ï¼šè·å–æœ€åä¸€ä¸ªdivï¼ˆå†…å®¹ï¼‰
                        const divs = msg.querySelectorAll('div');
                        if (divs.length > 1) {
                            contentEl = divs[divs.length - 1];
                        }
                    } else {
                        // AIæ¶ˆæ¯ï¼šå°è¯•å¤šä¸ªå¯èƒ½çš„é€‰æ‹©å™¨
                        contentEl = msg.querySelector('.response-content') || 
                                   msg.querySelector('.final-answer') || 
                                   msg.querySelector('.process-text') ||
                                   (() => {
                                       const divs = msg.querySelectorAll('div');
                                       return divs.length > 1 ? divs[divs.length - 1] : null;
                                   })();
                    }
                    
                    if (contentEl) {
                        const content = contentEl.textContent.trim();
                        // è·³è¿‡ç©ºå†…å®¹å’ŒçŠ¶æ€æ¶ˆæ¯
                        if (content && !content.startsWith('âœ“') && !content.startsWith('âŒ') && 
                            !content.includes('æ­£åœ¨åˆå§‹åŒ–') && !content.includes('æ­£åœ¨') && 
                            content.length > 3) {
                            const timestamp = msg.getAttribute('data-timestamp') || Date.now().toString();
                            messages.push({
                                type: isUser ? 'user' : 'assistant',
                                content: content,
                                timestamp: timestamp
                            });
                        }
                    }
                });
                
                if (messages.length >= 2) { // è‡³å°‘éœ€è¦ä¸€é—®ä¸€ç­”
                    const historyKey = 'chat_history_' + Date.now();
                    const firstUserMsg = messages.find(m => m.type === 'user');
                    const title = firstUserMsg ? (firstUserMsg.content.substring(0, 30) + (firstUserMsg.content.length > 30 ? '...' : '')) : 'å¯¹è¯è®°å½•';
                    
                    const historyItem = {
                        id: historyKey,
                        title: title,
                        messages: messages,
                        createdAt: Date.now()
                    };
                    
                    let allHistory = JSON.parse(S.get('all_chat_history', '[]'));
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å¯¹è¯ï¼ˆé¿å…é‡å¤ä¿å­˜ï¼‰
                    const isDuplicate = allHistory.some(h => {
                        if (h.messages.length !== messages.length) return false;
                        return h.messages.every((m, i) => 
                            m.type === messages[i].type && m.content === messages[i].content
                        );
                    });
                    
                    if (!isDuplicate) {
                        allHistory.unshift(historyItem);
                        // åªä¿ç•™æœ€è¿‘50æ¡
                        if (allHistory.length > 50) {
                            allHistory = allHistory.slice(0, 50);
                        }
                        S.set('all_chat_history', JSON.stringify(allHistory));
                        console.log('å†å²è®°å½•å·²ä¿å­˜ï¼Œå…±', messages.length, 'æ¡æ¶ˆæ¯');
                    }
                }
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }
        
        function loadChatHistory() {
            try {
                console.log('[å†å²è®°å½•] å¼€å§‹åŠ è½½å†å²è®°å½•...');
                const historyContainer = document.getElementById('chat-history');
                if (!historyContainer) {
                    console.error('[å†å²è®°å½•] å†å²è®°å½•å®¹å™¨ä¸å­˜åœ¨');
                    return;
                }
                
                let allHistory = [];
                try {
                    const historyStr = S.get('all_chat_history', '[]');
                    console.log('[å†å²è®°å½•] localStorageä¸­çš„å†å²è®°å½•å­—ç¬¦ä¸²é•¿åº¦:', historyStr.length);
                    allHistory = JSON.parse(historyStr);
                    console.log('[å†å²è®°å½•] æˆåŠŸè§£æå†å²è®°å½•ï¼Œæ•°é‡:', allHistory.length);
                } catch (e) {
                    console.error('[å†å²è®°å½•] è§£æå†å²è®°å½•å¤±è´¥:', e);
                    allHistory = [];
                }
                
                if (!Array.isArray(allHistory) || allHistory.length === 0) {
                    console.log('[å†å²è®°å½•] æ²¡æœ‰å†å²è®°å½•æˆ–æ•°æ®æ— æ•ˆ');
                    const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                    historyContainer.innerHTML = `<div class="text-sm text-gray-400 text-center py-4">${t.noHistory}</div>`;
                    return;
                }
                
                console.log('[å†å²è®°å½•] æ¸²æŸ“', allHistory.length, 'æ¡å†å²è®°å½•');
                const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                historyContainer.innerHTML = allHistory.map(item => {
                    const date = new Date(item.createdAt || Date.now());
                    const dateStr = date.toLocaleString(window.currentLang === 'en' ? 'en-US' : 'zh-CN', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="history-item p-2 hover:bg-gray-800 rounded cursor-pointer mb-1" data-id="${item.id || 'unknown'}">
                            <div class="text-sm text-gray-200 truncate">${item.title || 'æœªå‘½åå¯¹è¯'}</div>
                            <div class="text-xs text-gray-500 mt-1">${dateStr}</div>
                        </div>
                    `;
                }).join('');
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                historyContainer.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const historyItem = allHistory.find(h => h.id === id);
                        if (historyItem && historyPopup) {
                            console.log('[å†å²è®°å½•] åŠ è½½å†å²å¯¹è¯:', historyItem.title);
                            loadHistoryToChat(historyItem);
                            historyPopup.classList.add('hidden');
                        }
                    });
                });
                console.log('[å†å²è®°å½•] å†å²è®°å½•æ¸²æŸ“å®Œæˆ');
            } catch (e) {
                console.error('[å†å²è®°å½•] åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                const historyContainer = document.getElementById('chat-history');
                if (historyContainer) {
                    historyContainer.innerHTML = `<div class="text-sm text-red-400 text-center py-4">åŠ è½½å¤±è´¥: ${e.message}</div>`;
                }
            }
        }
        
        function loadHistoryToChat(historyItem) {
            const chatLog = document.getElementById('chat-log');
            chatLog.innerHTML = '';
            
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            historyItem.messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${msg.type}`;
                msgDiv.setAttribute('data-timestamp', msg.timestamp);
                
                if (msg.type === 'user') {
                    msgDiv.innerHTML = `<div class="font-medium mb-1">${t.user}</div><div>${msg.content}</div>`;
                } else {
                    msgDiv.innerHTML = `<div class="font-medium mb-1 text-purple-400">${t.aiAssistant}</div><div class="response-content">${msg.content}</div>`;
                }
                
                // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æ—¶é—´æˆ³
                if (S.get('sw_timestamps') === '1') {
                    const timeEl = document.createElement('div');
                    timeEl.className = 'message-timestamp';
                    timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                    const date = new Date(parseInt(msg.timestamp));
                    const lang = window.currentLang || 'zh';
                    if (lang === 'en') {
                        timeEl.textContent = date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    } else {
                        timeEl.textContent = date.toLocaleString('zh-CN', { 
                            month: 'numeric', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }
                    msgDiv.appendChild(timeEl);
                }
                
                chatLog.appendChild(msgDiv);
            });
            
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        // å†å²è®°å½•å¼¹çª—
        const historyBtn = document.getElementById('history-btn');
        const historyPopup = document.getElementById('history-popup');
        if (historyBtn && historyPopup) {
            historyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                loadChatHistory();
                historyPopup.classList.toggle('hidden');
            });
        }
        document.addEventListener('click', (e) => {
            if (!historyPopup.contains(e.target) && !historyBtn.contains(e.target)) {
                historyPopup.classList.add('hidden');
            }
        });

        // æ‰‹é£ç´æ•ˆæœ
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                header.classList.toggle('active');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

        // è·³è½¬åˆ°è®¾ç½®é¡µé¢
        document.getElementById('manage-providers-btn').onclick = () => {
            settingsModal.classList.add('active');
            document.querySelector('.settings-nav-item[data-section="models"]').click();
        };
        document.getElementById('manage-prompts-btn').onclick = () => {
            settingsModal.classList.add('active');
            document.querySelector('.settings-nav-item[data-section="prompts"]').click();
        };

        // åˆå§‹åŒ–åŠ è½½
        loadProviders();
        loadPrompts();
    </script>
</body>
</html>