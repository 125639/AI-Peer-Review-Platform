<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå·¥å‚ v14.0 - OCRå¢å¼ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç°ä»£æ·±è‰²ä¸»é¢˜æ ·å¼ - ä»¿ç…§å‚è€ƒå›¾ç•Œé¢ */
        :root {
            --bg-primary: #1a1d23;
            --bg-secondary: #252932;
            --bg-tertiary: #2d3748;
            --bg-card: #323a46;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --accent-blue: #4299e1;
            --accent-purple: #805ad5;
            --border-color: #4a5568;
            --border-light: #3a4553;
        }
        
        /* æµ…è‰²ä¸»é¢˜æ ·å¼ */
        html:not(.dark) {
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-tertiary: #e2e8f0;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --accent-blue: #3182ce;
            --accent-purple: #6b46c1;
            --border-color: #cbd5e0;
            --border-light: #e2e8f0;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        /* å½“æœ‰å£çº¸æ—¶ï¼Œbodyã€htmlã€ä¾§è¾¹æ å’Œä¸»å†…å®¹åŒºèƒŒæ™¯åº”è¯¥é€æ˜ä»¥æ˜¾ç¤ºå£çº¸ */
        html.has-wallpaper,
        body.has-wallpaper {
            background: transparent !important;
            background-image: none !important;
        }
        
        /* æœ‰å£çº¸æ—¶ï¼Œè®©ä¾§è¾¹æ å’Œä¸»å†…å®¹åŒºä¿æŒé€‚åº¦ä¸é€æ˜ä»¥ç¡®ä¿æ–‡å­—æ¸…æ™° */
        body.has-wallpaper .sidebar {
            background: rgba(37, 41, 50, 0.85) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        body.has-wallpaper .main-content {
            background: rgba(26, 29, 35, 0.85) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        html:not(.dark) body.has-wallpaper .sidebar {
            background: rgba(237, 242, 247, 0.92) !important;
        }
        
        html:not(.dark) body.has-wallpaper .main-content {
            background: rgba(247, 250, 252, 0.92) !important;
        }
        
        /* æœ‰å£çº¸æ—¶ï¼Œè¾“å…¥åŒºåŸŸä¹Ÿä½¿ç”¨é€‚åº¦ä¸é€æ˜ä»¥ç¡®ä¿æ–‡å­—æ¸…æ™° */
        body.has-wallpaper .input-area {
            background: rgba(37, 41, 50, 0.85) !important;
            backdrop-filter: blur(10px) !important;
            border-top: 1px solid rgba(74, 85, 104, 0.5) !important;
        }
        
        body.has-wallpaper .input-container {
            background: rgba(50, 58, 70, 0.9) !important;
            backdrop-filter: blur(5px) !important;
            border: 1px solid rgba(58, 69, 83, 0.6) !important;
        }
        
        html:not(.dark) body.has-wallpaper .input-area {
            background: rgba(237, 242, 247, 0.92) !important;
            border-top: 1px solid rgba(203, 213, 224, 0.5) !important;
        }
        
        html:not(.dark) body.has-wallpaper .input-container {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(226, 232, 240, 0.6) !important;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            filter: none;
            z-index: -2;
            pointer-events: none;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            pointer-events: none;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { 
            background: var(--text-muted); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow-y: auto;
            transition: width 0.3s ease, min-width 0.3s ease;
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden;
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-toggle:hover {
            background: var(--accent-blue);
            color: white;
            transform: scale(1.05);
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            background: var(--bg-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .tab-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            flex: 1;
        }
        
        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }
        
        .tab-btn:hover:not(.active) {
            background: rgba(66, 153, 225, 0.1);
            color: var(--text-primary);
        }
        
        /* å¡ç‰‡é¢æ¿æ ·å¼ */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        
        .btn-success {
            background: #38a169;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        /* æœåŠ¡å•†é¡¹ç›®æ ·å¼ */
        .provider-item {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .provider-item:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .evaluation-process {
            background: rgba(37, 41, 50, 0.6);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        /* ç®€è¦æ¨¡å¼ï¼šåªæ˜¾ç¤ºç®€æ´çš„è¡Œ */
        .evaluation-process.simple {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .evaluation-process.simple .process-line {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
            padding: 4px 0;
        }

        .evaluation-process.simple .process-block {
            display: none !important; /* ç®€è¦æ¨¡å¼ä¸‹éšè—è¯¦ç»†å— */
        }

        /* è¯¦ç»†æ¨¡å¼ï¼šæ˜¾ç¤ºå®Œæ•´çš„å—çŠ¶å†…å®¹ */
        .evaluation-process.detailed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .evaluation-process.detailed .process-line {
            display: none !important; /* è¯¦ç»†æ¨¡å¼ä¸‹éšè—ç®€æ´è¡Œ */
        }

        .evaluation-process .process-block {
            background: rgba(50, 58, 70, 0.55);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
        }

        .evaluation-process .process-block h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #c4c9d4;
        }

        .evaluation-process .process-text {
            white-space: pre-wrap;
            font-size: 13px;
            color: #e2e8f0;
            line-height: 1.5;
        }

.evaluation-process .process-line strong {
    color: #cbd5f5;
}

.process-toggle:hover {
    background: rgba(66, 153, 225, 0.1);
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

.process-wrapper {
    margin-top: 8px;
}

.final-answer {
    border-left: 3px solid var(--accent-purple);
    padding-left: 12px;
    margin-bottom: 8px;
}

.evaluation-status {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.evaluation-status.completed {
    animation: none;
    opacity: 1;
}        /* æœåŠ¡å•†é¡¹ç›®æ ·å¼ */
        .provider-item {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .provider-item:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }
        
        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-message {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--accent-purple);
            animation: fadeIn 0.3s ease-in;
            max-width: 75%;
        }
        
        .chat-message.user {
            background: rgba(66, 153, 225, 0.15);
            border-left-color: var(--accent-blue);
            margin-left: auto;
            margin-right: 0;
        }
        
        .chat-message.assistant {
            margin-right: auto;
            margin-left: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        .app-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .version-info {
            color: var(--text-muted);
            font-size: 12px;
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1000;
        }
        
        .theme-toggle:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
        }
        
        .input-container {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px 8px 8px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toolbar-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            resize: none;
            outline: none;
            min-height: 40px;
            max-height: 200px;
            padding: 8px;
            font-size: 1rem;
        }
        
        .message-input::placeholder {
            color: var(--text-muted);
        }
        
        .submit-btn-wrapper {
            display: flex;
            justify-content: flex-end;
            padding-top: 8px;
        }

        #submit-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        #submit-btn:hover {
            background: #3182ce;
        }
        #submit-btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
        }

        /* éšè—å†…å®¹ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* é€‰æ‹©æ¡†æ ·å¼ */
        select.form-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 32px;
        }
        
        /* å¤é€‰æ¡†æ ·å¼ */
        .model-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .model-checkbox:hover {
            background: var(--bg-card);
            border-color: var(--accent-blue);
        }
        
        .model-checkbox input[type="checkbox"] {
            margin-right: 8px;
            accent-color: var(--accent-blue);
        }
        
        /* è®¾ç½®åŒºåŸŸä¸­çš„æœåŠ¡å•†å¡ç‰‡ */
        .provider-item-settings {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
        }
        
        .provider-item-settings:hover {
            border-color: var(--accent-blue);
            background: rgba(66, 153, 225, 0.05);
        }
        
        /* ç´§å‡‘æ¨¡å¼ */
        body.compact .panel { padding: 12px; }
        body.compact .settings-item { padding: 10px 0; }
        body.compact .chat-message { padding: 12px; margin-bottom: 12px; }
        body.compact .settings-group { margin-bottom: 20px; }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-message {
                max-width: 90%;
            }
            
            .sidebar-toggle {
                left: 10px !important;
            }
        }
        
        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .settings-btn:hover {
            background: var(--accent-blue);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }
        
        .settings-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .settings-dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            height: 80%;
            max-height: 600px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .settings-sidebar {
            width: 240px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .settings-nav-item {
            padding: 10px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-nav-item:hover {
            background: rgba(66, 153, 225, 0.1);
            color: var(--text-primary);
        }
        
        .settings-nav-item.active {
            background: rgba(66, 153, 225, 0.15);
            color: var(--accent-blue);
            border-left-color: var(--accent-blue);
        }
        
        .settings-section {
            display: none;
        }
        
        .settings-section.active {
            display: block;
        }
        
        .settings-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .settings-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .settings-group {
            margin-bottom: 30px;
        }
        
        .settings-group-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-item-info {
            flex: 1;
        }
        
        .settings-item-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .settings-item-desc {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .settings-toggle {
            width: 44px;
            height: 24px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-toggle.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .settings-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .settings-toggle.active::after {
            transform: translateX(20px);
        }
        
        .settings-select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            min-width: 150px;
            cursor: pointer;
        }
        
        .settings-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .settings-close:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        /* ä¾§è¾¹æ æ‰‹é£ç´ */
        .settings-accordion .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .settings-accordion .accordion-header:hover {
            background: var(--bg-card);
        }
        .settings-accordion .accordion-header .chevron {
            transition: transform 0.2s;
        }
        .settings-accordion .accordion-header.active .chevron {
            transform: rotate(180deg);
        }
        .settings-accordion .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: var(--bg-primary);
            border-radius: 0 0 6px 6px;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sidebar-item:hover {
            background: var(--bg-secondary);
        }
        .sidebar-item.active {
            background: var(--accent-blue);
            color: white;
        }
        .sidebar-item .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar w-80 flex-shrink-0" id="sidebar">
            <div class="p-6 h-full flex flex-col">
                <!-- æ ‡é¢˜å’Œå†å²è®°å½•æŒ‰é’® -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="app-title">AIå·¥å‚</h1>
                        <p class="version-info">v15.0 - Linus Edition</p>
                    </div>
                    <div class="relative">
                        <button id="history-btn" class="p-2 rounded-md hover:bg-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                        <div id="history-popup" class="hidden absolute top-full right-0 mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-lg z-20">
                            <div class="p-3 border-b border-gray-700 font-semibold">å†å²è®°å½•</div>
                            <div id="chat-history" class="p-2 max-h-80 overflow-y-auto">
                                <div class="text-sm text-gray-400 text-center py-4">æš‚æ— å†å²è®°å½•</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯æŠ˜å çš„è®¾ç½®åŒºåŸŸ -->
                <div class="flex-1 overflow-y-auto -mr-6 pr-4">
                    <div class="space-y-4">
                        <div class="settings-accordion">
                            <button class="accordion-header">
                                <span>ğŸ¤– æ¨¡å‹é…ç½®</span>
                                <svg class="w-4 h-4 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="accordion-content">
                                <div id="model-list-sidebar" class="space-y-2 p-2"></div>
                                <button id="manage-providers-btn" class="btn-secondary text-xs w-full mt-2">ç®¡ç†æœåŠ¡å•†</button>
                            </div>
                        </div>
                        <div class="settings-accordion">
                            <button class="accordion-header">
                                <span>ğŸ’¬ æç¤ºè¯ç®¡ç†</span>
                                <svg class="w-4 h-4 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="accordion-content">
                                <div id="prompt-list-sidebar" class="space-y-2 p-2"></div>
                                <button id="manage-prompts-btn" class="btn-secondary text-xs w-full mt-2">ç®¡ç†æç¤ºè¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®¾ç½®æŒ‰é’® -->
            <button class="settings-btn" id="settings-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span data-i18n="settings">è®¾ç½®</span>
            </button>
        </aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content flex-1">
            <!-- ä¾§è¾¹æ æ”¶èµ·æŒ‰é’® -->
            <button class="sidebar-toggle" id="sidebar-toggle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            
            <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
            <button id="theme-toggle" class="theme-toggle">
                ğŸŒ™ æš—è‰²
            </button>
            
            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="chat-area" id="chat-log">
                <!-- ç¤ºä¾‹å¯¹è¯ -->
                <div class="chat-message user">
                    <div class="font-medium mb-1">ç”¨æˆ·</div>
                    <div>é˜¿é‡Œäº‘ä¸åä¸ºäº‘å“ªä¸ªå¯¹ç”¨æˆ·å‹å¥½ï¼Ÿ</div>
                </div>
                
                <div class="chat-message assistant">
                    <div class="font-medium mb-1 text-purple-400">AIåŠ©æ‰‹</div>
                    <div class="mb-3">
                        è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯å¾ˆå¤šæ–°ç”¨æˆ·åœ¨é€‰å‹æ—¶é¦–å…ˆè€ƒè™‘çš„ã€‚è¦å›ç­”"é˜¿é‡Œäº‘å’Œåä¸ºäº‘å“ªä¸ªå¯¹ç”¨æˆ·æ›´å‹å¥½"ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸åŒç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå› ä¸º"å‹å¥½"çš„å®šä¹‰å› äººè€Œå¼‚ã€‚
                    </div>
                    <div class="mb-3">
                        <strong>æ€»çš„æ¥è¯´ï¼šä¸¤è€…éƒ½éå¸¸å‡ºè‰²ï¼Œä½†ä¾§é‡ç‚¹ä¸åŒã€‚é˜¿é‡Œäº‘å¯¹å¼€å‘è€…ã€åˆåˆ›ä¼ä¸šå’Œäº’è”ç½‘ä¸šåŠ¡æ›´å‹å¥½ï¼›åä¸ºäº‘å¯¹ä¼ ç»Ÿä¼ä¸šã€æ”¿ä¼å®¢æˆ·å’Œæœ‰å¼ºçƒˆå›½äº§åŒ–éœ€æ±‚çš„ä¼ä¸šæ›´å‹å¥½ã€‚</strong>
                    </div>
                    <div class="mb-3">ä¸‹é¢æˆ‘ä»å‡ ä¸ªæ ¸å¿ƒç»´åº¦è¿›è¡Œè¯¦ç»†å¯¹æ¯”ï¼š</div>
                    
                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">### 1. äº§å“æ˜“ç”¨æ€§ä¸æ§åˆ¶å°</h4>
                        <div class="ml-4 space-y-2">
                            <div><strong>â€¢ é˜¿é‡Œäº‘ï¼š</strong></div>
                            <div><strong>â€¢ ä¼˜ç‚¹ï¼š</strong> èµ·æ­¥æ—©ã€æ§åˆ¶å°ç»è¿‡å¤šæ¬¡ä¼˜åŒ–ï¼Œç•Œé¢ç›¸å¯¹æ›´ç°ä»£åŒ–ã€æ›´ç®€æ´ã€‚åŠŸèƒ½é€»è¾‘ç›¸å¯¹è´´è¿‘å¼€å‘è€…çš„æ€ç»´ä¹ æƒ¯ï¼Œæ–‡æ¡£å’Œå¼•å¯¼éå¸¸å®Œå–„ã€‚</div>
                            <div><strong>â€¢ å…·ä½“ä½“éªŒï¼š</strong> ä»¥åˆ›å»ºäº‘æœåŠ¡å™¨ï¼ˆECSï¼‰ä¸ºä¾‹ï¼Œé˜¿é‡Œäº‘æä¾›ä¸€é”®è´­ä¹°å’Œå‘å¯¼å¼é…ç½®ï¼Œæµç¨‹ç›´è§‚ï¼Œé€‚åˆå¿«é€Ÿéƒ¨ç½²ã€‚ä¾‹å¦‚ï¼Œåœ¨é…ç½®ç½‘ç»œæ—¶ï¼Œé»˜è®¤é€‰é¡¹ä¼˜åŒ–äº†å¸¸è§åœºæ™¯ï¼Œå‡å°‘äº†æ–°æ‰‹å›°æƒ‘ã€‚</div>
                            <div><strong>â€¢ ç¼ºç‚¹ï¼š</strong> äº§å“çº¿æå…¶åºå¤§ï¼Œæ–°æ‰‹å¯èƒ½ä¼šåœ¨ä¼—å¤šäº§å“ä¸­æ„Ÿåˆ°å›°æƒ‘ã€‚éƒ¨åˆ†è€ç‰ˆæ§åˆ¶å°å’Œæ–°ç‰ˆæ§åˆ¶å°ä½“éªŒä¸ç»Ÿä¸€ã€‚</div>
                        </div>
                        
                        <div class="ml-4 mt-4 space-y-2">
                            <div><strong>â€¢ åä¸ºäº‘ï¼š</strong></div>
                            <div><strong>â€¢ ä¼˜ç‚¹ï¼š</strong> æ§åˆ¶å°è¿‘å¹´æ¥è¿›æ­¥å·¨å¤§ï¼Œç•Œé¢æ¸…æ™°ï¼Œå¸ƒå±€è§„æ•´ã€‚åœ¨æ“ä½œæµç¨‹ä¸Šï¼Œæ›´åå‘äºä¼ä¸šçº§çš„ä¸¥è°¨å’Œæ­¥éª¤åŒ–ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn" id="new-chat-btn" title="æ–°å¯¹è¯">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button class="toolbar-btn" id="select-image-btn" title="ä¸Šä¼ å›¾ç‰‡">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                            <input type="file" id="image-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="toolbar-group">
                            <span class="text-xs text-gray-500" id="token-counter">0/2000</span>
                        </div>
                    </div>
                    <textarea 
                        class="message-input" 
                        placeholder="åœ¨è¿™é‡Œè¾“å…¥æ¶ˆæ¯, æŒ‰ Enter å‘é€"
                        rows="1"
                        id="question-input"
                    ></textarea>
                    <div class="submit-btn-wrapper">
                        <button id="submit-btn" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-dialog">
            <button class="settings-close" id="settings-close">&times;</button>
            
            <!-- å·¦ä¾§å¯¼èˆª -->
            <div class="settings-sidebar">
                <div class="settings-nav-item active" data-section="general">
                    <span>âš™ï¸</span>
                    <span data-i18n="preference">åå¥½</span>
                </div>
                <div class="settings-nav-item" data-section="appearance">
                    <span>ğŸ¨</span>
                    <span data-i18n="appearance">å¤–è§‚</span>
                </div>
                <div class="settings-nav-item" data-section="models">
                    <span>ğŸ¤–</span>
                    <span data-i18n="models">æ¨¡å‹</span>
                </div>
                <div class="settings-nav-item" data-section="prompts">
                    <span>ğŸ’¬</span>
                    <span data-i18n="prompts">æç¤ºè¯</span>
                </div>
                <div class="settings-nav-item" data-section="advanced">
                    <span>ğŸ”§</span>
                    <span data-i18n="advanced">é«˜çº§</span>
                </div>
            </div>
            
            <!-- å³ä¾§å†…å®¹ -->
            <div class="settings-content">
                <!-- åå¥½è®¾ç½® -->
                <div class="settings-section active" id="general-section">
                    <h2 class="settings-title" data-i18n="preference">åå¥½</h2>
                    <p class="settings-subtitle" data-i18n="basicSettings">åŸºç¡€è®¾ç½®ï¼Œä¿æŒç®€å•ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="interface">ç•Œé¢</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="theme">ä¸»é¢˜</div>
                            </div>
                            <select class="settings-select" id="theme-mode-select">
                                <option value="dark">æ·±è‰²</option>
                                <option value="light">æµ…è‰²</option>
                            </select>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="language">è¯­è¨€</div>
                            </div>
                            <select class="settings-select" id="language-select">
                                <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="behavior">è¡Œä¸º</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="autoSave">è‡ªåŠ¨ä¿å­˜å¯¹è¯</div>
                            </div>
                            <div class="settings-toggle active" data-setting="auto-save"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="showTimestamps">æ˜¾ç¤ºæ—¶é—´æˆ³</div>
                            </div>
                            <div class="settings-toggle active" data-setting="timestamps"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="soundNotification">å£°éŸ³æç¤º</div>
                            </div>
                            <div class="settings-toggle" data-setting="sound"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å¤–è§‚è®¾ç½® -->
                <div class="settings-section" id="appearance-section">
                    <h2 class="settings-title" data-i18n="appearance">å¤–è§‚</h2>
                    <p class="settings-subtitle" data-i18n="lessIsMore">å°‘å³æ˜¯å¤šã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="display">æ˜¾ç¤º</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="fontSize">å­—ä½“å¤§å°</div>
                            </div>
                            <select class="settings-select" id="font-size-select">
                                <option value="14">å° (14px)</option>
                                <option value="16" selected>ä¸­ (16px)</option>
                                <option value="18">å¤§ (18px)</option>
                            </select>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="compactMode">ç´§å‡‘æ¨¡å¼</div>
                            </div>
                            <div class="settings-toggle" data-setting="compact"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="defaultSidebarOpen">é»˜è®¤å±•å¼€ä¾§è¾¹æ </div>
                            </div>
                            <div class="settings-toggle active" data-setting="sidebar-open"></div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="wallpaperSettings">å£çº¸è®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <input type="file" id="wallpaper-upload" accept="image/*" style="display:none">
                                <button id="wallpaper-upload-btn" class="btn-primary text-sm">ä¸Šä¼ å£çº¸</button>
                                <button id="reset-wallpaper-btn" class="btn-danger text-sm ml-2">æ¢å¤é»˜è®¤</button>
                                <div id="wallpaper-status" class="text-xs mt-2 text-gray-400"></div>
                            </div>
                            
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title" data-i18n="opacity">é€æ˜åº¦</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="10" max="100" value="100" step="1" id="wallpaper-opacity" class="flex-1">
                                    <span id="wallpaper-opacity-label" class="text-sm w-12 text-right">100%</span>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title" data-i18n="brightness">äº®åº¦</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="20" max="200" value="100" step="1" id="wallpaper-brightness" class="flex-1">
                                    <span id="wallpaper-brightness-label" class="text-sm w-12 text-right">100%</span>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title" data-i18n="blur">æ¨¡ç³Šç¨‹åº¦</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="0" max="20" value="0" step="1" id="wallpaper-blur" class="flex-1">
                                    <span id="wallpaper-blur-label" class="text-sm w-12 text-right">0px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¯­è¨€ä¸æ—¶é—´è®¾ç½® -->
                <div class="settings-section" id="language-section">
                    <h2 class="settings-title">è¯­è¨€</h2>
                    <p class="settings-subtitle">è¿™éƒ¨åˆ†å·²ç»åˆå¹¶åˆ°"åå¥½"ä¸­äº†ã€‚</p>
                </div>
                
                <!-- AIæ¨¡å‹é…ç½® -->
                <div class="settings-section" id="models-section">
                    <h2 class="settings-title" data-i18n="modelConfig">æ¨¡å‹é…ç½®</h2>
                    <p class="settings-subtitle" data-i18n="manageAIServices">ç®¡ç†AIæœåŠ¡å•†åŠæ¨¡å‹ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="serviceProviderList">æœåŠ¡å•†åˆ—è¡¨</h3>
                        <div id="provider-list-settings" class="space-y-3 mb-6"></div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="addNewProvider">æ·»åŠ æ–°æœåŠ¡å•†</h3>
                        <form id="add-provider-form" class="space-y-3 mb-6">
                            <input name="name" required class="form-input" placeholder="æœåŠ¡å•†åç§°" style="width: 100%;">
                            <select name="type" required class="form-input" style="width: 100%;">
                                <option value="" disabled selected>ç±»å‹</option>
                                <option value="OpenAI">OpenAI</option>
                                <option value="Gemini">Gemini</option>
                            </select>
                            <input name="api_key" type="password" required class="form-input" placeholder="API Key" style="width: 100%;">
                            <input name="api_base" class="form-input" placeholder="Base URL (OpenAIå¿…å¡«)" style="width: 100%;">
                            <input name="models" required class="form-input" placeholder="æ¨¡å‹åˆ—è¡¨ (é€—å·åˆ†éš”)" style="width: 100%;">
                            <button type="submit" class="btn-success" style="width: 100%;">æ·»åŠ </button>
                        </form>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="modelSelection">æ¨¡å‹é€‰æ‹©</h3>
                        <div id="model-list-settings" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
                
                <!-- æç¤ºè¯ç®¡ç† -->
                <div class="settings-section" id="prompts-section">
                    <h2 class="settings-title" data-i18n="prompts">æç¤ºè¯</h2>
                    <p class="settings-subtitle" data-i18n="managePromptTemplates">ç®¡ç†å¯¹è¯æç¤ºè¯æ¨¡æ¿ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="promptList">æç¤ºè¯åˆ—è¡¨</h3>
                        <div id="prompt-list-settings" class="space-y-3 mb-6"></div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="addNewPrompt">æ·»åŠ æ–°æç¤ºè¯</h3>
                        <form id="add-prompt-form" class="space-y-3">
                            <input name="name_zh" required class="form-input" placeholder="ä¸­æ–‡åç§°" style="width: 100%;">
                            <input name="name_en" required class="form-input" placeholder="English Name" style="width: 100%;">
                            <textarea name="critique_zh" required class="form-input h-16" placeholder="è¯„å®¡æç¤ºè¯ï¼ˆä¸­æ–‡ï¼‰" style="width: 100%;"></textarea>
                            <textarea name="critique_en" required class="form-input h-16" placeholder="Critique Prompt (English)" style="width: 100%;"></textarea>
                            <textarea name="revision_zh" required class="form-input h-16" placeholder="ä¿®è®¢æç¤ºè¯ï¼ˆä¸­æ–‡ï¼‰" style="width: 100%;"></textarea>
                            <textarea name="revision_en" required class="form-input h-16" placeholder="Revision Prompt (English)" style="width: 100%;"></textarea>
                            <button type="submit" class="btn-success" style="width: 100%;">æ·»åŠ </button>
                        </form>
                    </div>
                </div>
                
                <!-- é«˜çº§è®¾ç½® -->
                <div class="settings-section" id="advanced-section">
                    <h2 class="settings-title" data-i18n="advanced">é«˜çº§</h2>
                    <p class="settings-subtitle" data-i18n="advancedSettings">ä»…åœ¨ä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆæ—¶ä½¿ç”¨ã€‚</p>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="debug">è°ƒè¯•</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="debugMode">è°ƒè¯•æ¨¡å¼</div>
                            </div>
                            <div class="settings-toggle" data-setting="debug"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="apiLog">APIæ—¥å¿—</div>
                            </div>
                            <div class="settings-toggle" data-setting="api-log"></div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="evaluationDisplayGroup">äº’è¯„å±•ç¤º</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="evaluationDisplay">äº’è¯„è¿‡ç¨‹å±•ç¤ºç¨‹åº¦</div>
                                <div class="settings-item-desc" data-i18n="evaluationDisplayDesc">é€‰æ‹©å‘ç”¨æˆ·å±•ç¤ºçš„æ¨¡å‹äº’è¯„ç»†èŠ‚å±‚çº§ã€‚</div>
                            </div>
                            <select class="settings-select" id="evaluation-display-select">
                                <option value="simple">ç®€è¦æ­¥éª¤ï¼ˆé»˜è®¤ï¼‰</option>
                                <option value="detailed">å®Œæ•´è¿‡ç¨‹</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="performance">æ€§èƒ½</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="requestTimeout">è¯·æ±‚è¶…æ—¶ (ç§’)</div>
                            </div>
                            <input type="number" class="settings-select" id="timeout-input" value="30" min="5" max="120" style="width: 80px;">
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="maxRetry">æœ€å¤§é‡è¯•</div>
                            </div>
                            <input type="number" class="settings-select" id="retry-input" value="2" min="0" max="5" style="width: 80px;">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3 class="settings-group-title" data-i18n="data">æ•°æ®</h3>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title" data-i18n="historyRetention">å†å²ä¿ç•™ (å¤©)</div>
                            </div>
                            <select class="settings-select" id="retention-select">
                                <option value="7">7</option>
                                <option value="30" selected>30</option>
                                <option value="90">90</option>
                                <option value="-1">æ°¸ä¹…</option>
                            </select>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-title">æ“ä½œ</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-primary text-xs" id="export-btn">å¯¼å‡º</button>
                                <button class="btn-danger text-xs" id="clear-btn">æ¸…é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/script.js?v=20251031003000"></script>
    <script>
        // è®¾ç½®ç³»ç»Ÿ - ä¿è¯åœ¨ä»»ä½•è°ƒç”¨ S ä¹‹å‰å®šä¹‰
        const S = {
            get: (k, d) => localStorage.getItem(k) || d,
            set: (k, v) => localStorage.setItem(k, v),
            apply: (k, fn) => fn(S.get(k))
        };

        // ç®€å•çš„æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // è®¾ç½®å½“å‰æ´»åŠ¨çŠ¶æ€
                btn.classList.add('active');
                const tabId = btn.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ - å®æ—¶åé¦ˆ
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            S.set('theme', isDark ? 'dark' : 'light');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) {
                themeBtn.textContent = isDark ? 'ğŸŒ™ æš—è‰²' : 'â˜€ï¸ äº®è‰²';
            }
            
            // æ›´æ–°ä¸»é¢˜æ¨¡å¼é€‰æ‹©å™¨
            const themeModeSelect = document.getElementById('theme-mode-select');
            if (themeModeSelect) {
                themeModeSelect.value = isDark ? 'dark' : 'light';
            }
            
            // é‡æ–°åº”ç”¨å£çº¸ï¼ˆå› ä¸ºä¸»é¢˜åˆ‡æ¢å¯èƒ½å½±å“èƒŒæ™¯ï¼‰
            applyBgImage();
        }
        
        // åˆå§‹åŒ–ä¸»é¢˜
        const savedTheme = S.get('theme', 'dark');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) themeBtn.textContent = 'ğŸŒ™ æš—è‰²';
        } else {
            document.documentElement.classList.remove('dark');
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) themeBtn.textContent = 'â˜€ï¸ äº®è‰²';
        }
        
        // ç¡®ä¿ä¸»é¢˜é€‰æ‹©å™¨åŒæ­¥
        const themeModeSelect = document.getElementById('theme-mode-select');
        if (themeModeSelect) {
            themeModeSelect.value = savedTheme;
        }
        
        // ç»‘å®šä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        const themeToggleBtn = document.getElementById('theme-toggle');
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', toggleTheme);
        }
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        const messageInput = document.getElementById('question-input');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        // è®¾ç½®æ¨¡æ€æ¡†åŠŸèƒ½
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsClose = document.getElementById('settings-close');
        
        // æ‰“å¼€è®¾ç½®
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });
        
        // å…³é—­è®¾ç½®
        settingsClose.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        });
        
        // è®¾ç½®å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.settings-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.settings-nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.settings-section').forEach(section => section.classList.remove('active'));
                
                // è®¾ç½®å½“å‰æ´»åŠ¨çŠ¶æ€
                item.classList.add('active');
                const sectionId = item.getAttribute('data-section') + '-section';
                document.getElementById(sectionId).classList.add('active');
            });
        });
        
        // ä¾§è¾¹æ æ”¶èµ·åŠŸèƒ½
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebar', sidebar.classList.contains('collapsed') ? '0' : '1');
        });
        
        // æ¢å¤çŠ¶æ€
        if (localStorage.getItem('sidebar') === '0') sidebar.classList.add('collapsed');
        
        // ä¸»é¢˜
        const theme = document.getElementById('theme-mode-select');
        theme.value = S.get('theme', 'dark');
        theme.onchange = e => {
            const val = e.target.value;
            S.set('theme', val);
            if (val === 'dark') {
                document.documentElement.classList.add('dark');
                const themeBtn = document.getElementById('theme-toggle');
                if (themeBtn) themeBtn.textContent = 'ğŸŒ™ æš—è‰²';
            } else {
                document.documentElement.classList.remove('dark');
                const themeBtn = document.getElementById('theme-toggle');
                if (themeBtn) themeBtn.textContent = 'â˜€ï¸ äº®è‰²';
            }
        };
        // åˆå§‹åŒ–ä¸»é¢˜ï¼ˆå·²åœ¨ä¸Šé¢å¤„ç†ï¼‰
        
        // äº’è¯„å±•ç¤ºå±‚çº§
        const evaluationDisplaySelect = document.getElementById('evaluation-display-select');
        if (evaluationDisplaySelect) {
            evaluationDisplaySelect.value = S.get('evaluation_display', 'simple');
            evaluationDisplaySelect.onchange = (e) => {
                S.set('evaluation_display', e.target.value);
            };
        }

        // è¯­è¨€
        const lang = document.getElementById('language-select');
        lang.value = S.get('lang', 'zh');
        lang.onchange = e => {
            S.set('lang', e.target.value);
            applyLanguage(e.target.value);
        };
        
        // è¯­è¨€ç¿»è¯‘å­—å…¸
        const i18n = {
            zh: {
                newChat: 'æ–°å¯¹è¯',
                selectImage: 'é€‰æ‹©å›¾ç‰‡',
                placeholder: 'åœ¨è¿™é‡Œè¾“å…¥æ¶ˆæ¯, æŒ‰ Enter å‘é€',
                chatHistory: 'å†å²è®°å½•',
                noHistory: 'æš‚æ— å†å²è®°å½•',
                settings: 'è®¾ç½®',
                user: 'ç”¨æˆ·',
                aiAssistant: 'AIåŠ©æ‰‹',
                newChatStarted: 'æ–°å¯¹è¯å·²å¼€å§‹',
                selectModelFirst: 'è¯·å…ˆåœ¨ä¾§è¾¹æ é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¨¡å‹',
                imageUploaded: 'å·²ä¸Šä¼ å›¾ç‰‡ï¼š',
                aiFactory: 'AIå·¥å‚',
                preference: 'åå¥½',
                appearance: 'å¤–è§‚',
                models: 'æ¨¡å‹',
                prompts: 'æç¤ºè¯',
                advanced: 'é«˜çº§',
                theme: 'ä¸»é¢˜',
                language: 'è¯­è¨€',
                dark: 'æ·±è‰²',
                light: 'æµ…è‰²',
                simplifiedChinese: 'ç®€ä½“ä¸­æ–‡',
                english: 'English',
                autoSave: 'è‡ªåŠ¨ä¿å­˜å¯¹è¯',
                showTimestamps: 'æ˜¾ç¤ºæ—¶é—´æˆ³',
                soundNotification: 'å£°éŸ³æç¤º',
                fontSize: 'å­—ä½“å¤§å°',
                compactMode: 'ç´§å‡‘æ¨¡å¼',
                defaultSidebarOpen: 'é»˜è®¤å±•å¼€ä¾§è¾¹æ ',
                wallpaperSettings: 'å£çº¸è®¾ç½®',
                opacity: 'é€æ˜åº¦',
                brightness: 'äº®åº¦',
                blur: 'æ¨¡ç³Šç¨‹åº¦',
                uploadWallpaper: 'ä¸Šä¼ å£çº¸',
                resetWallpaper: 'æ¢å¤é»˜è®¤',
                evaluationDisplay: 'äº’è¯„è¿‡ç¨‹å±•ç¤ºç¨‹åº¦',
                simpleSteps: 'ç®€è¦æ­¥éª¤ï¼ˆé»˜è®¤ï¼‰',
                fullProcess: 'å®Œæ•´è¿‡ç¨‹',
                debugMode: 'è°ƒè¯•æ¨¡å¼',
                apiLog: 'APIæ—¥å¿—',
                requestTimeout: 'è¯·æ±‚è¶…æ—¶ (ç§’)',
                maxRetry: 'æœ€å¤§é‡è¯•',
                historyRetention: 'å†å²ä¿ç•™ (å¤©)',
                permanent: 'æ°¸ä¹…',
                export: 'å¯¼å‡º',
                clear: 'æ¸…é™¤',
                confirmClearAll: 'ç¡®å®šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ',
                evaluationStarted: 'äº’è¯„æµç¨‹å·²å¯åŠ¨ï¼Œæ­£åœ¨ç­‰å¾…ç»“æœ...',
                initialAnswerComplete: 'å·²å®Œæˆåˆå§‹ç­”æ¡ˆ',
                initialAnswer: 'åˆå§‹ç­”æ¡ˆ',
                critiqueComplete: 'å·²å®Œæˆå¯¹ {target} çš„è¯„åˆ†ï¼Œå¾—åˆ† {score}',
                critiqueFor: 'å¯¹ {target} çš„è¯„å®¡',
                totalScore: 'æ€»åˆ†',
                accuracy: 'å‡†ç¡®æ€§',
                completeness: 'å®Œæ•´æ€§',
                clarity: 'æ¸…æ™°æ€§',
                usefulness: 'å®ç”¨æ€§',
                revisionComplete: 'å·²æäº¤æ”¹è¿›ç­”æ¡ˆ',
                revisedAnswer: 'æ”¹è¿›ç­”æ¡ˆ',
                evaluationComplete: 'âœ“ äº’è¯„å®Œæˆï¼Œç­”æ¡ˆå·²ç”Ÿæˆ',
                answerGenerated: 'âœ“ ç­”æ¡ˆå·²ç”Ÿæˆ',
                finalAnswerGenerated: 'æœ€ç»ˆç­”æ¡ˆå·²ç”Ÿæˆã€‚',
                processingFailed: 'âŒ å¤„ç†å¤±è´¥',
                evaluationTerminated: 'äº’è¯„æµç¨‹å·²ç»ˆæ­¢ã€‚',
                requestFailed: 'è¯·æ±‚å¤±è´¥',
                showProcess: 'â–¼ æŸ¥çœ‹äº’è¯„è¿‡ç¨‹',
                hideProcess: 'â–² æ”¶èµ·äº’è¯„è¿‡ç¨‹',
                noContent: '(æ— å†…å®¹)',
                uploadingWallpaper: 'æ­£åœ¨å¤„ç†å£çº¸...',
                wallpaperUpdated: 'å£çº¸å·²æ›´æ–°ã€‚',
                wallpaperReset: 'å·²æ¢å¤é»˜è®¤å£çº¸ã€‚',
                wallpaperSaved: 'å½“å‰å·²ä½¿ç”¨è‡ªå®šä¹‰å£çº¸ã€‚',
                wallpaperDefault: 'ä½¿ç”¨é»˜è®¤å£çº¸ã€‚',
                wallpaperError: 'ä¿å­˜å¤±è´¥ï¼šæµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚',
                wallpaperFileError: 'æ–‡ä»¶è¯»å–å¤±è´¥ã€‚',
                wallpaperSizeError: 'å›¾ç‰‡å¤§äº 4MBï¼Œè¯·å‹ç¼©åå†è¯•ã€‚',
                confirmResetWallpaper: 'ç¡®å®šæ¢å¤é»˜è®¤å£çº¸ï¼Ÿ',
                noAnswerAvailable: 'æš‚æ— å¯ç”¨ç­”æ¡ˆ',
                evaluationDisplayGroup: 'äº’è¯„å±•ç¤º',
                evaluationDisplayDesc: 'é€‰æ‹©å‘ç”¨æˆ·å±•ç¤ºçš„æ¨¡å‹äº’è¯„ç»†èŠ‚å±‚çº§ã€‚',
                behavior: 'è¡Œä¸º',
                modelConfig: 'æ¨¡å‹é…ç½®',
                promptManagement: 'æç¤ºè¯ç®¡ç†',
                manageProviders: 'ç®¡ç†æœåŠ¡å•†',
                managePrompts: 'ç®¡ç†æç¤ºè¯',
                basicSettings: 'åŸºç¡€è®¾ç½®ï¼Œä¿æŒç®€å•ã€‚',
                manageAIServices: 'ç®¡ç†AIæœåŠ¡å•†åŠæ¨¡å‹ã€‚',
                managePromptTemplates: 'ç®¡ç†å¯¹è¯æç¤ºè¯æ¨¡æ¿ã€‚',
                advancedSettings: 'ä»…åœ¨ä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆæ—¶ä½¿ç”¨ã€‚',
                interface: 'ç•Œé¢',
                display: 'æ˜¾ç¤º',
                performance: 'æ€§èƒ½',
                data: 'æ•°æ®',
                debug: 'è°ƒè¯•',
                serviceProviderList: 'æœåŠ¡å•†åˆ—è¡¨',
                addNewProvider: 'æ·»åŠ æ–°æœåŠ¡å•†',
                modelSelection: 'æ¨¡å‹é€‰æ‹©',
                promptList: 'æç¤ºè¯åˆ—è¡¨',
                addNewPrompt: 'æ·»åŠ æ–°æç¤ºè¯',
                lessIsMore: 'å°‘å³æ˜¯å¤šã€‚',
                requestTimeoutSeconds: 'è¯·æ±‚è¶…æ—¶ (ç§’)',
                historyRetentionDays: 'å†å²ä¿ç•™ (å¤©)',
                evaluationProcessDisplayLevel: 'äº’è¯„è¿‡ç¨‹å±•ç¤ºç¨‹åº¦'
            },
            en: {
                newChat: 'New Chat',
                selectImage: 'Select Image',
                placeholder: 'Enter your message here, press Enter to send',
                chatHistory: 'History',
                noHistory: 'No history yet',
                settings: 'Settings',
                user: 'User',
                aiAssistant: 'AI Assistant',
                newChatStarted: 'New chat started',
                selectModelFirst: 'Please select at least one model in the sidebar first',
                imageUploaded: 'Image uploaded:',
                aiFactory: 'AI Factory',
                preference: 'Preference',
                appearance: 'Appearance',
                models: 'Models',
                prompts: 'Prompts',
                advanced: 'Advanced',
                theme: 'Theme',
                language: 'Language',
                dark: 'Dark',
                light: 'Light',
                simplifiedChinese: 'Simplified Chinese',
                english: 'English',
                autoSave: 'Auto-save conversations',
                showTimestamps: 'Show timestamps',
                soundNotification: 'Sound notifications',
                fontSize: 'Font Size',
                compactMode: 'Compact Mode',
                defaultSidebarOpen: 'Default sidebar open',
                wallpaperSettings: 'Wallpaper Settings',
                opacity: 'Opacity',
                brightness: 'Brightness',
                blur: 'Blur',
                uploadWallpaper: 'Upload Wallpaper',
                resetWallpaper: 'Reset Default',
                evaluationDisplay: 'Evaluation Display Level',
                simpleSteps: 'Simple Steps (Default)',
                fullProcess: 'Full Process',
                debugMode: 'Debug Mode',
                apiLog: 'API Log',
                requestTimeout: 'Request Timeout (seconds)',
                maxRetry: 'Max Retry',
                historyRetention: 'History Retention (days)',
                permanent: 'Permanent',
                export: 'Export',
                clear: 'Clear',
                confirmClearAll: 'Are you sure to clear all data?',
                evaluationStarted: 'Evaluation process started, waiting for results...',
                initialAnswerComplete: 'completed initial answer',
                initialAnswer: 'Initial Answer',
                critiqueComplete: 'completed evaluation of {target}, score {score}',
                critiqueFor: 'Evaluation of {target}',
                totalScore: 'Total Score',
                accuracy: 'Accuracy',
                completeness: 'Completeness',
                clarity: 'Clarity',
                usefulness: 'Usefulness',
                revisionComplete: 'submitted improved answer',
                revisedAnswer: 'Revised Answer',
                evaluationComplete: 'âœ“ Evaluation complete, answer generated',
                answerGenerated: 'âœ“ Answer generated',
                finalAnswerGenerated: 'Final answer generated.',
                processingFailed: 'âŒ Processing failed',
                evaluationTerminated: 'Evaluation process terminated.',
                requestFailed: 'Request failed',
                showProcess: 'â–¼ Show evaluation process',
                hideProcess: 'â–² Hide evaluation process',
                noContent: '(No content)',
                uploadingWallpaper: 'Processing wallpaper...',
                wallpaperUpdated: 'Wallpaper updated.',
                wallpaperReset: 'Wallpaper reset to default.',
                wallpaperSaved: 'Currently using custom wallpaper.',
                wallpaperDefault: 'Using default wallpaper.',
                wallpaperError: 'Save failed: Insufficient browser storage space.',
                wallpaperFileError: 'File read failed.',
                wallpaperSizeError: 'Image is larger than 4MB, please compress it first.',
                confirmResetWallpaper: 'Are you sure to reset to default wallpaper?',
                noAnswerAvailable: 'No answer available',
                evaluationDisplayGroup: 'Evaluation Display',
                evaluationDisplayDesc: 'Select the level of model evaluation details to display to users.',
                behavior: 'Behavior',
                modelConfig: 'Model Configuration',
                promptManagement: 'Prompt Management',
                manageProviders: 'Manage Providers',
                managePrompts: 'Manage Prompts',
                basicSettings: 'Basic settings, keep it simple.',
                manageAIServices: 'Manage AI service providers and models.',
                managePromptTemplates: 'Manage conversation prompt templates.',
                advancedSettings: 'Only use when you know what you\'re doing.',
                interface: 'Interface',
                display: 'Display',
                performance: 'Performance',
                data: 'Data',
                debug: 'Debug',
                serviceProviderList: 'Service Provider List',
                addNewProvider: 'Add New Provider',
                modelSelection: 'Model Selection',
                promptList: 'Prompt List',
                addNewPrompt: 'Add New Prompt',
                lessIsMore: 'Less is more.',
                requestTimeout: 'Request Timeout (seconds)',
                maxRetry: 'Max Retry',
                historyRetention: 'History Retention (days)'
            }
        };
        
        function applyLanguage(l) {
            const t = i18n[l] || i18n.zh;
            
            // æ›´æ–°æŒ‰é’®å’Œè¾“å…¥æ¡†
            const newChatBtn = document.getElementById('new-chat-btn');
            if (newChatBtn) newChatBtn.title = t.newChat;
            const selectImageBtn = document.getElementById('select-image-btn');
            if (selectImageBtn) selectImageBtn.title = t.selectImage;
            const questionInput = document.getElementById('question-input');
            if (questionInput) questionInput.placeholder = t.placeholder;
            
            // æ›´æ–°å†å²è®°å½•å¼¹çª—
            const histTitle = document.querySelector('#history-popup .font-semibold');
            if (histTitle) histTitle.textContent = t.chatHistory;
            const noHistoryMsg = document.querySelector('#chat-history .text-center');
            if (noHistoryMsg && noHistoryMsg.textContent.includes('æš‚æ— å†å²è®°å½•')) {
                noHistoryMsg.textContent = t.noHistory;
            }
            
            // æ›´æ–°è®¾ç½®å¯¼èˆªé¡¹ï¼ˆä½¿ç”¨data-i18nçš„å­å…ƒç´ ï¼‰
            const settingsNavItems = document.querySelectorAll('.settings-nav-item');
            settingsNavItems.forEach(item => {
                const i18nSpan = item.querySelector('[data-i18n]');
                if (i18nSpan) {
                    const key = i18nSpan.getAttribute('data-i18n');
                    if (t[key]) {
                        i18nSpan.textContent = t[key];
                    }
                }
            });
            
            // æ›´æ–°æ‰€æœ‰å¸¦ data-i18n å±æ€§çš„å…ƒç´ ï¼ˆä½†æ’é™¤å¯¼èˆªé¡¹ä¸­çš„spanï¼Œå› ä¸ºå·²ç»åœ¨ä¸Šé¢å•ç‹¬å¤„ç†äº†ï¼‰
            document.querySelectorAll('[data-i18n]').forEach(el => {
                // è·³è¿‡å¯¼èˆªé¡¹ä¸­çš„spanï¼Œå› ä¸ºå·²ç»åœ¨ä¸Šé¢å•ç‹¬å¤„ç†äº†
                if (el.closest('.settings-nav-item')) {
                    return;
                }
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // æ›´æ–°é€‰é¡¹æ–‡æœ¬
            const themeSelect = document.getElementById('theme-mode-select');
            if (themeSelect) {
                themeSelect.options[0].text = t.dark;
                themeSelect.options[1].text = t.light;
            }
            const langSelect = document.getElementById('language-select');
            if (langSelect) {
                langSelect.options[0].text = t.simplifiedChinese;
                langSelect.options[1].text = t.english;
            }
            const evalSelect = document.getElementById('evaluation-display-select');
            if (evalSelect) {
                evalSelect.options[0].text = t.simpleSteps;
                evalSelect.options[1].text = t.fullProcess;
            }
            
            // æ›´æ–°è®¾ç½®é¡¹æ ‡é¢˜
            const titleMap = {
                'theme': t.theme,
                'language': t.language,
                'auto-save': t.autoSave,
                'timestamps': t.showTimestamps,
                'sound': t.soundNotification,
                'font-size': t.fontSize,
                'compact': t.compactMode,
                'sidebar-open': t.defaultSidebarOpen,
                'wallpaper': t.wallpaperSettings,
                'opacity': t.opacity,
                'brightness': t.brightness,
                'blur': t.blur,
                'evaluation-display': t.evaluationDisplay,
                'debug': t.debugMode,
                'api-log': t.apiLog,
                'timeout': t.requestTimeout,
                'retry': t.maxRetry,
                'retention': t.historyRetention,
                'export': t.export,
                'clear': t.clear
            };
            
            document.querySelectorAll('.settings-item-title').forEach(el => {
                const parent = el.closest('.settings-item');
                if (parent) {
                    const setting = parent.querySelector('[data-setting]');
                    if (setting && titleMap[setting.getAttribute('data-setting')]) {
                        el.textContent = titleMap[setting.getAttribute('data-setting')];
                    }
                }
            });
            
            // æ›´æ–°å£çº¸æŒ‰é’®æ–‡æœ¬
            const uploadBtn = document.getElementById('wallpaper-upload-btn');
            if (uploadBtn) uploadBtn.textContent = t.uploadWallpaper;
            const resetBtn = document.getElementById('reset-wallpaper-btn');
            if (resetBtn) resetBtn.textContent = t.resetWallpaper;
            
            // æ›´æ–°è®¾ç½®ç»„æ ‡é¢˜å’Œæè¿°
            document.querySelectorAll('.settings-group-title').forEach(title => {
                if (title.textContent.includes('äº’è¯„å±•ç¤º')) {
                    title.textContent = t.evaluationDisplayGroup;
                } else if (title.textContent.includes('è¡Œä¸º')) {
                    title.textContent = t.behavior;
                } else if (title.textContent.includes('æ¨¡å‹é…ç½®')) {
                    title.textContent = t.modelConfig;
                } else if (title.textContent.includes('æç¤ºè¯ç®¡ç†')) {
                    title.textContent = t.promptManagement;
                }
            });
            
            document.querySelectorAll('.settings-item-desc').forEach(desc => {
                if (desc.textContent.includes('é€‰æ‹©å‘ç”¨æˆ·å±•ç¤º')) {
                    desc.textContent = t.evaluationDisplayDesc;
                }
            });
            
            // æ›´æ–°è®¾ç½®å­æ ‡é¢˜
            document.querySelectorAll('.settings-subtitle').forEach(subtitle => {
                if (subtitle.textContent.includes('åŸºç¡€è®¾ç½®')) {
                    subtitle.textContent = t.basicSettings;
                } else if (subtitle.textContent.includes('ç®¡ç†AIæœåŠ¡å•†')) {
                    subtitle.textContent = t.manageAIServices;
                } else if (subtitle.textContent.includes('ç®¡ç†å¯¹è¯æç¤ºè¯')) {
                    subtitle.textContent = t.managePromptTemplates;
                } else if (subtitle.textContent.includes('ä»…åœ¨ä½ çŸ¥é“')) {
                    subtitle.textContent = t.advancedSettings;
                }
            });
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const manageProvidersBtn = document.getElementById('manage-providers-btn');
            if (manageProvidersBtn) manageProvidersBtn.textContent = t.manageProviders;
            const managePromptsBtn = document.getElementById('manage-prompts-btn');
            if (managePromptsBtn) managePromptsBtn.textContent = t.managePrompts;
            
            // æ›´æ–°ä¾§è¾¹æ æ‰‹é£ç´æ ‡é¢˜
            document.querySelectorAll('.accordion-header span').forEach(span => {
                if (span.textContent.includes('æ¨¡å‹é…ç½®')) {
                    span.textContent = 'ğŸ¤– ' + t.modelConfig;
                } else if (span.textContent.includes('æç¤ºè¯ç®¡ç†')) {
                    span.textContent = 'ğŸ’¬ ' + t.promptManagement;
                }
            });
            
            // æ›´æ–°ç¤ºä¾‹å¯¹è¯ä¸­çš„æ–‡æœ¬ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const exampleUser = document.querySelector('#chat-log .chat-message.user .font-medium');
            if (exampleUser && exampleUser.textContent === 'ç”¨æˆ·') {
                exampleUser.textContent = t.user;
            }
            const exampleAI = document.querySelector('#chat-log .chat-message.assistant .font-medium');
            if (exampleAI && exampleAI.textContent === 'AIåŠ©æ‰‹') {
                exampleAI.textContent = t.aiAssistant;
            }
            
            // ä¿å­˜å½“å‰è¯­è¨€ä»¥ä¾¿åç»­ä½¿ç”¨
            window.currentLang = l;
            
            // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å·²å¼€å¯ï¼Œé‡æ–°åº”ç”¨æ—¶é—´æˆ³ï¼ˆæ›´æ–°è¯­è¨€æ ¼å¼ï¼‰
            if (S.get('sw_timestamps') === '1') {
                setTimeout(() => {
                    applyToggleSetting('timestamps', true);
                }, 100);
            }
        }
        applyLanguage(lang.value);
        
        // åˆå§‹åŒ–æ—¶åŠ è½½å†å²è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å¹¶åº”ç”¨æ—¶é—´æˆ³
        window.addEventListener('DOMContentLoaded', () => {
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åŠ è½½
            setTimeout(() => {
                if (S.get('sw_timestamps') === '1') {
                    applyToggleSetting('timestamps', true);
                }
            }, 500);
        });
        
        // å­—ä½“
        const font = document.getElementById('font-size-select');
        font.value = S.get('font', '16');
        font.onchange = e => {
            S.set('font', e.target.value);
            document.documentElement.style.fontSize = e.target.value + 'px';
        };
        document.documentElement.style.fontSize = font.value + 'px';
        
        // è¶…æ—¶å’Œé‡è¯•
        const timeout = document.getElementById('timeout-input');
        const retry = document.getElementById('retry-input');
        const retention = document.getElementById('retention-select');
        
        timeout.value = S.get('timeout', '30');
        retry.value = S.get('retry', '2');
        retention.value = S.get('retention', '30');
        
        timeout.onchange = e => S.set('timeout', e.target.value);
        retry.onchange = e => S.set('retry', e.target.value);
        retention.onchange = e => S.set('retention', e.target.value);
        
        // å¯¼å‡º/æ¸…é™¤
        document.getElementById('export-btn').onclick = () => {
            const data = { ...localStorage };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ai-factory-' + Date.now() + '.json';
            a.click();
        };
        
        document.getElementById('clear-btn').onclick = () => {
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            if (confirm(t.confirmClearAll)) {
                localStorage.clear();
                location.reload();
            }
        };
        
        // æ‰€æœ‰å¼€å…³ - ä¸€æ¬¡æå®š
        document.querySelectorAll('.settings-toggle[data-setting]').forEach(t => {
            const k = 'sw_' + t.dataset.setting;
            const setting = t.dataset.setting;
            
            // æ¢å¤çŠ¶æ€
            if (S.get(k) === '1') t.classList.add('active');
            
            // åˆå§‹åŒ–åº”ç”¨
            applyToggleSetting(setting, t.classList.contains('active'));
            
            // ç‚¹å‡»åˆ‡æ¢
            t.onclick = () => {
                t.classList.toggle('active');
                const active = t.classList.contains('active');
                S.set(k, active ? '1' : '0');
                applyToggleSetting(setting, active);
            };
        });
        
        // åº”ç”¨å¼€å…³è®¾ç½®
        function applyToggleSetting(setting, active) {
            switch(setting) {
                case 'compact':
                    document.body.classList.toggle('compact', active);
                    break;
                case 'timestamps':
                    // æ—¶é—´æˆ³æ˜¾ç¤ºé€»è¾‘ - ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ æˆ–ç§»é™¤æ—¶é—´æˆ³
                    const showTimestamps = active;
                    const chatMessages = document.querySelectorAll('.chat-message');
                    chatMessages.forEach(msg => {
                        const existingTimestamp = msg.querySelector('.message-timestamp');
                        if (showTimestamps) {
                            if (!existingTimestamp) {
                                let timestamp = msg.getAttribute('data-timestamp');
                                // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
                                if (!timestamp) {
                                    timestamp = Date.now().toString();
                                    msg.setAttribute('data-timestamp', timestamp);
                                }
                                
                                const timeEl = document.createElement('div');
                                timeEl.className = 'message-timestamp';
                                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px; opacity: 0.7;';
                                const date = new Date(parseInt(timestamp));
                                const lang = window.currentLang || 'zh';
                                if (lang === 'en') {
                                    timeEl.textContent = date.toLocaleString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                } else {
                                    timeEl.textContent = date.toLocaleString('zh-CN', { 
                                        month: 'numeric', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                }
                                msg.appendChild(timeEl);
                            } else {
                                // æ›´æ–°æ—¶é—´æˆ³æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶ï¼‰
                                const timestamp = msg.getAttribute('data-timestamp');
                                if (timestamp) {
                                    const date = new Date(parseInt(timestamp));
                                    const lang = window.currentLang || 'zh';
                                    if (lang === 'en') {
                                        existingTimestamp.textContent = date.toLocaleString('en-US', { 
                                            month: 'short', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        });
                                    } else {
                                        existingTimestamp.textContent = date.toLocaleString('zh-CN', { 
                                            month: 'numeric', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        });
                                    }
                                }
                            }
                        } else if (!showTimestamps && existingTimestamp) {
                            existingTimestamp.remove();
                        }
                    });
                    break;
                case 'sidebar-open':
                    // ä¾§è¾¹æ é»˜è®¤çŠ¶æ€ï¼ˆå¯åŠ¨æ—¶åº”ç”¨ï¼‰
                    if (active && sidebar.classList.contains('collapsed')) {
                        sidebar.classList.remove('collapsed');
                    }
                    break;
                case 'auto-save':
                    console.log('è‡ªåŠ¨ä¿å­˜:', active);
                    break;
                case 'sound':
                    console.log('å£°éŸ³æç¤º:', active);
                    break;
                case 'debug':
                    console.log('è°ƒè¯•æ¨¡å¼:', active);
                    break;
                case 'api-log':
                    console.log('APIæ—¥å¿—:', active);
                    break;
            }
        }
        
        // å¼€å§‹æ–°å¯¹è¯
        document.getElementById('new-chat-btn').onclick = () => {
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            document.getElementById('chat-log').innerHTML = `<div class="text-center text-gray-400 py-8">${t.newChatStarted}</div>`;
            document.getElementById('question-input').value = '';
            document.getElementById('question-input').focus();
        };
        
        // å‘é€æ¶ˆæ¯
        const submitBtn = document.getElementById('submit-btn');
        const questionInput = document.getElementById('question-input');

        questionInput.addEventListener('input', () => {
            if (questionInput.value.trim().length > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        });

        submitBtn.onclick = async () => {
            const question = questionInput.value.trim();
            if (!question) return;
            
            const selectedModels = JSON.parse(S.get('models', '[]'));
            if (selectedModels.length === 0) {
                const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                alert(t.selectModelFirst);
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const chatLog = document.getElementById('chat-log');
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.setAttribute('data-timestamp', Date.now().toString());
            userMsgDiv.innerHTML = `<div class="font-medium mb-1">${t.user}</div><div>${question}</div>`;
            
            // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æ—¶é—´æˆ³
            if (S.get('sw_timestamps') === '1') {
                const timeEl = document.createElement('div');
                timeEl.className = 'message-timestamp';
                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                const date = new Date();
                const lang = window.currentLang || 'zh';
                if (lang === 'en') {
                    timeEl.textContent = date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                } else {
                    timeEl.textContent = date.toLocaleString('zh-CN', { 
                        month: 'numeric', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                userMsgDiv.appendChild(timeEl);
            }
            
            chatLog.appendChild(userMsgDiv);
            
            questionInput.value = '';
            questionInput.disabled = true;
            submitBtn.disabled = true;
        
            // æ·»åŠ AIå“åº”å ä½
            const aiMsg = document.createElement('div');
            aiMsg.className = 'chat-message assistant';
            aiMsg.setAttribute('data-timestamp', Date.now().toString());
            const t2 = i18n[window.currentLang || 'zh'] || i18n.zh;
            aiMsg.innerHTML = `<div class="font-medium mb-1 text-purple-400">${t2.aiAssistant}</div><div class="response-content"></div>`;
            chatLog.appendChild(aiMsg);
            chatLog.scrollTop = chatLog.scrollHeight;

        const responseContent = aiMsg.querySelector('.response-content');
        
        // åˆ›å»ºæ­¥éª¤çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
        const statusDiv = document.createElement('div');
        statusDiv.className = 'evaluation-status';
        statusDiv.style.cssText = `
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(37, 41, 50, 0.6);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        `;
        statusDiv.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
        
        const finalAnswerDiv = document.createElement('div');
        finalAnswerDiv.className = 'final-answer';
        finalAnswerDiv.style.whiteSpace = 'pre-wrap';
        finalAnswerDiv.style.fontSize = '15px';
        finalAnswerDiv.style.lineHeight = '1.6';
        finalAnswerDiv.style.color = '#e2e8f0';
        finalAnswerDiv.style.display = 'none'; // åˆå§‹éšè—ï¼Œç­‰æœ‰ç­”æ¡ˆæ—¶æ˜¾ç¤º

        const evaluationMode = S.get('evaluation_display', 'simple');
        
        // åˆ›å»ºå¯æŠ˜å çš„è¿›åº¦å®¹å™¨
        const processWrapper = document.createElement('div');
        processWrapper.className = 'process-wrapper';
        
        const processToggle = document.createElement('button');
        processToggle.className = 'process-toggle';
        const t_process = i18n[window.currentLang || 'zh'] || i18n.zh;
        processToggle.innerHTML = t_process.showProcess;
        processToggle.style.cssText = `
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 12px;
            transition: all 0.2s;
            display: none;
        `;
        
        const processContainer = document.createElement('div');
        processContainer.className = `evaluation-process ${evaluationMode}`;
        processContainer.style.display = 'none'; // é»˜è®¤æŠ˜å 
        
        processToggle.onclick = () => {
            const isHidden = processContainer.style.display === 'none';
            processContainer.style.display = isHidden ? 'block' : 'none';
            const t_toggle = i18n[window.currentLang || 'zh'] || i18n.zh;
            processToggle.innerHTML = isHidden ? t_toggle.hideProcess : t_toggle.showProcess;
        };

        const appendProcessLine = (text) => {
            if (!text || evaluationMode !== 'simple') return; // åªåœ¨ç®€å•æ¨¡å¼ä¸‹æ·»åŠ 
            const line = document.createElement('div');
            line.className = 'process-line';
            line.textContent = text;
            processContainer.appendChild(line);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

            const appendDetailedBlock = (title, content, meta = '') => {
                if (evaluationMode !== 'detailed') return; // Good Taste: If not detailed, do nothing.
                const block = document.createElement('div');
                block.className = 'process-block';

                if (title) {
                    const heading = document.createElement('h4');
                    heading.textContent = title;
                    block.appendChild(heading);
                }

                if (meta) {
                    const metaDiv = document.createElement('div');
                    metaDiv.style.color = '#9ca3af';
                    metaDiv.style.fontSize = '12px';
                    metaDiv.style.marginBottom = '8px';
                    metaDiv.textContent = meta;
                    block.appendChild(metaDiv);
                }

                const textDiv = document.createElement('div');
                textDiv.className = 'process-text';
                const t_empty = i18n[window.currentLang || 'zh'] || i18n.zh;
                textDiv.textContent = content || t_empty.noContent;
                block.appendChild(textDiv);

                processContainer.appendChild(block);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

        responseContent.appendChild(statusDiv);
        responseContent.appendChild(finalAnswerDiv);
        processWrapper.appendChild(processToggle);
        processWrapper.appendChild(processContainer);
        responseContent.appendChild(processWrapper);

        // Only show process container if there's something to show
        if (selectedModels.length > 1) {
            const t_start = i18n[window.currentLang || 'zh'] || i18n.zh;
            appendProcessLine(t_start.evaluationStarted);
        }
            try {
                const resp = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        selected_models: selectedModels,
                        history: []
                    })
                });
                
                const t_error = i18n[window.currentLang || 'zh'] || i18n.zh;
                if (!resp.ok) throw new Error(t_error.requestFailed);
                
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                switch (data.type) {
                                    case 'status': {
                                        // æ›´æ–°ä¸»è¦çŠ¶æ€æ˜¾ç¤º
                                        statusDiv.textContent = data.data;
                                        appendProcessLine(data.data);
                                        break;
                                    }
                                    case 'initial_answer_complete': {
                                        const t_init = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        appendProcessLine(`${data.model_name} ${t_init.initialAnswerComplete}`);
                                        appendDetailedBlock(`${data.model_name} ${t_init.initialAnswer}`, data.answer || '');
                                        break;
                                    }
                                    case 'critique_complete': {
                                        const t_crit = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        const critiqueData = data.critique_data || {};
                                        const score = typeof critiqueData.score === 'number' ? critiqueData.score.toFixed(2) : (critiqueData.score || 'N/A');
                                        appendProcessLine(`${data.critic_name} ${t_crit.critiqueComplete.replace('{target}', data.target_model).replace('{score}', score)}`);
                                        if (evaluationMode === 'detailed') {
                                            const metrics = `${t_crit.accuracy} ${critiqueData.accuracy ?? '-'} / ${t_crit.completeness} ${critiqueData.completeness ?? '-'} / ${t_crit.clarity} ${critiqueData.clarity ?? '-'} / ${t_crit.usefulness} ${critiqueData.usefulness ?? '-'}`;
                                            const commentSource = critiqueData.comment || data.critique_text || '';
                                            appendDetailedBlock(`${data.critic_name} ${t_crit.critiqueFor.replace('{target}', data.target_model)}`, commentSource, `${t_crit.totalScore} ${score} | ${metrics}`);
                                        }
                                        break;
                                    }
                                    case 'revision_complete': {
                                        const t_rev = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        appendProcessLine(`${data.model_name} ${t_rev.revisionComplete}`);
                                        appendDetailedBlock(`${data.model_name} ${t_rev.revisedAnswer}`, data.revised_answer || '');
                                        break;
                                    }
                                    case 'final_result': {
                                        const result = data.data || {};
                                        const t_final = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        statusDiv.textContent = t_final.evaluationComplete;
                                        statusDiv.style.borderLeftColor = 'var(--accent-purple)';
                                        statusDiv.classList.add('completed');
                                        appendProcessLine(t_final.finalAnswerGenerated);
                                        
                                        // æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
                                        const t_no_answer = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        finalAnswerDiv.textContent = result.best_answer || t_no_answer.noAnswerAvailable;
                                        finalAnswerDiv.style.display = 'block';
                                        
                                        // æ˜¾ç¤ºè¿›åº¦åˆ‡æ¢æŒ‰é’®
                                        processToggle.style.display = 'inline-block';
                                        
                                        // æ›´æ–°æ¶ˆæ¯æ—¶é—´æˆ³
                                        aiMsg.setAttribute('data-timestamp', Date.now().toString());
                                        
                                        // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æˆ–æ›´æ–°æ—¶é—´æˆ³
                                        if (S.get('sw_timestamps') === '1') {
                                            let timeEl = aiMsg.querySelector('.message-timestamp');
                                            if (!timeEl) {
                                                timeEl = document.createElement('div');
                                                timeEl.className = 'message-timestamp';
                                                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                                                aiMsg.appendChild(timeEl);
                                            }
                                            const date = new Date();
                                            const lang = window.currentLang || 'zh';
                                            if (lang === 'en') {
                                                timeEl.textContent = date.toLocaleString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            } else {
                                                timeEl.textContent = date.toLocaleString('zh-CN', { 
                                                    month: 'numeric', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            }
                                        }
                                        
                                        // ä¿å­˜åˆ°å†å²è®°å½•
                                        if (S.get('sw_auto-save') === '1') {
                                            setTimeout(() => saveChatHistory(), 500);
                                        }
                                        
                                        if (evaluationMode === 'detailed') {
                                            // In detailed mode, the blocks are already appended by other events.
                                            // This section is now redundant.
                                        }
                                        break;
                                    }
                                    case 'final': {
                                        const t_final_single = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        statusDiv.textContent = t_final_single.answerGenerated;
                                        statusDiv.style.borderLeftColor = 'var(--accent-purple)';
                                        statusDiv.classList.add('completed');
                                        appendProcessLine(t_final_single.finalAnswerGenerated);
                                        
                                        // æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
                                        const t_no_answer2 = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        finalAnswerDiv.textContent = data.data || t_no_answer2.noAnswerAvailable;
                                        finalAnswerDiv.style.display = 'block';
                                        
                                        // æ˜¾ç¤ºè¿›åº¦åˆ‡æ¢æŒ‰é’®
                                        processToggle.style.display = 'inline-block';
                                        
                                        // æ›´æ–°æ¶ˆæ¯æ—¶é—´æˆ³
                                        aiMsg.setAttribute('data-timestamp', Date.now().toString());
                                        
                                        // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æˆ–æ›´æ–°æ—¶é—´æˆ³
                                        if (S.get('sw_timestamps') === '1') {
                                            let timeEl = aiMsg.querySelector('.message-timestamp');
                                            if (!timeEl) {
                                                timeEl = document.createElement('div');
                                                timeEl.className = 'message-timestamp';
                                                timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                                                aiMsg.appendChild(timeEl);
                                            }
                                            const date = new Date();
                                            const lang = window.currentLang || 'zh';
                                            if (lang === 'en') {
                                                timeEl.textContent = date.toLocaleString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            } else {
                                                timeEl.textContent = date.toLocaleString('zh-CN', { 
                                                    month: 'numeric', 
                                                    day: 'numeric', 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                });
                                            }
                                        }
                                        
                                        // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆå¦‚æœå¼€å¯è‡ªåŠ¨ä¿å­˜ï¼‰
                                        if (S.get('sw_auto-save') === '1') {
                                            setTimeout(() => {
                                                saveChatHistory();
                                            }, 1000); // å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°å®Œæˆ
                                        }
                                        break;
                                    }
                                    case 'error': {
                                        const t_err = i18n[window.currentLang || 'zh'] || i18n.zh;
                                        statusDiv.textContent = t_err.processingFailed;
                                        statusDiv.style.borderLeftColor = '#f87171';
                                        statusDiv.style.color = '#f87171';
                                        
                                        finalAnswerDiv.textContent = `${t_err.processingFailed}: ${data.data}`;
                                        finalAnswerDiv.style.color = '#f87171';
                                        finalAnswerDiv.style.display = 'block';
                                        appendProcessLine(t_err.evaluationTerminated);
                                        break;
                                    }
                                    default:
                                        break;
                                }
                            } catch (e) {}
                        }
                    }
                }
            } catch (e) {
                const t_catch = i18n[window.currentLang || 'zh'] || i18n.zh;
                statusDiv.textContent = t_catch.requestFailed;
                statusDiv.style.borderLeftColor = '#f87171';
                statusDiv.style.color = '#f87171';
                
                finalAnswerDiv.textContent = `${t_catch.requestFailed}: ${e.message}`;
                finalAnswerDiv.style.color = '#f87171';
                finalAnswerDiv.style.display = 'block';
                appendProcessLine(t_catch.evaluationTerminated);
            } finally {
                questionInput.disabled = false;
                questionInput.focus();
            }
        };
        
        // å›è½¦å‘é€
        questionInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitBtn.click();
            }
        };
        
        // é€‰æ‹©å›¾ç‰‡
        document.getElementById('select-image-btn').onclick = () => {
            document.getElementById('image-input').click();
        };
        
        document.getElementById('image-input').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.style.maxWidth = '200px';
                    img.style.borderRadius = '8px';
                    img.style.marginTop = '8px';
                    
                    const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'chat-message user';
                    msgDiv.setAttribute('data-timestamp', Date.now().toString());
                    msgDiv.innerHTML = `<div class="font-medium mb-1">${t.user}</div><div>${t.imageUploaded}</div>`;
                    msgDiv.appendChild(img);
                    
                    // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æ—¶é—´æˆ³
                    if (S.get('sw_timestamps') === '1') {
                        const timeEl = document.createElement('div');
                        timeEl.className = 'message-timestamp';
                        timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                        const date = new Date();
                        const lang = window.currentLang || 'zh';
                        if (lang === 'en') {
                            timeEl.textContent = date.toLocaleString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        } else {
                            timeEl.textContent = date.toLocaleString('zh-CN', { 
                                month: 'numeric', 
                                day: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        }
                        msgDiv.appendChild(timeEl);
                    }
                    
                    document.getElementById('chat-log').appendChild(msgDiv);
                };
                reader.readAsDataURL(file);
            }
        };
        
        // APIè°ƒç”¨å‡½æ•°
        async function api(url, method = 'GET', data = null) {
            const opts = { method, headers: {} };
            if (data) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(data);
            }
            const resp = await fetch('/api' + url, opts);
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({ detail: 'è¯·æ±‚å¤±è´¥' }));
                throw new Error(err.detail || err.message || 'è¯·æ±‚å¤±è´¥');
            }
            return resp.json();
        }
        
        // åŠ è½½æœåŠ¡å•†åˆ—è¡¨
        async function loadProviders() {
            try {
                const providers = await api('/providers');
                const container = document.getElementById('provider-list-settings');
                container.innerHTML = providers.map(p => `
                    <div class="provider-item-settings">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-blue-400">${p.name}</div>
                                <div class="text-sm text-gray-400">(${p.type})</div>
                            </div>
                            <button class="btn-danger text-xs" onclick="deleteProvider('${p.name}')">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
                loadModelsForSidebar(providers);
            } catch (e) {
                console.error('åŠ è½½æœåŠ¡å•†å¤±è´¥:', e);
            }
        }
        
        // åˆ é™¤æœåŠ¡å•†
        window.deleteProvider = async function(name) {
            if (!confirm('ç¡®å®šåˆ é™¤ ' + name + '?')) return;
            try {
                await api('/providers/' + name, 'DELETE');
                loadProviders();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        };
        
        // æ·»åŠ æœåŠ¡å•†
        document.getElementById('add-provider-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value.trim(),
                type: form.type.value,
                api_key: form.api_key.value.trim(),
                api_base: form.api_base.value.trim() || null,
                models: form.models.value.trim()
            };
            try {
                await api('/providers', 'POST', data);
                form.reset();
                loadProviders();
                alert('æ·»åŠ æˆåŠŸ');
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        };
        
        // åŠ è½½æ¨¡å‹åˆ—è¡¨åˆ°ä¾§è¾¹æ 
        function loadModelsForSidebar(providers) {
            const container = document.getElementById('model-list-sidebar');
            const selected = JSON.parse(S.get('models', '[]'));
            let html = '';
            providers.forEach(p => {
                p.models.split(',').forEach(m => {
                    const modelName = m.trim();
                    const key = `${p.name}::${modelName}`;
                    const isActive = selected.includes(key);
                    html += `
                        <div class="sidebar-item ${isActive ? 'active' : ''}" onclick="toggleModel('${key}', this)">
                            <span class="name">${p.name} - ${modelName}</span>
                        </div>
                    `;
                });
            });
            container.innerHTML = html || '<div class="text-xs text-gray-400 p-2">æ— å¯ç”¨æ¨¡å‹</div>';
        }
        
        // åˆ‡æ¢æ¨¡å‹é€‰æ‹©
        window.toggleModel = function(key, element) {
            const selected = JSON.parse(S.get('models', '[]'));
            const index = selected.indexOf(key);
            
            if (index > -1) {
                selected.splice(index, 1);
                element.classList.remove('active');
            } else {
                selected.push(key);
                element.classList.add('active');
            }
            S.set('models', JSON.stringify(selected));
        };
        
        // åŠ è½½æç¤ºè¯åˆ—è¡¨
        async function loadPrompts() {
            try {
                const prompts = await api('/prompts');
                const settingsContainer = document.getElementById('prompt-list-settings');
                const sidebarContainer = document.getElementById('prompt-list-sidebar');
                
                settingsContainer.innerHTML = prompts.map(p => `
                    <div class="provider-item-settings">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium">${p.name_zh} / ${p.name_en}</div>
                                ${p.is_active ? '<div class="text-sm text-green-400">âœ“ å½“å‰ä½¿ç”¨</div>' : '<div class="text-sm text-gray-400">æœªæ¿€æ´»</div>'}
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-secondary text-xs" onclick="togglePromptDetail(${p.id})">
                                    <span id="expand-icon-${p.id}">â–¼</span> æŸ¥çœ‹
                                </button>
                                ${!p.is_active ? `<button class="btn-success text-xs" onclick="activatePrompt(${p.id})">æ¿€æ´»</button>` : ''}
                                <button class="btn-danger text-xs" onclick="deletePrompt(${p.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div id="prompt-detail-${p.id}" class="hidden mt-3 text-sm" style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px;">
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">è¯„å®¡æç¤ºè¯ (ä¸­æ–‡):</div>
                                <textarea id="critique-zh-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.critique_prompt_zh}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">è¯„å®¡æç¤ºè¯ (è‹±æ–‡):</div>
                                <textarea id="critique-en-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.critique_prompt_en}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">ä¿®è®¢æç¤ºè¯ (ä¸­æ–‡):</div>
                                <textarea id="revision-zh-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.revision_prompt_zh}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="text-gray-400 mb-1">ä¿®è®¢æç¤ºè¯ (è‹±æ–‡):</div>
                                <textarea id="revision-en-${p.id}" class="w-full bg-gray-700 text-white p-2 rounded" rows="3">${p.revision_prompt_en}</textarea>
                            </div>
                            <button class="btn-primary text-xs" onclick="updatePrompt(${p.id})">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                `).join('');

                sidebarContainer.innerHTML = prompts.map(p => `
                    <div class="sidebar-item ${p.is_active ? 'active' : ''}" onclick="activatePrompt(${p.id}, true)">
                        <span class="name">${p.name_zh}</span>
                    </div>
                `).join('');

            } catch (e) {
                console.error('åŠ è½½æç¤ºè¯å¤±è´¥:', e);
            }
        }
        
        // å±•å¼€/æ”¶èµ·æç¤ºè¯è¯¦æƒ…
        window.togglePromptDetail = function(id) {
            const detail = document.getElementById(`prompt-detail-${id}`);
            const icon = document.getElementById(`expand-icon-${id}`);
            if (detail.classList.contains('hidden')) {
                detail.classList.remove('hidden');
                icon.textContent = 'â–²';
            } else {
                detail.classList.add('hidden');
                icon.textContent = 'â–¼';
            }
        };
        
        // æ›´æ–°æç¤ºè¯
        window.updatePrompt = async function(id) {
            try {
                const data = {
                    critique_prompt_zh: document.getElementById(`critique-zh-${id}`).value,
                    critique_prompt_en: document.getElementById(`critique-en-${id}`).value,
                    revision_prompt_zh: document.getElementById(`revision-zh-${id}`).value,
                    revision_prompt_en: document.getElementById(`revision-en-${id}`).value
                };
                await api(`/prompts/${id}`, 'PUT', data);
                alert('æ›´æ–°æˆåŠŸ');
                loadPrompts();
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥: ' + e.message);
            }
        };
        
        // æ¿€æ´»æç¤ºè¯
        window.activatePrompt = async function(id, fromSidebar = false) {
            try {
                await api(`/prompts/${id}/activate`, 'POST');
                if (!fromSidebar) {
                    alert('æ¿€æ´»æˆåŠŸ');
                }
                loadPrompts();
            } catch (e) {
                alert('æ¿€æ´»å¤±è´¥: ' + e.message);
            }
        };
        
        // åˆ é™¤æç¤ºè¯
        window.deletePrompt = async function(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æç¤ºè¯?')) return;
            try {
                await api(`/prompts/${id}`, 'DELETE');
                loadPrompts();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        };
        
        // æ·»åŠ æç¤ºè¯
        document.getElementById('add-prompt-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name_zh: form.name_zh.value.trim(),
                name_en: form.name_en.value.trim(),
                critique_prompt_zh: form.critique_zh.value.trim(),
                critique_prompt_en: form.critique_en.value.trim(),
                revision_prompt_zh: form.revision_zh.value.trim(),
                revision_prompt_en: form.revision_en.value.trim()
            };
            try {
                await api('/prompts', 'POST', data);
                form.reset();
                loadPrompts();
                alert('æ·»åŠ æˆåŠŸ');
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        };

        // å†å²è®°å½•åŠŸèƒ½
        function saveChatHistory() {
            try {
                const chatLog = document.getElementById('chat-log');
                if (!chatLog) return;
                
                const messages = [];
                
                chatLog.querySelectorAll('.chat-message').forEach(msg => {
                    const isUser = msg.classList.contains('user');
                    let contentEl = null;
                    
                    if (isUser) {
                        // ç”¨æˆ·æ¶ˆæ¯ï¼šè·å–æœ€åä¸€ä¸ªdivï¼ˆå†…å®¹ï¼‰
                        const divs = msg.querySelectorAll('div');
                        if (divs.length > 1) {
                            contentEl = divs[divs.length - 1];
                        }
                    } else {
                        // AIæ¶ˆæ¯ï¼šå°è¯•å¤šä¸ªå¯èƒ½çš„é€‰æ‹©å™¨
                        contentEl = msg.querySelector('.response-content') || 
                                   msg.querySelector('.final-answer') || 
                                   msg.querySelector('.process-text') ||
                                   (() => {
                                       const divs = msg.querySelectorAll('div');
                                       return divs.length > 1 ? divs[divs.length - 1] : null;
                                   })();
                    }
                    
                    if (contentEl) {
                        const content = contentEl.textContent.trim();
                        // è·³è¿‡ç©ºå†…å®¹å’ŒçŠ¶æ€æ¶ˆæ¯
                        if (content && !content.startsWith('âœ“') && !content.startsWith('âŒ') && 
                            !content.includes('æ­£åœ¨åˆå§‹åŒ–') && !content.includes('æ­£åœ¨') && 
                            content.length > 3) {
                            const timestamp = msg.getAttribute('data-timestamp') || Date.now().toString();
                            messages.push({
                                type: isUser ? 'user' : 'assistant',
                                content: content,
                                timestamp: timestamp
                            });
                        }
                    }
                });
                
                if (messages.length >= 2) { // è‡³å°‘éœ€è¦ä¸€é—®ä¸€ç­”
                    const historyKey = 'chat_history_' + Date.now();
                    const firstUserMsg = messages.find(m => m.type === 'user');
                    const title = firstUserMsg ? (firstUserMsg.content.substring(0, 30) + (firstUserMsg.content.length > 30 ? '...' : '')) : 'å¯¹è¯è®°å½•';
                    
                    const historyItem = {
                        id: historyKey,
                        title: title,
                        messages: messages,
                        createdAt: Date.now()
                    };
                    
                    let allHistory = JSON.parse(S.get('all_chat_history', '[]'));
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å¯¹è¯ï¼ˆé¿å…é‡å¤ä¿å­˜ï¼‰
                    const isDuplicate = allHistory.some(h => {
                        if (h.messages.length !== messages.length) return false;
                        return h.messages.every((m, i) => 
                            m.type === messages[i].type && m.content === messages[i].content
                        );
                    });
                    
                    if (!isDuplicate) {
                        allHistory.unshift(historyItem);
                        // åªä¿ç•™æœ€è¿‘50æ¡
                        if (allHistory.length > 50) {
                            allHistory = allHistory.slice(0, 50);
                        }
                        S.set('all_chat_history', JSON.stringify(allHistory));
                        console.log('å†å²è®°å½•å·²ä¿å­˜ï¼Œå…±', messages.length, 'æ¡æ¶ˆæ¯');
                    }
                }
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }
        
        function loadChatHistory() {
            try {
                const historyContainer = document.getElementById('chat-history');
                if (!historyContainer) {
                    console.error('å†å²è®°å½•å®¹å™¨ä¸å­˜åœ¨');
                    return;
                }
                
                let allHistory = [];
                try {
                    const historyStr = S.get('all_chat_history', '[]');
                    allHistory = JSON.parse(historyStr);
                } catch (e) {
                    console.error('è§£æå†å²è®°å½•å¤±è´¥:', e);
                    allHistory = [];
                }
                
                if (!Array.isArray(allHistory) || allHistory.length === 0) {
                    const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                    historyContainer.innerHTML = `<div class="text-sm text-gray-400 text-center py-4">${t.noHistory}</div>`;
                    return;
                }
                
                const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                historyContainer.innerHTML = allHistory.map(item => {
                    const date = new Date(item.createdAt || Date.now());
                    const dateStr = date.toLocaleString(window.currentLang === 'en' ? 'en-US' : 'zh-CN', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="history-item p-2 hover:bg-gray-800 rounded cursor-pointer mb-1" data-id="${item.id || 'unknown'}">
                            <div class="text-sm text-gray-200 truncate">${item.title || 'æœªå‘½åå¯¹è¯'}</div>
                            <div class="text-xs text-gray-500 mt-1">${dateStr}</div>
                        </div>
                    `;
                }).join('');
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                historyContainer.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const historyItem = allHistory.find(h => h.id === id);
                        if (historyItem && historyPopup) {
                            loadHistoryToChat(historyItem);
                            historyPopup.classList.add('hidden');
                        }
                    });
                });
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                const t = i18n[window.currentLang || 'zh'] || i18n.zh;
                const historyContainer = document.getElementById('chat-history');
                if (historyContainer) {
                    historyContainer.innerHTML = `<div class="text-sm text-red-400 text-center py-4">åŠ è½½å¤±è´¥</div>`;
                }
            }
        }
        
        function loadHistoryToChat(historyItem) {
            const chatLog = document.getElementById('chat-log');
            chatLog.innerHTML = '';
            
            const t = i18n[window.currentLang || 'zh'] || i18n.zh;
            historyItem.messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${msg.type}`;
                msgDiv.setAttribute('data-timestamp', msg.timestamp);
                
                if (msg.type === 'user') {
                    msgDiv.innerHTML = `<div class="font-medium mb-1">${t.user}</div><div>${msg.content}</div>`;
                } else {
                    msgDiv.innerHTML = `<div class="font-medium mb-1 text-purple-400">${t.aiAssistant}</div><div class="response-content">${msg.content}</div>`;
                }
                
                // å¦‚æœæ—¶é—´æˆ³åŠŸèƒ½å¼€å¯ï¼Œæ·»åŠ æ—¶é—´æˆ³
                if (S.get('sw_timestamps') === '1') {
                    const timeEl = document.createElement('div');
                    timeEl.className = 'message-timestamp';
                    timeEl.style.cssText = 'font-size: 11px; color: var(--text-muted); margin-top: 4px;';
                    const date = new Date(parseInt(msg.timestamp));
                    const lang = window.currentLang || 'zh';
                    if (lang === 'en') {
                        timeEl.textContent = date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    } else {
                        timeEl.textContent = date.toLocaleString('zh-CN', { 
                            month: 'numeric', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }
                    msgDiv.appendChild(timeEl);
                }
                
                chatLog.appendChild(msgDiv);
            });
            
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        // å†å²è®°å½•å¼¹çª—
        const historyBtn = document.getElementById('history-btn');
        const historyPopup = document.getElementById('history-popup');
        if (historyBtn && historyPopup) {
            historyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                loadChatHistory();
                historyPopup.classList.toggle('hidden');
            });
        }
        document.addEventListener('click', (e) => {
            if (!historyPopup.contains(e.target) && !historyBtn.contains(e.target)) {
                historyPopup.classList.add('hidden');
            }
        });

        // æ‰‹é£ç´æ•ˆæœ
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                header.classList.toggle('active');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

        // è·³è½¬åˆ°è®¾ç½®é¡µé¢
        document.getElementById('manage-providers-btn').onclick = () => {
            settingsModal.classList.add('active');
            document.querySelector('.settings-nav-item[data-section="models"]').click();
        };
        document.getElementById('manage-prompts-btn').onclick = () => {
            settingsModal.classList.add('active');
            document.querySelector('.settings-nav-item[data-section="prompts"]').click();
        };
        
        // ==================== å£çº¸åŠŸèƒ½ ====================
        const wallpaperStatus = document.getElementById('wallpaper-status');
        function setWallpaperStatus(message, isError = false) {
            if (!wallpaperStatus) return;
            wallpaperStatus.textContent = message || '';
            wallpaperStatus.style.color = isError ? '#f87171' : '#9ca3af';
        }

        // åº”ç”¨èƒŒæ™¯å›¾ç‰‡
        function applyBgImage() {
            const bgImage = S.get('bgImage');
            const opacity = S.get('bgOpacity', '100');
            const brightness = S.get('bgBrightness', '100');
            // å¼ºåˆ¶ç¡®ä¿æ¨¡ç³Šå€¼ä¸º0ï¼Œå¦‚æœç”¨æˆ·ä¹‹å‰è®¾ç½®è¿‡é0å€¼ï¼Œä¹Ÿé‡ç½®ä¸º0
            let blur = parseInt(S.get('bgBlur', '0')) || 0;
            if (blur > 0) {
                // å¦‚æœå‘ç°æœ‰æ¨¡ç³Šå€¼ï¼Œé‡ç½®ä¸º0å¹¶ä¿å­˜
                blur = 0;
                S.set('bgBlur', '0');
                // æ›´æ–°æ»‘å—æ˜¾ç¤º
                const blurSlider = document.getElementById('wallpaper-blur');
                const blurLabel = document.getElementById('wallpaper-blur-label');
                if (blurSlider) blurSlider.value = 0;
                if (blurLabel) blurLabel.textContent = '0px';
            }
            
            // æ›´æ–° CSS æ ·å¼ - ç§»é™¤æ‰€æœ‰å¯èƒ½å†²çªçš„æ ·å¼ï¼ˆåŒ…æ‹¬script.jsæ·»åŠ çš„ï¼‰
            const styleIds = ['bg-filter-style', 'wallpaper-style'];
            styleIds.forEach(id => {
                const existingStyle = document.getElementById(id);
                if (existingStyle) {
                    existingStyle.remove();
                    console.log(`[å£çº¸] å·²ç§»é™¤æ—§æ ·å¼: ${id}`);
                }
            });
            
            const style = document.createElement('style');
            style.id = 'bg-filter-style';
            
            if (bgImage) {
                // æ ¹æ®å½“å‰ä¸»é¢˜è®¡ç®—å åŠ å±‚é¢œè‰²
                // é™ä½å åŠ å±‚é€æ˜åº¦ï¼Œè®©å£çº¸æ›´æ¸…æ™°ï¼ˆå½“é€æ˜åº¦ä¸º100%æ—¶ï¼Œå åŠ å±‚å®Œå…¨é€æ˜ï¼‰
                const isDark = document.documentElement.classList.contains('dark');
                const baseOverlayColor = isDark ? '26,29,35' : '247,250,252';
                // ç¡®ä¿é€æ˜åº¦ä¸º100%æ—¶å åŠ å±‚å®Œå…¨é€æ˜ï¼Œé™ä½å åŠ å±‚å½±å“
                const overlayOpacity = opacity >= 100 ? 0 : Math.max(0, (1 - (opacity / 100)) * 0.3);
                const overlayColor = `rgba(${baseOverlayColor},${overlayOpacity})`;
                
                // æ·»åŠ has-wallpaperç±»åˆ°htmlå’Œbodyï¼Œä½¿èƒŒæ™¯é€æ˜
                document.documentElement.classList.add('has-wallpaper');
                document.body.classList.add('has-wallpaper');
                
                // å°†èƒŒæ™¯å›¾ç‰‡è®¾ç½®åœ¨ body::before ä¸Šï¼Œå¹¶åº”ç”¨æ»¤é•œ
                // ä½¿ç”¨è½¬ä¹‰æ¥å®‰å…¨å¤„ç†base64æ•°æ®
                const safeBgImage = bgImage.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                style.textContent = `
                    body.has-wallpaper::before {
                        content: '' !important;
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        background-image: url('${safeBgImage}') !important;
                        background-size: cover !important;
                        background-position: center center !important;
                        background-attachment: fixed !important;
                        background-repeat: no-repeat !important;
                        filter: brightness(${brightness}%) !important;
                        opacity: 1 !important;
                        display: block !important;
                        visibility: visible !important;
                        z-index: -2 !important;
                        pointer-events: none !important;
                    }
                    html.has-wallpaper,
                    body.has-wallpaper {
                        background: transparent !important;
                        background-image: none !important;
                    }
                    body.has-wallpaper::after {
                        content: '' !important;
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        background: ${overlayColor} !important;
                        z-index: -1 !important;
                        pointer-events: none !important;
                        display: block !important;
                    }
                    
                    /* ç¡®ä¿ä¾§è¾¹æ å’Œä¸»å†…å®¹åŒºåœ¨æœ‰å£çº¸æ—¶ä¿æŒé€‚åº¦ä¸é€æ˜ä»¥ç¡®ä¿æ–‡å­—æ¸…æ™° */
                    body.has-wallpaper .sidebar {
                        background: rgba(37, 41, 50, 0.85) !important;
                        backdrop-filter: blur(10px) !important;
                    }
                    
                    body.has-wallpaper .main-content {
                        background: rgba(26, 29, 35, 0.85) !important;
                        backdrop-filter: blur(10px) !important;
                    }
                    
                    html:not(.dark) body.has-wallpaper .sidebar {
                        background: rgba(237, 242, 247, 0.92) !important;
                    }
                    
                    html:not(.dark) body.has-wallpaper .main-content {
                        background: rgba(247, 250, 252, 0.92) !important;
                    }
                    
                    /* æœ‰å£çº¸æ—¶ï¼Œè¾“å…¥åŒºåŸŸä¹Ÿä½¿ç”¨é€‚åº¦ä¸é€æ˜ä»¥ç¡®ä¿æ–‡å­—æ¸…æ™° */
                    body.has-wallpaper .input-area {
                        background: rgba(37, 41, 50, 0.85) !important;
                        backdrop-filter: blur(10px) !important;
                        border-top: 1px solid rgba(74, 85, 104, 0.5) !important;
                    }
                    
                    body.has-wallpaper .input-container {
                        background: rgba(50, 58, 70, 0.9) !important;
                        backdrop-filter: blur(5px) !important;
                        border: 1px solid rgba(58, 69, 83, 0.6) !important;
                    }
                    
                    html:not(.dark) body.has-wallpaper .input-area {
                        background: rgba(237, 242, 247, 0.92) !important;
                        border-top: 1px solid rgba(203, 213, 224, 0.5) !important;
                    }
                    
                    html:not(.dark) body.has-wallpaper .input-container {
                        background: rgba(255, 255, 255, 0.95) !important;
                        border: 1px solid rgba(226, 232, 240, 0.6) !important;
                    }
                `;
                document.head.appendChild(style);
                
                // å¼ºåˆ¶é‡æ–°æ¸²æŸ“å’ŒéªŒè¯
                requestAnimationFrame(() => {
                    // è§¦å‘é‡æ’ä»¥ç¡®ä¿æ ·å¼åº”ç”¨
                    void document.body.offsetHeight;
                    void document.documentElement.offsetHeight;
                    
                    // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ ·å¼å®Œå…¨åº”ç”¨
                    setTimeout(() => {
                        const testStyle = window.getComputedStyle(document.body, '::before');
                        const bgImgValue = testStyle.backgroundImage;
                        const opacityValue = testStyle.opacity;
                        const displayValue = testStyle.display;
                        const zIndexValue = testStyle.zIndex;
                        
                        console.log('[å£çº¸] åº”ç”¨å®Œæˆï¼Œé•¿åº¦:', bgImage.length);
                        console.log('[å£çº¸] computed background-image:', bgImgValue ? bgImgValue.substring(0, 100) : 'none');
                        console.log('[å£çº¸] computed opacity:', opacityValue);
                        console.log('[å£çº¸] computed display:', displayValue);
                        console.log('[å£çº¸] computed z-index:', zIndexValue);
                        console.log('[å£çº¸] html.has-wallpaper:', document.documentElement.classList.contains('has-wallpaper'));
                        console.log('[å£çº¸] body.has-wallpaper:', document.body.classList.contains('has-wallpaper'));
                        console.log('[å£çº¸] å åŠ å±‚é¢œè‰²:', overlayColor);
                        console.log('[å£çº¸] äº®åº¦:', brightness + '%, æ¨¡ç³Š:', blur + 'px');
                        
                        if (bgImgValue && bgImgValue !== 'none' && bgImgValue.includes('url')) {
                            console.log('âœ“ èƒŒæ™¯å›¾ç‰‡å·²æˆåŠŸåº”ç”¨åˆ° body::before');
                            
                            // éªŒè¯ä¾§è¾¹æ å’Œä¸»å†…å®¹åŒºçš„é€æ˜åº¦
                            const sidebarEl = document.querySelector('.sidebar');
                            const mainContentEl = document.querySelector('.main-content');
                            if (sidebarEl) {
                                const sidebarStyle = window.getComputedStyle(sidebarEl);
                                console.log('[å£çº¸] ä¾§è¾¹æ èƒŒæ™¯:', sidebarStyle.background);
                            }
                            if (mainContentEl) {
                                const mainStyle = window.getComputedStyle(mainContentEl);
                                console.log('[å£çº¸] ä¸»å†…å®¹åŒºèƒŒæ™¯:', mainStyle.background);
                            }
                        } else {
                            console.error('âŒ èƒŒæ™¯å›¾ç‰‡æœªæ­£ç¡®åº”ç”¨ï¼computed:', bgImgValue);
                            console.error('[å£çº¸] è¯·æ£€æŸ¥CSSé€‰æ‹©å™¨æ˜¯å¦æ­£ç¡®åŒ¹é…');
                            
                            // å°è¯•å¼ºåˆ¶åˆ·æ–°
                            document.body.style.display = 'none';
                            void document.body.offsetHeight;
                            document.body.style.display = '';
                        }
                    }, 100);
                });
            } else {
                // æ¸…é™¤èƒŒæ™¯å›¾ç‰‡
                document.documentElement.classList.remove('has-wallpaper');
                document.body.classList.remove('has-wallpaper');
                
                style.textContent = `
                    body::before {
                        background-image: none !important;
                        filter: none !important;
                    }
                    body::after {
                        background: transparent !important;
                    }
                `;
                document.head.appendChild(style);
                console.log('[å£çº¸] å£çº¸å·²æ¸…é™¤');
            }
            
            // ç¡®ä¿æˆ‘ä»¬çš„å‡½æ•°è¦†ç›–script.jsä¸­çš„å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (typeof window !== 'undefined') {
                window.applyBgImage = applyBgImage;
            }
        }
        
        // ä¸Šä¼ å£çº¸ - ä½¿ç”¨æ›´å®‰å…¨çš„äº‹ä»¶ç»‘å®šæ–¹å¼ï¼Œç¡®ä¿ä¸è¢«script.jsè¦†ç›–
        function setupWallpaperUpload() {
            const uploadBtn = document.getElementById('wallpaper-upload-btn');
            const uploadInput = document.getElementById('wallpaper-upload');
            
            if (!uploadBtn || !uploadInput) {
                console.warn('å£çº¸ä¸Šä¼ å…ƒç´ ä¸å­˜åœ¨ï¼Œå»¶è¿Ÿé‡è¯•...');
                setTimeout(setupWallpaperUpload, 500);
                return;
            }
            
            // å…ˆç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆåŒ…æ‹¬script.jsæ·»åŠ çš„ï¼‰
            uploadBtn.onclick = null;
            uploadInput.onchange = null;
            
            // ä½¿ç”¨ addEventListener å¹¶è®¾ç½®é«˜ä¼˜å…ˆçº§
            uploadBtn.addEventListener('click', function handleUploadClick(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('[å£çº¸] ç‚¹å‡»ä¸Šä¼ æŒ‰é’®');
                uploadInput.click();
            }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œä¼˜å…ˆçº§æ›´é«˜
            
            uploadInput.addEventListener('change', function handleUploadChange(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const file = e.target.files[0];
                if (!file) {
                    console.log('[å£çº¸] æœªé€‰æ‹©æ–‡ä»¶');
                    return;
                }

                console.log('[å£çº¸] é€‰æ‹©çš„æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'ç±»å‹:', file.type);

                const t_wall = i18n[window.currentLang || 'zh'] || i18n.zh;
                if (file.size > 4 * 1024 * 1024) {
                    setWallpaperStatus(t_wall.wallpaperSizeError, true);
                    e.target.value = '';
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    setWallpaperStatus('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', true);
                    e.target.value = '';
                    return;
                }

                setWallpaperStatus(t_wall.uploadingWallpaper);
                
                const reader = new FileReader();
                reader.onerror = (err) => {
                    console.error('[å£çº¸] æ–‡ä»¶è¯»å–é”™è¯¯:', err);
                    const t_wall_err = i18n[window.currentLang || 'zh'] || i18n.zh;
                    setWallpaperStatus(t_wall_err.wallpaperFileError, true);
                };
                reader.onload = (ev) => {
                    try {
                        const imageData = ev.target.result;
                        console.log('[å£çº¸] å›¾ç‰‡æ•°æ®å·²è¯»å–ï¼Œé•¿åº¦:', imageData.length);
                        
                        // éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆçš„base64å›¾ç‰‡æ•°æ®
                        if (!imageData || !imageData.startsWith('data:image/')) {
                            throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ ¼å¼');
                        }
                        
                        S.set('bgImage', imageData);
                        console.log('[å£çº¸] å›¾ç‰‡å·²ä¿å­˜åˆ°localStorageï¼Œé”®: bgImage');
                        
                        // ç«‹å³åº”ç”¨èƒŒæ™¯
                        applyBgImage();
                        
                        // å†æ¬¡åº”ç”¨ä»¥ç¡®ä¿ç”Ÿæ•ˆï¼ˆå»¶è¿Ÿç¡®ä¿DOMæ›´æ–°ï¼‰
                        setTimeout(() => {
                            applyBgImage();
                        }, 200);
                        
                        const t_wall_ok = i18n[window.currentLang || 'zh'] || i18n.zh;
                        setWallpaperStatus(t_wall_ok.wallpaperUpdated);
                        console.log('[å£çº¸] å£çº¸åº”ç”¨å®Œæˆ');
                    } catch (err) {
                        console.error('[å£çº¸] ä¿å­˜å£çº¸å¤±è´¥', err);
                        const t_wall_err2 = i18n[window.currentLang || 'zh'] || i18n.zh;
                        setWallpaperStatus(t_wall_err2.wallpaperError + ': ' + err.message, true);
                    }
                };
                reader.readAsDataURL(file);
            }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œä¼˜å…ˆçº§æ›´é«˜
            
            console.log('[å£çº¸] å£çº¸ä¸Šä¼ äº‹ä»¶å·²ç»‘å®šï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰');
        }
        
        // å»¶è¿Ÿè®¾ç½®ï¼Œç¡®ä¿åœ¨script.jsä¹‹åæ‰§è¡Œ
        function initWallpaperUpload() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(setupWallpaperUpload, 1000); // å»¶è¿Ÿ1ç§’ï¼Œç¡®ä¿script.jså…ˆæ‰§è¡Œå®Œ
                });
            } else {
                setTimeout(setupWallpaperUpload, 1000); // å»¶è¿Ÿ1ç§’
            }
        }
        initWallpaperUpload();
        
        // é‡ç½®å£çº¸
        document.getElementById('reset-wallpaper-btn').onclick = () => {
            const t_wall_reset = i18n[window.currentLang || 'zh'] || i18n.zh;
            if (confirm(t_wall_reset.confirmResetWallpaper)) {
                S.set('bgImage', '');
                S.set('bgOpacity', '100');
                S.set('bgBrightness', '100');
                S.set('bgBlur', '0');
                document.getElementById('wallpaper-opacity').value = 100;
                document.getElementById('wallpaper-brightness').value = 100;
                document.getElementById('wallpaper-blur').value = 0;
                document.getElementById('wallpaper-opacity-label').textContent = '100%';
                document.getElementById('wallpaper-brightness-label').textContent = '100%';
                document.getElementById('wallpaper-blur-label').textContent = '0px';
                applyBgImage();
                setWallpaperStatus(t_wall_reset.wallpaperReset);
            }
        };
        
        // é€æ˜åº¦æ»‘å—
        const opacitySlider = document.getElementById('wallpaper-opacity');
        const opacityLabel = document.getElementById('wallpaper-opacity-label');
        opacitySlider.value = S.get('bgOpacity', '100');
        opacityLabel.textContent = opacitySlider.value + '%';
        
        opacitySlider.oninput = (e) => {
            const value = e.target.value;
            opacityLabel.textContent = value + '%';
            S.set('bgOpacity', value);
            applyBgImage();
        };
        
        // äº®åº¦æ»‘å—
        const brightnessSlider = document.getElementById('wallpaper-brightness');
        const brightnessLabel = document.getElementById('wallpaper-brightness-label');
        brightnessSlider.value = S.get('bgBrightness', '100');
        brightnessLabel.textContent = brightnessSlider.value + '%';
        
        brightnessSlider.oninput = (e) => {
            const value = e.target.value;
            brightnessLabel.textContent = value + '%';
            S.set('bgBrightness', value);
            applyBgImage();
        };
        
        // æ¨¡ç³Šæ»‘å—
        const blurSlider = document.getElementById('wallpaper-blur');
        const blurLabel = document.getElementById('wallpaper-blur-label');
        blurSlider.value = S.get('bgBlur', '0');
        blurLabel.textContent = blurSlider.value + 'px';
        
        blurSlider.oninput = (e) => {
            const value = e.target.value;
            blurLabel.textContent = value + 'px';
            S.set('bgBlur', value);
            applyBgImage();
        };
        
        // åˆå§‹åŒ–å£çº¸ - å»¶è¿Ÿæ‰§è¡Œç¡®ä¿åœ¨script.jsä¹‹å
        setTimeout(() => {
            applyBgImage();
            const t_wall_init = i18n[window.currentLang || 'zh'] || i18n.zh;
            setWallpaperStatus(S.get('bgImage') ? t_wall_init.wallpaperSaved : t_wall_init.wallpaperDefault);
        }, 1500);
        // ==================== å£çº¸åŠŸèƒ½ç»“æŸ ====================
        
        // åˆå§‹åŒ–åŠ è½½
        loadProviders();
        loadPrompts();
    </script>
</body>
</html>