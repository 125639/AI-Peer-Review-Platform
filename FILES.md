# 项目文件说明文档

本文档详细列出了项目中所有文件的作用和功能。

## 📁 根目录文件

### `main.py`
**作用**: 应用主入口文件  
**功能**:
- FastAPI 应用初始化
- 配置 CORS 中间件
- 挂载静态文件目录
- 注册 API 路由
- 提供根路径 `/` 返回主页面
- 提供健康检查端点 `/health`
- 应用生命周期管理（启动/关闭）

### `requirements.txt`
**作用**: Python 依赖包列表  
**功能**:
- 定义项目运行所需的所有 Python 包及其版本
- 包括 FastAPI、uvicorn、OpenAI、Google Generative AI 等核心依赖

### `providers.db`
**作用**: SQLite 数据库文件  
**功能**:
- 存储 AI 服务商配置信息（名称、类型、API密钥、模型列表等）
- 存储提示词模板（中英文版本、评审提示词、修订提示词等）
- 数据库会在应用启动时自动初始化

---

## 📁 api/ - API 路由层

### `api/__init__.py`
**作用**: API 模块初始化文件  
**功能**:
- 导出 API 路由模块
- 模块包的标识文件

### `api/router.py`
**作用**: API 路由定义文件  
**功能**:
- 定义所有 API 端点：
  - `/api/health` - 健康检查
  - `/api/process` - 处理用户查询（流式响应）
  - `/api/providers` - 服务商管理（获取、添加、更新、删除）
  - `/api/prompts` - 提示词管理（获取、添加、更新、删除、激活）
  - `/api/ocr` - 图片 OCR 识别
  - `/api/search` - 网络搜索（SearXNG）
  - `/api/search/ai-summary` - 带 AI 摘要的搜索
- 定义请求/响应模型
- 处理文件上传（OCR）
- 流式响应处理

---

## 📁 core/ - 核心业务逻辑层

### `core/__init__.py`
**作用**: 核心模块初始化文件  
**功能**:
- 模块包的标识文件

### `core/config.py`
**作用**: 配置管理系统  
**功能**:
- 集中管理应用配置（服务器、代理等）
- 从环境变量读取配置
- 提供默认配置值
- 配置类：`ServerConfig`、`ProxyConfig`、`AppConfig`

### `core/logging.py`
**作用**: 统一日志系统  
**功能**:
- 配置统一的日志格式
- 提供 `get_logger()` 函数获取日志记录器
- 单例模式确保日志配置一致性
- 日志输出到标准输出

### `core/exceptions.py`
**作用**: 异常层次结构定义  
**功能**:
- 定义应用异常基类 `AppError`
- 定义特定异常类型：
  - `ModelError` - 模型相关错误
  - `DatabaseError` - 数据库相关错误
  - `ProviderNotFoundError` - 服务商未找到
  - `ProviderExistsError` - 服务商已存在
- 统一异常格式（消息和错误代码）

### `core/database.py`
**作用**: 数据库操作模块  
**功能**:
- SQLite 数据库连接管理
- 数据库初始化（创建表结构）
- 服务商数据操作（增删改查）
- 提示词数据操作（增删改查、激活）
- 插入默认提示词模板

### `core/models.py`
**作用**: AI 模型抽象层  
**功能**:
- 定义 `BaseModel` 抽象基类
- 实现 `OpenAIModel`（OpenAI 兼容模型）
- 实现 `GeminiModel`（Google Gemini 模型）
- 提供模型工厂函数 `create_model_instance()`
- 统一模型接口（generate、generate_stream）
- 支持工具调用（MCP 协议）

### `core/orchestrator.py`
**作用**: AI 互评编排器  
**功能**:
- 协调多个 AI 模型进行互评
- 流式处理查询流程：
  1. 初始化模型
  2. 生成初始答案
  3. 执行互评（多模型互相评审）
  4. 解析评审结果（分数、评语）
  5. 生成修正后的答案
  6. 计算最终得分
- 过滤和处理无效评审
- 错误处理和重试机制

### `core/searxng.py`
**作用**: SearXNG 搜索引擎集成  
**功能**:
- 提供隐私友好的元搜索功能
- 支持多种搜索引擎聚合
- 支持分类、时间范围、语言等搜索参数
- 提供搜索结果格式化
- 支持代理配置（HTTP/SOCKS5）

### `core/searxng_search.py`
**作用**: SearXNG 搜索功能扩展（备用/实验性）  
**功能**:
- 扩展搜索功能
- 可能包含搜索相关的辅助函数
- **注意**: 当前主要使用 `searxng.py`，此文件可能为备用实现

### `core/prompt_manager.py`
**作用**: 提示词管理系统  
**功能**:
- 提示词模板管理
- 支持中英文模板
- 提示词格式化（占位符替换）
- 模板分类和版本控制

### `core/image_generator.py`
**作用**: 图像生成提示词优化系统  
**功能**:
- 为不同图像生成模型优化提示词
- 抽象基类 `BaseImagePromptOptimizer`
- 实现特定模型的优化器（如 OpenAI DALL-E）
- 支持风格模板和提示词增强

### `core/proxy_support.py`
**作用**: 代理支持模块  
**功能**:
- 统一处理 HTTP/SOCKS 代理配置
- 从环境变量读取代理设置
- 为 API 请求提供代理支持

### `core/new_config.py`
**作用**: 新配置系统（未完成/备用配置）  
**功能**:
- 配置系统的重构版本（未完成）
- 使用 dataclass 定义配置
- 从环境变量读取配置
- **注意**: 当前主要使用 `config.py`，此文件为未完成的实验性代码

---

## 📁 static/ - 前端静态资源

### `static/index.html`
**作用**: 主页面 HTML 文件  
**功能**:
- 应用的前端界面结构
- 包含完整的 UI 布局（侧边栏、主内容区、输入区域）
- 内置 CSS 样式（深色/浅色主题）
- 集成所有 JavaScript 模块
- 包含设置面板、模型管理、提示词管理等界面
- 支持国际化（中英文切换）
- 支持壁纸功能
- 包含大量内联 JavaScript 代码（DOM 操作、事件处理等）

### `static/script.js`
**作用**: 核心 JavaScript 逻辑  
**功能**:
- 应用的核心业务逻辑：
  - 服务商管理（添加、编辑、删除）
  - 提示词管理（查看、编辑、删除、激活）
  - 模型选择和管理
  - 聊天消息处理
  - 流式响应处理
  - OCR 图片识别集成
  - 标签页切换
  - 主题切换（深色/浅色）
  - 侧边栏折叠/展开
  - 新对话功能
  - 详情模态框
- 日志系统
- 通知系统
- 错误处理

### `static/i18n.js`
**作用**: 国际化模块  
**功能**:
- 多语言字典（中文、英文）
- 提供 `getI18n()` 函数获取翻译文本
- 提供 `setLang()` 函数切换语言
- 管理当前语言状态
- 刷新所有国际化元素

### `static/wallpaper.js`
**作用**: 壁纸功能模块  
**功能**:
- 壁纸上传功能
- 壁纸应用和显示
- 透明度调整
- 亮度调整
- 重置壁纸功能
- 动态样式注入
- 毛玻璃效果管理

### `static/history.js`
**作用**: 历史记录模块  
**功能**:
- 聊天历史记录的保存
- 聊天历史记录的加载
- 历史记录显示
- 历史记录恢复功能
- 历史记录管理（删除、清空）

### `static/search.js`
**作用**: 搜索功能模块  
**功能**:
- SearXNG 搜索集成
- 搜索请求处理
- 搜索结果展示
- 搜索分页
- 搜索错误处理

---

## 📄 文档文件

### `README.md`
**作用**: 项目说明文档  
**功能**:
- 项目介绍
- 功能特性说明
- 项目结构说明
- 配置选项说明
- 快速开始指南
- 架构优化说明

### `ARCHITECTURE.md`
**作用**: 架构设计文档  
**功能**:
- 系统架构说明
- 模块职责划分
- 设计原则和理念
- 技术选型说明

### `CLAUDE.md`
**作用**: Claude AI 开发指南  
**功能**:
- 为 AI 助手提供项目上下文
- 常用命令说明
- 架构概览
- 配置说明
- 下一步计划

### `FILES.md`（本文件）
**作用**: 项目文件说明文档  
**功能**:
- 列出所有文件及其作用
- 帮助开发者快速了解项目结构
- 便于维护和代码审查

---

## 🔍 文件关系图

```
main.py
├── api/router.py          # API 路由处理
│   ├── core/orchestrator.py    # 调用编排器
│   ├── core/database.py        # 数据库操作
│   └── core/searxng.py         # 搜索功能
│
├── core/
│   ├── config.py         # 配置管理
│   ├── logging.py        # 日志系统
│   ├── exceptions.py     # 异常定义
│   ├── database.py       # 数据库操作
│   ├── models.py         # AI 模型抽象
│   ├── orchestrator.py   # 互评编排
│   ├── searxng.py        # 搜索引擎
│   ├── prompt_manager.py # 提示词管理
│   ├── image_generator.py # 图像生成
│   └── proxy_support.py  # 代理支持
│
└── static/
    ├── index.html        # 主页面
    ├── script.js         # 核心逻辑
    ├── i18n.js          # 国际化
    ├── wallpaper.js      # 壁纸功能
    ├── history.js        # 历史记录
    └── search.js         # 搜索功能
```

---

## 📝 注意事项

1. **数据库文件**: `providers.db` 会在首次运行时自动创建
2. **配置优先级**: 环境变量 > 默认配置
3. **模块化设计**: 前端 JavaScript 按功能拆分为独立模块
4. **API 路由**: 所有 API 端点统一使用 `/api` 前缀
5. **静态资源**: 所有前端资源位于 `static/` 目录，通过 `/static/` 路径访问

---

**最后更新**: 2025-11-04  
**版本**: 2.0.0

