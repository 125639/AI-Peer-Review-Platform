<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标签页诊断工具</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        #log {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .tab-btn {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #333;
            border: 2px solid #666;
            color: white;
        }
        .tab-btn.active {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
        }
        .tab-content {
            display: none;
            background: #2a2a2a;
            padding: 20px;
            border: 2px solid #00ff00;
            border-radius: 4px;
            min-height: 200px;
        }
        .tab-content.active {
            display: block !important;
        }
    </style>
</head>
<body>
    <h1>🔍 标签页系统诊断工具</h1>
    
    <div class="section">
        <h2>1. 缓存检测</h2>
        <div id="cache-check"></div>
        <button onclick="checkCache()">检查缓存状态</button>
        <button onclick="location.reload(true)">硬刷新页面</button>
    </div>
    
    <div class="section">
        <h2>2. 测试标签页</h2>
        <div>
            <button class="tab-btn active" data-tab="tab1">标签 1</button>
            <button class="tab-btn" data-tab="tab2">标签 2</button>
            <button class="tab-btn" data-tab="tab3">标签 3</button>
        </div>
        <div style="margin-top: 10px;">
            <div id="tab1" class="tab-content active">
                <h3 class="success">✅ 标签页 1 内容</h3>
                <p>如果你能看到这个，说明标签页 1 显示正常！</p>
            </div>
            <div id="tab2" class="tab-content">
                <h3 class="success">✅ 标签页 2 内容</h3>
                <p>如果你能看到这个，说明标签页切换成功了！</p>
            </div>
            <div id="tab3" class="tab-content">
                <h3 class="success">✅ 标签页 3 内容</h3>
                <p>完美！标签页系统工作正常！</p>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>3. DOM 检测</h2>
        <button onclick="checkDOM()">检测页面元素</button>
        <div id="dom-check"></div>
    </div>
    
    <div class="section">
        <h2>4. 实时日志</h2>
        <button onclick="clearLog()">清除日志</button>
        <div id="log"></div>
    </div>
    
    <div class="section">
        <h2>5. 主应用测试</h2>
        <button onclick="testMainApp()">测试主应用</button>
        <button onclick="window.open('/', '_blank')">打开主应用</button>
        <div id="main-app-test"></div>
    </div>

    <script>
        // 日志系统
        const logDiv = document.getElementById('log');
        function log(message, type = 'info') {
            const colors = {
                info: '#00ff00',
                error: '#ff0000',
                warning: '#ffaa00'
            };
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.style.color = colors[type] || '#00ff00';
            line.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
            log('日志已清除');
        }
        
        // 标签页切换逻辑
        log('初始化标签页系统...');
        const tabButtons = document.querySelectorAll('.tab-btn');
        log(`找到 ${tabButtons.length} 个标签按钮`);
        
        tabButtons.forEach((btn, index) => {
            log(`注册按钮 ${index + 1}: ${btn.dataset.tab}`);
            btn.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                log(`🖱️ 点击标签: ${targetTab}`, 'warning');
                
                // 移除所有按钮的激活状态
                tabButtons.forEach(b => {
                    b.classList.remove('active');
                    log(`  移除 ${b.dataset.tab} 的 active 类`);
                });
                this.classList.add('active');
                log(`  添加 ${targetTab} 的 active 类`, 'info');
                
                // 隐藏所有标签页
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    log(`  隐藏 ${content.id}`);
                });
                
                // 显示目标标签页
                const target = document.getElementById(targetTab);
                if (target) {
                    target.classList.add('active');
                    const display = window.getComputedStyle(target).display;
                    log(`✅ 显示 ${targetTab}, display: ${display}`, 'info');
                } else {
                    log(`❌ 找不到元素: ${targetTab}`, 'error');
                }
            });
        });
        
        log('✅ 标签页系统初始化完成');
        
        // 缓存检测
        function checkCache() {
            const div = document.getElementById('cache-check');
            const now = new Date().getTime();
            const randomParam = Math.random();
            
            div.innerHTML = `
                <div class="success">当前时间戳: ${now}</div>
                <div class="warning">随机数: ${randomParam}</div>
                <div>如果每次点击显示不同的随机数，说明没有缓存问题</div>
                <div style="margin-top: 10px;">
                    <strong>建议操作:</strong><br>
                    1. 按 Ctrl+Shift+Delete 清除浏览器缓存<br>
                    2. 或者按 Ctrl+Shift+R 强制刷新<br>
                    3. 或者关闭所有浏览器窗口后重新打开
                </div>
            `;
            log(`缓存检测: ${randomParam}`);
        }
        
        // DOM 检测
        function checkDOM() {
            const div = document.getElementById('dom-check');
            let html = '<div style="margin-top: 10px;">';
            
            // 检查主应用的元素
            const checks = [
                { selector: '.tab-btn', desc: '标签按钮' },
                { selector: '.tab-content', desc: '标签内容' },
                { selector: '[data-tab="models"]', desc: '模型配置按钮' },
                { selector: '[data-tab="prompts"]', desc: '提示词管理按钮' },
                { selector: '#models-tab', desc: '模型标签页' },
                { selector: '#prompts-tab', desc: '提示词标签页' }
            ];
            
            checks.forEach(check => {
                const elements = document.querySelectorAll(check.selector);
                const found = elements.length > 0;
                const status = found ? '✅' : '❌';
                const color = found ? 'success' : 'error';
                html += `<div class="${color}">${status} ${check.desc}: ${elements.length} 个</div>`;
                log(`${status} ${check.desc}: ${elements.length}`);
            });
            
            html += '</div>';
            div.innerHTML = html;
        }
        
        // 测试主应用
        async function testMainApp() {
            const div = document.getElementById('main-app-test');
            log('开始测试主应用...', 'warning');
            
            try {
                const response = await fetch('/static/script.js');
                const text = await response.text();
                
                // 检查版本号
                const versionMatch = text.match(/Version:\s*([\d.]+)/);
                const version = versionMatch ? versionMatch[1] : '未找到';
                
                // 检查是否包含标签页代码
                const hasTabCode = text.includes('标签页切换');
                const hasPromptCode = text.includes('提示词管理功能');
                
                let html = '<div style="margin-top: 10px;">';
                html += `<div class="${version >= '17.0.0' ? 'success' : 'error'}">脚本版本: ${version}</div>`;
                html += `<div class="${hasTabCode ? 'success' : 'error'}">${hasTabCode ? '✅' : '❌'} 包含标签页切换代码</div>`;
                html += `<div class="${hasPromptCode ? 'success' : 'error'}">${hasPromptCode ? '✅' : '❌'} 包含提示词管理代码</div>`;
                html += `<div class="warning">脚本大小: ${(text.length / 1024).toFixed(2)} KB</div>`;
                
                if (version < '17.0.0' || !hasTabCode) {
                    html += '<div class="error" style="margin-top: 10px;">⚠️ 检测到旧版本！请:</div>';
                    html += '<div class="error">1. 完全关闭浏览器</div>';
                    html += '<div class="error">2. 删除浏览器缓存</div>';
                    html += '<div class="error">3. 重新打开浏览器并访问</div>';
                }
                
                html += '</div>';
                div.innerHTML = html;
                
                log(`主应用版本: ${version}`);
                log(`标签页代码: ${hasTabCode ? '存在' : '缺失'}`);
                log(`提示词代码: ${hasPromptCode ? '存在' : '缺失'}`);
                
            } catch (error) {
                div.innerHTML = `<div class="error">测试失败: ${error.message}</div>`;
                log(`测试主应用失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动检测
        window.addEventListener('load', () => {
            log('===== 页面加载完成 =====', 'warning');
            setTimeout(() => {
                checkDOM();
                checkCache();
            }, 500);
        });
    </script>
</body>
</html>
